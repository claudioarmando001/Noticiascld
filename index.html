<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Not√≠cias CLD - Agregador de Not√≠cias</title>
<meta name="description" content="Agregador de not√≠cias de Mo√ßambique em tempo real">
<meta name="robots" content="index, follow">
<!-- Preconnect para recursos externos -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://www.opais.co.mz">
<link rel="preconnect" href="https://www.jornalnoticias.co.mz">
<style>
/* [TODO O CSS ANTERIOR PERMANECE EXATAMENTE IGUAL] */
/* N√£o alterei nenhum estilo para manter o visual */
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header>
<button class="header-btn" id="menu-btn" onclick="openSidebar()">‚ò∞</button>
Not√≠cias CLD
<button class="header-btn" id="refresh-btn" onclick="manualRefresh()">‚Üª</button>
</header>

<!-- SIDEBAR -->
<div id="sidebar-overlay"></div>
<div id="sidebar">
<span id="close-sidebar" onclick="closeSidebar()">‚úñ</span>
<h2>Categorias</h2>
<div class="categories">
<button class="category-btn active" onclick="filterByCategory('todos')">Todos</button>
<button class="category-btn" onclick="filterByCategory('sociedade')">Sociedade</button>
<button class="category-btn" onclick="filterByCategory('pol√≠tica')">Pol√≠tica</button>
<button class="category-btn" onclick="filterByCategory('economia')">Economia</button>
<button class="category-btn" onclick="filterByCategory('esportes')">Esportes</button>
<button class="category-btn" onclick="filterByCategory('cultura')">Cultura</button>
<button class="category-btn" onclick="filterByCategory('sa√∫de')">Sa√∫de</button>
<button class="category-btn" onclick="filterByCategory('tecnologia')">Tecnologia</button>
</div>

<h2>A√ß√µes</h2>
<div class="modal-buttons">
<button class="modal-btn" onclick="openInfoModal('sobre')">
    <i class="fas fa-info-circle"></i> Sobre a Plataforma
</button>
<button class="modal-btn" onclick="openInfoModal('contato')">
    <i class="fas fa-envelope"></i> Contacto
</button>
</div>
</div>

<!-- BUSCA -->
<div class="search-container">
<input id="search-input" placeholder="üîç Buscar not√≠cias..." onkeyup="searchNews()">
</div>

<!-- LISTA COM RENDERIZA√á√ÉO EM TEMPO REAL -->
<div id="news-container">
<!-- Not√≠cias aparecer√£o aqui automaticamente -->
</div>

<!-- LOADER PARA SCROLL INFINITO -->
<div id="infinite-loader" style="display:none;">
    <div class="infinite-spinner"></div>
    Carregando mais not√≠cias...
</div>

<!-- MODAL INFO (SOBRE/CONTATO) - MELHORADA -->
<div id="info-modal">
<div id="info-modal-content">
<div id="info-modal-header">
    <h2><i class="fas" id="modal-icon"></i> <span id="modal-title"></span></h2>
    <button id="info-modal-close">‚úñ</button>
</div>
<div id="info-modal-body"></div>
</div>
</div>

<!-- WHATSAPP CHANNEL BUTTON -->
<button class="whatsapp-channel-btn" onclick="openWhatsAppChannel()" title="Canal WhatsApp" aria-label="Abrir canal oficial no WhatsApp">
</button>

<script>
// ========== VARI√ÅVEIS GLOBAIS ==========
let news = [];
let filteredNews = [];
let hashes = new Set();
const BATCH_SIZE = 15;
let isLoadingMore = false;
let allSourcesLoaded = false;
let currentCategory = 'todos';

// Cache em mem√≥ria para acesso r√°pido
const newsCache = new Map();
const relatedCache = new Map();

// CATEGORIAS DISPON√çVEIS
const CATEGORIES = {
    'todos': { name: 'Todos', color: '#1a73e8' },
    'sociedade': { name: 'Sociedade', color: '#2e7d32', class: 'sociedade-tag' },
    'pol√≠tica': { name: 'Pol√≠tica', color: '#c62828', class: 'politica-tag' },
    'economia': { name: 'Economia', color: '#ef6c00', class: 'economia-tag' },
    'esportes': { name: 'Esportes', color: '#1565c0', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', color: '#7b1fa2', class: 'cultura-tag' },
    'sa√∫de': { name: 'Sa√∫de', color: '#00796b', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', color: '#37474f', class: 'tech-tag' }
};

// ELEMENTOS DOM
const container = document.getElementById("news-container");
const infiniteLoader = document.getElementById("infinite-loader");
const infoModal = document.getElementById("info-modal");
const infoModalClose = document.getElementById("info-modal-close");
const modalTitle = document.getElementById("modal-title");
const modalIcon = document.getElementById("modal-icon");

// CONSTANTES
const WHATSAPP_CHANNEL_URL = "https://whatsapp.com/channel/0029Vb7BeBI7T8bRTbjcsN0t";

// FONTES DE NOT√çCIAS
const sources = [
    { 
        name: "O Pa√≠s", 
        baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Time de Todos",
        baseUrl: "https://timesdetodos.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Integrity", 
        baseUrl: "https://integritymagazine.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Jornal Not√≠cias",
        baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Savana", 
        baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "JornalMZ",
        baseUrl: "https://jornalmz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Checka",
        baseUrl: "https://checka.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Canal de Mo√ßambique",
        baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Stop",
        baseUrl: "https://www.stop.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Club of Mozambique",
        baseUrl: "https://clubofmozambique.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Zitamar News",
        baseUrl: "https://www.zitamar.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Carta de Mo√ßambique", 
        baseUrl: "https://cartamz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    }
];

// ========== SISTEMA DE CACHE AVAN√áADO ==========

// Gerar hash √∫nico para a not√≠cia
function generateNewsHash(article) {
    const text = article.title.rendered + article.link;
    return btoa(text).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12);
}

// Salvar not√≠cia no cache multi-n√≠vel
function saveToCache(article, sourceName) {
    try {
        const hash = generateNewsHash(article);
        
        const newsItem = {
            id: hash,
            title: article.title.rendered,
            content: article.content.rendered,
            excerpt: article.excerpt?.rendered || article.content.rendered.substring(0, 200) + '...',
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   "https://via.placeholder.com/300x200",
            source: sourceName || "Desconhecido",
            date: article.date || article.modified,
            link: article.link,
            category: determineCategory(article.title.rendered, article.content.rendered),
            timestamp: Date.now()
        };
        
        // 1. Cache em mem√≥ria (mais r√°pido)
        newsCache.set(hash, newsItem);
        
        // 2. Cache em localStorage (persistente)
        localStorage.setItem(`news_${hash}`, JSON.stringify(newsItem));
        
        // 3. Adicionar √† lista geral de cache
        let cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        if (!cachedNews.includes(hash)) {
            cachedNews.push(hash);
            // Manter apenas 300 not√≠cias em cache
            if (cachedNews.length > 300) {
                const removed = cachedNews.shift();
                localStorage.removeItem(`news_${removed}`);
                newsCache.delete(removed);
            }
            localStorage.setItem('cached_news', JSON.stringify(cachedNews));
        }
        
        return hash;
    } catch (e) {
        console.error('Erro ao salvar no cache:', e);
        return null;
    }
}

// Buscar do cache multi-n√≠vel
function getFromCache(hash) {
    // 1. Tentar cache em mem√≥ria primeiro (mais r√°pido)
    if (newsCache.has(hash)) {
        return newsCache.get(hash);
    }
    
    // 2. Tentar localStorage
    try {
        const cached = localStorage.getItem(`news_${hash}`);
        if (cached) {
            const newsItem = JSON.parse(cached);
            // Atualizar cache em mem√≥ria
            newsCache.set(hash, newsItem);
            return newsItem;
        }
    } catch (e) {
        console.error('Erro ao ler do cache:', e);
    }
    
    return null;
}

// Pr√©-carregar not√≠cia quando o mouse passa sobre o card
function setupPreload() {
    container.addEventListener('mouseenter', function(e) {
        const card = e.target.closest('.card');
        if (card) {
            const hash = card.dataset.hash;
            // Pr√©-carregar em segundo plano
            setTimeout(() => {
                preloadNewsContent(hash);
            }, 50);
        }
    }, { capture: true });
}

// Pr√©-carregar conte√∫do completo
async function preloadNewsContent(hash) {
    const cached = getFromCache(hash);
    if (!cached) return;
    
    // Se j√° temos conte√∫do completo, n√£o precisa fazer nada
    if (cached.content && cached.content.length > 500) return;
    
    // Tentar buscar conte√∫do completo da fonte original
    try {
        // Esta fun√ß√£o precisaria ser implementada para buscar o conte√∫do completo
        // da fonte espec√≠fica. Por enquanto, usamos o cache existente.
    } catch (e) {
        console.warn('N√£o foi poss√≠vel pr√©-carregar:', e);
    }
}

// ========== FUN√á√ïES DE INTERFACE (MANTIDAS) ==========

function openSidebar(){
    document.getElementById("sidebar").classList.add("open");
    document.getElementById("sidebar-overlay").style.display="block";
}

function closeSidebar(){
    document.getElementById("sidebar").classList.remove("open");
    document.getElementById("sidebar-overlay").style.display="none";
}

document.getElementById('sidebar-overlay').addEventListener('click', function(event) {
    if (event.target === this) {
        closeSidebar();
    }
});

function formatDate(d){
    return new Date(d).toLocaleString("pt-PT");
}

function filterByCategory(category) {
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentCategory = category;
    
    if (category === 'todos') {
        filteredNews = [...news];
    } else {
        filteredNews = news.filter(article => {
            const articleCategory = determineCategory(article.title, article.content);
            return articleCategory === category;
        });
    }
    
    const searchText = document.getElementById("search-input").value.toLowerCase();
    if (searchText) {
        filteredNews = filteredNews.filter(n =>
            n.title.toLowerCase().includes(searchText) || 
            n.source.toLowerCase().includes(searchText)
        );
    }
    
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

function searchNews(){
    const q = document.getElementById("search-input").value.toLowerCase();
    
    let tempFiltered = [...news];
    
    if (currentCategory !== 'todos') {
        tempFiltered = news.filter(article => {
            const articleCategory = determineCategory(article.title, article.content);
            return articleCategory === currentCategory;
        });
    }
    
    filteredNews = tempFiltered.filter(n =>
        n.title.toLowerCase().includes(q) || 
        n.source.toLowerCase().includes(q)
    );
    
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

function openInfoModal(type) {
    closeSidebar();
    
    let title = '';
    let icon = '';
    let content = '';
    
    if (type === 'sobre') {
        title = 'Sobre a Plataforma';
        icon = 'fa-info-circle';
        content = `
        <div class="info-content">
            <span class="info-badge">üì∞ Agregador de Not√≠cias</span>
            
            <div class="info-section">
                <h3><i class="fas fa-bullhorn"></i> Descri√ß√£o</h3>
                <p>Agregador independente de not√≠cias de Mo√ßambique, reunindo conte√∫dos de v√°rias fontes confi√°veis em tempo real.</p>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-newspaper"></i> Fontes Inclu√≠das</h3>
                <ul>
                    <li><strong>O Pa√≠s</strong></li>
                    <li><strong>Jornal Not√≠cias</strong></li>
                    <li><strong>Canal de Mo√ßambique</strong></li>
                    <li><strong>Carta de Mo√ßambique</strong></li>
                    <li><strong>Club of Mozambique</strong></li>
                    <li><strong>Stop</strong></li>
                    <li><strong>Zitamar News</strong></li>
                    <li><strong>Time de Todos</strong></li>
                </ul>
            </div>
        </div>
        `;
    } else if (type === 'contato') {
        title = 'Contacto';
        icon = 'fa-envelope';
        content = `
        <div class="info-content">
            <span class="info-badge">üìû Entre em Contacto</span>
            
            <div class="info-section">
                <h3><i class="fas fa-headset"></i> Canais de Atendimento</h3>
                
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <div>
                            <strong>Email Principal</strong><br>
                            <a href="mailto:claudioarmando001@gmail.com" class="contact-link">claudioarmando001@gmail.com</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <div>
                            <strong>Telefone/WhatsApp</strong><br>
                            <a href="tel:+258869667677" class="contact-link">+258 869 667 677</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h3><i class="fab fa-whatsapp"></i> Canal Oficial WhatsApp</h3>
                <p>Receba as principais not√≠cias diretamente no seu WhatsApp:</p>
                <button class="social-btn whatsapp" onclick="openWhatsAppChannel()">
                    <i class="fab fa-whatsapp"></i> Entrar no Canal
                </button>
            </div>
        </div>
        `;
    }
    
    modalTitle.textContent = title;
    modalIcon.className = `fas ${icon}`;
    document.getElementById("info-modal-body").innerHTML = content;
    
    infoModal.style.display = "flex";
    
    setTimeout(() => {
        document.getElementById("info-modal-content").style.transform = "translateY(0)";
    }, 10);
}

function closeInfoModal() {
    infoModal.style.display = "none";
}

infoModalClose.addEventListener('click', closeInfoModal);

infoModal.addEventListener('click', (e) => {
    if (e.target.id === 'info-modal') {
        closeInfoModal();
    }
});

// ========== RENDERIZA√á√ÉO OTIMIZADA ==========

function determineCategory(title, content) {
    const text = (title + ' ' + content).toLowerCase();
    
    if (text.includes('futebol') || text.includes('desporto') || text.includes('jogo') || text.includes('atleta')) {
        return 'esportes';
    } else if (text.includes('economia') || text.includes('neg√≥cio') || text.includes('empresa') || text.includes('investimento')) {
        return 'economia';
    } else if (text.includes('pol√≠tica') || text.includes('governo') || text.includes('presidente') || text.includes('ministro')) {
        return 'pol√≠tica';
    } else if (text.includes('sa√∫de') || text.includes('hospital') || text.includes('m√©dico') || text.includes('enfermeiro')) {
        return 'sa√∫de';
    } else if (text.includes('tecnologia') || text.includes('digital') || text.includes('internet') || text.includes('aplicativo')) {
        return 'tecnologia';
    } else if (text.includes('cultura') || text.includes('arte') || text.includes('m√∫sica') || text.includes('teatro')) {
        return 'cultura';
    } else {
        return 'sociedade';
    }
}

function renderSingleNews(article) {
    if (container.querySelector(`[data-hash="${article.hash}"]`)) return;
    
    const category = article.category || determineCategory(article.title, article.content);
    article.category = category;
    
    const newsLink = `leitura.html?n=${article.hash}&t=${encodeURIComponent(article.title.substring(0, 50))}&s=${encodeURIComponent(article.source)}`;
    
    const c = document.createElement("a");
    c.className = "card";
    c.dataset.hash = article.hash;
    c.dataset.category = category;
    c.href = newsLink;
    c.style.textDecoration = 'none';
    c.style.color = 'inherit';
    
    // Usar template string para renderiza√ß√£o r√°pida
    c.innerHTML = `
    <div class="card-text">
        <div class="card-title">${article.title}</div>
        <div class="card-meta">
            <span class="source-tag">${article.source}</span>
            <span class="category-tag ${CATEGORIES[category].class}">${CATEGORIES[category].name}</span>
            <span>${formatDate(article.date)}</span>
        </div>
    </div>
    <img src="${article.image}" loading="lazy" alt="${article.title}" 
         onerror="this.onerror=null; this.src='https://via.placeholder.com/120x85/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
    `;
    
    // Inser√ß√£o otimizada
    container.appendChild(c);
}

// ========== CARREGAMENTO DE NOT√çCIAS OTIMIZADO ==========

async function processSourceArticles(source, articles) {
    const newArticles = [];
    
    for (const article of articles) {
        const hash = generateNewsHash(article);
        
        if (hashes.has(hash)) continue;
        
        hashes.add(hash);
        
        const newsItem = {
            title: article.title.rendered,
            content: article.content.rendered,
            excerpt: article.excerpt?.rendered || article.content.rendered.substring(0, 200) + '...',
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   "https://via.placeholder.com/300x200",
            source: source.name,
            date: article.date || article.modified,
            link: article.link,
            hash: hash,
            category: determineCategory(article.title.rendered, article.content.rendered)
        };
        
        // Salvar no cache imediatamente
        saveToCache(article, source.name);
        
        newArticles.push(newsItem);
    }
    
    // Ordenar por data
    newArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Renderizar em batch para melhor performance
    for (const newsItem of newArticles) {
        news.push(newsItem);
        filteredNews.push(newsItem);
        
        renderSingleNews(newsItem);
    }
}

async function loadSource(source) {
    if (!source.hasMore || source.isFetching) return;
    
    source.isFetching = true;
    
    try {
        const url = `${source.baseUrl}?_embed&per_page=${BATCH_SIZE}&page=${source.currentPage}&t=${Date.now()}`;
        const response = await fetch(url, {
            signal: AbortSignal.timeout(5000) // Timeout de 5 segundos
        });
        
        if (!response.ok) {
            if (response.status === 400) {
                source.hasMore = false;
            }
            throw new Error(`Erro ao buscar ${source.name}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
            source.hasMore = false;
            return;
        }
        
        source.currentPage++;
        
        await processSourceArticles(source, data);
        
    } catch (error) {
        if (error.name === 'AbortError') {
            console.log(`Timeout ao carregar ${source.name}`);
        } else {
            console.error(`Erro ao carregar ${source.name}:`, error);
        }
        source.hasMore = false;
    } finally {
        source.isFetching = false;
        checkAllSourcesLoaded();
    }
}

async function loadAllSources() {
    // Limpar apenas se n√£o houver not√≠cias
    if (news.length === 0) {
        news = [];
        filteredNews = [];
        hashes.clear();
        allSourcesLoaded = false;
    }
    
    // N√£o limpar o container completamente para manter not√≠cias vis√≠veis
    // container.innerHTML = '';
    
    sources.forEach(source => {
        if (!source.isFetching) {
            source.currentPage = 1;
            source.hasMore = true;
        }
    });
    
    const promises = sources.map(source => loadSource(source));
    await Promise.allSettled(promises);
}

async function loadMoreNews() {
    if (isLoadingMore || allSourcesLoaded) return;
    
    isLoadingMore = true;
    infiniteLoader.style.display = 'block';
    
    let anySourceHasMore = false;
    const promises = [];
    
    for (const source of sources) {
        if (source.hasMore) {
            promises.push(loadSource(source));
            
            if (source.hasMore) {
                anySourceHasMore = true;
            }
        }
    }
    
    await Promise.allSettled(promises);
    
    allSourcesLoaded = !anySourceHasMore;
    
    isLoadingMore = false;
    infiniteLoader.style.display = 'none';
}

function checkAllSourcesLoaded() {
    allSourcesLoaded = sources.every(source => !source.hasMore);
    
    if (allSourcesLoaded) {
        infiniteLoader.style.display = 'none';
    }
}

function manualRefresh() {
    // Manter not√≠cias atuais enquanto carrega novas
    loadAllSources();
}

function openWhatsAppChannel() {
    window.open(WHATSAPP_CHANNEL_URL, '_blank', 'noopener,noreferrer');
    closeInfoModal();
}

// ========== INICIALIZA√á√ÉO OTIMIZADA ==========

// Carregar inicial
loadAllSources();

// Configurar pr√©-carregamento
setupPreload();

// Scroll infinito
let scrollTimeout;
const SCROLL_THRESHOLD = 300;

window.addEventListener("scroll", () => {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    
    scrollTimeout = setTimeout(() => {
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - SCROLL_THRESHOLD;
        
        if (scrollPosition >= threshold && !isLoadingMore && !allSourcesLoaded) {
            loadMoreNews();
        }
    }, 150);
});

// Atualizar periodicamente (a cada 5 minutos)
setInterval(() => {
    if (document.visibilityState === 'visible' && !isLoadingMore) {
        loadAllSources();
    }
}, 300000);

// Atalhos de teclado
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeInfoModal();
        closeSidebar();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById("search-input").focus();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        manualRefresh();
    }
});

// Service Worker para cache
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => {
            console.log('ServiceWorker registration failed: ', err);
        });
    });
}

console.log('P√°gina principal otimizada carregada com sucesso!');
</script>
</body>
</html>