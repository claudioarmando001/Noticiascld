<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notícias CLD - Agregador de Notícias</title>
<meta name="description" content="Agregador de notícias de Moçambique em tempo real">
<meta name="robots" content="index, follow">
<style>
/* [Todo o CSS anterior permanece igual] */
/* Adicione este novo estilo para erros */
.error-message {
    text-align: center;
    padding: 40px 20px;
    color: #666;
    background: #fff;
    border-radius: 12px;
    margin: 20px auto;
    max-width: 600px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.error-message i {
    font-size: 48px;
    color: #ff6b6b;
    margin-bottom: 20px;
}

.error-message h3 {
    color: #dc3545;
    margin-bottom: 15px;
}

.error-message a {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    background: #1a73e8;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
}

.error-message a:hover {
    background: #0d62d9;
}

/* Adicionar feedback de atualização */
.refresh-feedback {
    position: fixed;
    top: 80px;
    right: 20px;
    background: #4caf50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
    display: none;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<!-- [Todo o HTML anterior permanece igual] -->

<script>
// ========== VARIÁVEIS GLOBAIS ==========
let news = [];
let filteredNews = [];
let newsCache = new Map(); // Usar Map para cache mais rápido
const BATCH_SIZE = 15;
let isLoadingMore = false;
let allSourcesLoaded = false;
let currentCategory = 'todos';

// CATEGORIAS DISPONÍVEIS
const CATEGORIES = {
    'todos': { name: 'Todos', color: '#1a73e8' },
    'sociedade': { name: 'Sociedade', color: '#2e7d32', class: 'sociedade-tag' },
    'política': { name: 'Política', color: '#c62828', class: 'politica-tag' },
    'economia': { name: 'Economia', color: '#ef6c00', class: 'economia-tag' },
    'esportes': { name: 'Esportes', color: '#1565c0', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', color: '#7b1fa2', class: 'cultura-tag' },
    'saúde': { name: 'Saúde', color: '#00796b', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', color: '#37474f', class: 'tech-tag' }
};

// ELEMENTOS DOM
const container = document.getElementById("news-container");
const infiniteLoader = document.getElementById("infinite-loader");
const infoModal = document.getElementById("info-modal");
const infoModalClose = document.getElementById("info-modal-close");
const modalTitle = document.getElementById("modal-title");
const modalIcon = document.getElementById("modal-icon");

// CONSTANTES
const WHATSAPP_CHANNEL_URL = "https://whatsapp.com/channel/0029Vb7BeBI7T8bRTbjcsN0t";

// FONTES DE NOTÍCIAS (removi algumas que podem estar causando CORS)
const sources = [
    { 
        name: "O País", 
        baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Jornal Notícias",
        baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Carta de Moçambique", 
        baseUrl: "https://cartamz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Savana", 
        baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Club of Mozambique",
        baseUrl: "https://clubofmozambique.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    }
];

// ========== FUNÇÕES DE UTILIDADE ==========

// Gerar hash único para a notícia (mais robusto)
function generateNewsHash(article, sourceName) {
    const text = article.title.rendered + article.link + sourceName;
    let hash = 0;
    for (let i = 0; i < text.length; i++) {
        const char = text.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return Math.abs(hash).toString(36).substring(0, 12);
}

// Gerar link curto para a notícia
function generateShortLink(article) {
    const hash = article.hash;
    const titleSlug = article.title
        .toLowerCase()
        .replace(/[^\w\s]/g, '')
        .replace(/\s+/g, '-')
        .substring(0, 50);
    
    return `leitura.html?n=${hash}&t=${encodeURIComponent(titleSlug)}&s=${encodeURIComponent(article.source)}`;
}

// Salvar notícia no cache
function saveToCache(article) {
    try {
        const cacheKey = `news_${article.hash}`;
        const newsItem = {
            id: article.hash,
            title: article.title,
            content: article.content,
            image: article.image,
            source: article.source,
            date: article.date,
            link: article.link,
            hash: article.hash
        };
        
        // Salvar no localStorage
        localStorage.setItem(cacheKey, JSON.stringify(newsItem));
        
        // Salvar no Map para acesso rápido
        newsCache.set(article.hash, newsItem);
        
        // Adicionar à lista geral de notícias em cache
        let cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        if (!cachedNews.includes(article.hash)) {
            cachedNews.push(article.hash);
            // Manter apenas 300 notícias em cache
            if (cachedNews.length > 300) {
                const removed = cachedNews.shift();
                localStorage.removeItem(`news_${removed}`);
                newsCache.delete(removed);
            }
            localStorage.setItem('cached_news', JSON.stringify(cachedNews));
        }
        
        console.log('Notícia salva no cache:', article.hash, article.title.substring(0, 30));
        return article.hash;
    } catch (e) {
        console.error('Erro ao salvar no cache:', e);
        return null;
    }
}

// Carregar cache existente
function loadExistingCache() {
    try {
        const cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        cachedNews.forEach(hash => {
            try {
                const cachedItem = localStorage.getItem(`news_${hash}`);
                if (cachedItem) {
                    const article = JSON.parse(cachedItem);
                    newsCache.set(hash, article);
                }
            } catch (e) {
                console.warn('Erro ao carregar notícia do cache:', hash, e);
            }
        });
        console.log('Cache carregado:', newsCache.size, 'notícias');
    } catch (e) {
        console.error('Erro ao carregar cache:', e);
    }
}

// ========== FUNÇÕES DE INTERFACE ==========
// [Funções de interface permanecem iguais...]

// ========== RENDERIZAÇÃO ==========

function determineCategory(title, content) {
    const text = (title + ' ' + content).toLowerCase();
    
    if (text.includes('futebol') || text.includes('desporto') || text.includes('jogo') || text.includes('atleta') || text.includes('esporte')) {
        return 'esportes';
    } else if (text.includes('economia') || text.includes('negócio') || text.includes('empresa') || text.includes('investimento') || text.includes('finança')) {
        return 'economia';
    } else if (text.includes('política') || text.includes('governo') || text.includes('presidente') || text.includes('ministro') || text.includes('parlamento')) {
        return 'política';
    } else if (text.includes('saúde') || text.includes('hospital') || text.includes('médico') || text.includes('enfermeiro') || text.includes('doença')) {
        return 'saúde';
    } else if (text.includes('tecnologia') || text.includes('digital') || text.includes('internet') || text.includes('aplicativo') || text.includes('smartphone')) {
        return 'tecnologia';
    } else if (text.includes('cultura') || text.includes('arte') || text.includes('música') || text.includes('teatro') || text.includes('dança')) {
        return 'cultura';
    } else {
        return 'sociedade';
    }
}

function renderSingleNews(article) {
    if (container.querySelector(`[data-hash="${article.hash}"]`)) return;
    
    const category = article.category || determineCategory(article.title, article.content);
    article.category = category;
    
    const newsLink = generateShortLink(article);
    
    const c = document.createElement("a");
    c.className = "card";
    c.dataset.hash = article.hash;
    c.dataset.category = category;
    c.href = newsLink;
    c.style.textDecoration = 'none';
    c.style.color = 'inherit';
    c.innerHTML = `
    <div class="card-text">
        <div class="card-title">${article.title}</div>
        <div class="card-meta">
            <span class="source-tag">${article.source}</span>
            <span class="category-tag ${CATEGORIES[category].class}">${CATEGORIES[category].name}</span>
            <span>${formatDate(article.date)}</span>
        </div>
    </div>
    <img src="${article.image}" loading="lazy" alt="${article.title}" 
         onerror="this.onerror=null; this.src='https://via.placeholder.com/120x85/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
    `;
    
    let inserted = false;
    const cards = container.querySelectorAll('.card');
    
    for (let i = 0; i < cards.length; i++) {
        const cardDate = new Date(cards[i].dataset.date || 0);
        const newDate = new Date(article.date);
        
        if (newDate > cardDate) {
            container.insertBefore(c, cards[i]);
            inserted = true;
            break;
        }
    }
    
    if (!inserted) {
        container.appendChild(c);
    }
    
    c.dataset.date = article.date;
}

// ========== CARREGAMENTO DE NOTÍCIAS ==========

async function processSourceArticles(source, articles) {
    const newArticles = [];
    
    for (const article of articles) {
        const hash = generateNewsHash(article, source.name);
        
        if (hashes.has(hash)) continue;
        
        hashes.add(hash);
        
        const newsItem = {
            title: article.title.rendered || article.title,
            content: article.content.rendered || article.content || '',
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   article.thumbnail_url ||
                   "https://via.placeholder.com/300x200",
            source: source.name,
            date: article.date || article.modified || new Date().toISOString(),
            link: article.link || `https://${source.name.toLowerCase().replace(/\s/g, '')}.co.mz`,
            hash: hash
        };
        
        // Salvar no cache imediatamente
        saveToCache(newsItem);
        
        newArticles.push(newsItem);
    }
    
    newArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    for (const newsItem of newArticles) {
        news.push(newsItem);
        filteredNews.push(newsItem);
        
        renderSingleNews(newsItem);
        
        await new Promise(resolve => setTimeout(resolve, 30));
    }
    
    return newArticles.length;
}

async function loadSource(source) {
    if (!source.hasMore || source.isFetching) return 0;
    
    source.isFetching = true;
    let loadedCount = 0;
    
    try {
        const url = `${source.baseUrl}?_embed&per_page=${BATCH_SIZE}&page=${source.currentPage}`;
        const response = await fetch(url, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            mode: 'cors'
        });
        
        if (!response.ok) {
            if (response.status === 400 || response.status === 404) {
                source.hasMore = false;
            }
            throw new Error(`HTTP ${response.status} ao buscar ${source.name}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
            source.hasMore = false;
            return 0;
        }
        
        source.currentPage++;
        loadedCount = await processSourceArticles(source, data);
        
    } catch (error) {
        console.error(`Erro ao carregar ${source.name}:`, error);
        source.hasMore = false;
    } finally {
        source.isFetching = false;
        checkAllSourcesLoaded();
    }
    
    return loadedCount;
}

async function loadAllSources() {
    news = [];
    filteredNews = [];
    hashes.clear();
    allSourcesLoaded = false;
    
    container.innerHTML = '';
    
    sources.forEach(source => {
        source.currentPage = 1;
        source.hasMore = true;
        source.isFetching = false;
    });
    
    const promises = sources.map(source => loadSource(source));
    const results = await Promise.allSettled(promises);
    
    // Verificar se alguma fonte conseguiu carregar
    const anyLoaded = results.some(r => r.status === 'fulfilled' && r.value > 0);
    
    if (!anyLoaded && news.length === 0) {
        showNoNewsMessage();
    }
    
    reorderAllNewsByDate();
    
    // Mostrar feedback de atualização
    showRefreshFeedback(news.length);
}

function showNoNewsMessage() {
    const errorHTML = `
        <div class="error-message">
            <i class="fas fa-newspaper"></i>
            <h3>Nenhuma notícia disponível no momento</h3>
            <p>Pode ser um problema temporário com as fontes de notícias.</p>
            <p>Tente:</p>
            <ul style="text-align: left; display: inline-block;">
                <li>Verificar sua conexão com a internet</li>
                <li>Recarregar a página</li>
                <li>Acessar mais tarde</li>
            </ul>
            <a href="javascript:location.reload()"><i class="fas fa-sync-alt"></i> Recarregar Página</a>
        </div>
    `;
    container.innerHTML = errorHTML;
}

function showRefreshFeedback(count) {
    const feedback = document.createElement('div');
    feedback.className = 'refresh-feedback';
    feedback.innerHTML = `<i class="fas fa-check-circle"></i> ${count} notícias carregadas`;
    
    document.body.appendChild(feedback);
    feedback.style.display = 'block';
    
    setTimeout(() => {
        feedback.style.opacity = '0';
        feedback.style.transform = 'translateX(100%)';
        setTimeout(() => feedback.remove(), 300);
    }, 2000);
}

function reorderAllNewsByDate() {
    news.sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredNews.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

async function loadMoreNews() {
    if (isLoadingMore || allSourcesLoaded) return;
    
    isLoadingMore = true;
    infiniteLoader.style.display = 'block';
    
    let anySourceHasMore = false;
    const promises = [];
    
    for (const source of sources) {
        if (source.hasMore) {
            promises.push(loadSource(source));
            
            if (source.hasMore) {
                anySourceHasMore = true;
            }
        }
    }
    
    await Promise.allSettled(promises);
    
    allSourcesLoaded = !anySourceHasMore;
    
    isLoadingMore = false;
    infiniteLoader.style.display = 'none';
}

function checkAllSourcesLoaded() {
    allSourcesLoaded = sources.every(source => !source.hasMore);
    
    if (allSourcesLoaded) {
        infiniteLoader.style.display = 'none';
    }
}

function manualRefresh() {
    container.innerHTML = '';
    closeInfoModal();
    loadAllSources();
}

// ========== INICIALIZAÇÃO ==========

// Carregar cache existente primeiro
loadExistingCache();

// Carregar notícias
loadAllSources();

// [Restante do código permanece igual...]

// Atalhos de teclado
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeInfoModal();
        closeSidebar();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById("search-input").focus();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        manualRefresh();
    }
    
    // Atalho para limpar cache (Shift+Ctrl+L)
    if (e.shiftKey && (e.ctrlKey || e.metaKey) && e.key === 'L') {
        e.preventDefault();
        if (confirm('Deseja limpar o cache de notícias?')) {
            localStorage.removeItem('cached_news');
            newsCache.clear();
            loadAllSources();
        }
    }
});

console.log('Página principal carregada com sucesso! Cache:', newsCache.size, 'notícias');
</script>
</body>
</html>