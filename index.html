<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notícias CLD - Agregador de Notícias</title>
<meta name="description" content="Agregador de notícias de Moçambique em tempo real">
<meta name="robots" content="index, follow">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Service Worker para cache offline -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker registrado:', reg.scope))
        .catch(err => console.log('Falha ao registrar Service Worker:', err));
}
</script>
<style>
/* [Todo o CSS anterior permanece igual] */
/* Adicionar apenas estas novas regras: */

/* Preload indicator */
.preload-indicator {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #1a73e8, #0d62d9, #1a73e8);
    background-size: 200% 100%;
    animation: preloadSlide 2s linear infinite;
    z-index: 10010;
    display: none;
}

@keyframes preloadSlide {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Quick read notification */
.quick-read-notice {
    position: fixed;
    bottom: 90px;
    right: 20px;
    background: #1a73e8;
    color: white;
    padding: 12px 16px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    z-index: 1001;
    display: none;
    animation: slideInRight 0.3s ease-out;
    max-width: 300px;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Cache status indicator */
.cache-status {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #34a853;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    z-index: 1000;
    display: none;
}
</style>
</head>
<body>
<header>
<button class="header-btn" id="menu-btn" onclick="openSidebar()">☰</button>
Notícias CLD
<button class="header-btn" id="refresh-btn" onclick="manualRefresh()">↻</button>
</header>

<!-- Preload indicator -->
<div class="preload-indicator" id="preload-indicator"></div>

<!-- Quick read notice -->
<div class="quick-read-notice" id="quick-read-notice">
    <i class="fas fa-bolt"></i> Carregamento instantâneo ativado!
</div>

<!-- Cache status -->
<div class="cache-status" id="cache-status"></div>

<!-- [Restante do HTML permanece igual] -->

<script>
// ========== VARIÁVEIS GLOBAIS OTIMIZADAS ==========
let news = [];
let filteredNews = [];
let hashes = new Set();
const BATCH_SIZE = 15;
let isLoadingMore = false;
let allSourcesLoaded = false;
let currentCategory = 'todos';

// Cache de pré-carregamento
const preloadCache = new Map();
let isPreloading = false;

// CATEGORIAS DISPONÍVEIS
const CATEGORIES = {
    'todos': { name: 'Todos', color: '#1a73e8' },
    'sociedade': { name: 'Sociedade', color: '#2e7d32', class: 'sociedade-tag' },
    'política': { name: 'Política', color: '#c62828', class: 'politica-tag' },
    'economia': { name: 'Economia', color: '#ef6c00', class: 'economia-tag' },
    'esportes': { name: 'Esportes', color: '#1565c0', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', color: '#7b1fa2', class: 'cultura-tag' },
    'saúde': { name: 'Saúde', color: '#00796b', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', color: '#37474f', class: 'tech-tag' }
};

// ELEMENTOS DOM
const container = document.getElementById("news-container");
const infiniteLoader = document.getElementById("infinite-loader");
const infoModal = document.getElementById("info-modal");
const infoModalClose = document.getElementById("info-modal-close");
const modalTitle = document.getElementById("modal-title");
const modalIcon = document.getElementById("modal-icon");
const preloadIndicator = document.getElementById("preload-indicator");
const quickReadNotice = document.getElementById("quick-read-notice");
const cacheStatus = document.getElementById("cache-status");

// CONSTANTES
const WHATSAPP_CHANNEL_URL = "https://whatsapp.com/channel/0029Vb7BeBI7T8bRTbjcsN0t";
const CACHE_VERSION = 'v2';
const MAX_CACHE_SIZE = 100;

// ========== SISTEMA DE CACHE AVANÇADO ==========

// Inicializar cache
function initCache() {
    try {
        const cacheInfo = localStorage.getItem('cache_info');
        if (!cacheInfo) {
            localStorage.setItem('cache_info', JSON.stringify({
                version: CACHE_VERSION,
                size: 0,
                lastUpdate: new Date().toISOString()
            }));
        }
        
        // Mostrar status do cache
        const cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        cacheStatus.textContent = `Cache: ${cachedNews.length} notícias`;
        cacheStatus.style.display = 'block';
        setTimeout(() => {
            cacheStatus.style.display = 'none';
        }, 3000);
    } catch (e) {
        console.warn('Não foi possível inicializar cache:', e);
    }
}

// Salvar notícia no cache com metadados otimizados
function saveToCacheOptimized(article, sourceName) {
    try {
        const hash = generateNewsHash(article);
        
        // Verificar se já existe
        const existing = localStorage.getItem(`news_${hash}`);
        if (existing) return hash;
        
        // Criar objeto otimizado
        const newsItem = {
            id: hash,
            title: article.title.rendered,
            content: article.content.rendered.substring(0, 5000), // Limitar conteúdo
            excerpt: article.excerpt?.rendered || 
                    article.content.rendered.replace(/<[^>]*>/g, '').substring(0, 200),
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   "https://via.placeholder.com/300x200",
            source: sourceName,
            date: article.date || article.modified,
            link: article.link,
            timestamp: Date.now(),
            size: JSON.stringify(article).length
        };
        
        // Salvar no localStorage
        localStorage.setItem(`news_${hash}`, JSON.stringify(newsItem));
        
        // Atualizar lista de cache
        let cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        if (!cachedNews.includes(hash)) {
            cachedNews.push(hash);
            
            // Limitar tamanho do cache
            if (cachedNews.length > MAX_CACHE_SIZE) {
                const removed = cachedNews.shift();
                localStorage.removeItem(`news_${removed}`);
            }
            
            localStorage.setItem('cached_news', JSON.stringify(cachedNews));
            
            // Atualizar informações do cache
            const cacheInfo = JSON.parse(localStorage.getItem('cache_info') || '{}');
            cacheInfo.size = cachedNews.length;
            cacheInfo.lastUpdate = new Date().toISOString();
            localStorage.setItem('cache_info', JSON.stringify(cacheInfo));
        }
        
        return hash;
    } catch (e) {
        console.error('Erro ao salvar no cache otimizado:', e);
        return null;
    }
}

// Pré-carregar conteúdo de notícia
async function preloadNewsContent(hash, title, source) {
    if (preloadCache.has(hash) || isPreloading) return;
    
    isPreloading = true;
    preloadIndicator.style.display = 'block';
    
    try {
        // Buscar conteúdo completo se não estiver no cache
        const cached = localStorage.getItem(`news_${hash}`);
        if (!cached || !JSON.parse(cached).content) {
            // Simular pré-carregamento
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Salvar no cache de pré-carregamento
            preloadCache.set(hash, {
                title,
                source,
                timestamp: Date.now()
            });
        }
    } catch (e) {
        console.warn('Falha no pré-carregamento:', e);
    } finally {
        isPreloading = false;
        preloadIndicator.style.display = 'none';
    }
}

// ========== GERENCIAMENTO DE LINKS OTIMIZADO ==========

// Gerar link otimizado para leitura rápida
function generateOptimizedLink(hash, title, source) {
    // Adicionar dados mínimos para cache
    const params = new URLSearchParams({
        n: hash,
        t: title.substring(0, 50).replace(/\s+/g, '-'),
        s: source.substring(0, 20).replace(/\s+/g, '-'),
        ts: Date.now()
    });
    
    return `leitura.html?${params.toString()}`;
}

// Manipulador de clique otimizado
function setupOptimizedClickHandlers() {
    container.addEventListener('click', function(e) {
        const card = e.target.closest('.card');
        if (!card) return;
        
        e.preventDefault();
        
        const hash = card.dataset.hash;
        const title = card.querySelector('.card-title').textContent;
        const source = card.querySelector('.source-tag').textContent;
        
        // Mostrar notificação de carregamento rápido
        showQuickReadNotice();
        
        // Navegar para a página de leitura
        setTimeout(() => {
            window.location.href = generateOptimizedLink(hash, title, source);
        }, 50);
    });
}

// Mostrar notificação de carregamento rápido
function showQuickReadNotice() {
    quickReadNotice.style.display = 'block';
    setTimeout(() => {
        quickReadNotice.style.display = 'none';
    }, 2000);
}

// ========== FUNÇÕES DE UTILIDADE OTIMIZADAS ==========

// Gerar hash otimizado
function generateNewsHash(article) {
    const text = article.title.rendered + article.link;
    return btoa(text).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12);
}

// Processar artigos com cache
async function processSourceArticlesWithCache(source, articles) {
    const newArticles = [];
    
    for (const article of articles) {
        const hash = generateNewsHash(article);
        
        if (hashes.has(hash)) continue;
        hashes.add(hash);
        
        // Salvar no cache otimizado
        const cacheHash = saveToCacheOptimized(article, source.name);
        
        const newsItem = {
            title: article.title.rendered,
            content: article.content.rendered,
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   "https://via.placeholder.com/300x200",
            source: source.name,
            date: article.date || article.modified,
            link: article.link,
            hash: cacheHash || hash
        };
        
        newArticles.push(newsItem);
        
        // Pré-carregar se estiver visível
        if (isElementInViewport(container)) {
            setTimeout(() => {
                preloadNewsContent(hash, article.title.rendered, source.name);
            }, 100);
        }
    }
    
    newArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    for (const newsItem of newArticles) {
        news.push(newsItem);
        filteredNews.push(newsItem);
        
        renderSingleNews(newsItem);
        
        // Renderização assíncrona para não bloquear UI
        await new Promise(resolve => setTimeout(resolve, 10));
    }
}

// Verificar se elemento está visível
function isElementInViewport(el) {
    const rect = el.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

// ========== FUNÇÕES PRINCIPAIS OTIMIZADAS ==========

// Carregar notícias com cache
async function loadAllSourcesOptimized() {
    news = [];
    filteredNews = [];
    hashes.clear();
    allSourcesLoaded = false;
    
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Carregando notícias...</div>';
    
    // Mostrar notícias do cache primeiro
    loadCachedNewsFirst();
    
    // Carregar fontes
    const promises = sources.map(source => loadSourceOptimized(source));
    await Promise.allSettled(promises);
}

// Carregar notícias do cache primeiro
function loadCachedNewsFirst() {
    try {
        const cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        const recentCached = cachedNews.slice(-20).reverse(); // Últimas 20
        
        for (const hash of recentCached) {
            const cached = localStorage.getItem(`news_${hash}`);
            if (cached) {
                const article = JSON.parse(cached);
                if (!hashes.has(hash)) {
                    hashes.add(hash);
                    news.push(article);
                    filteredNews.push(article);
                    
                    // Renderizar rapidamente
                    const newsItem = {
                        title: article.title,
                        content: article.content,
                        image: article.image,
                        source: article.source,
                        date: article.date,
                        link: article.link,
                        hash: article.id
                    };
                    
                    renderSingleNews(newsItem);
                }
            }
        }
    } catch (e) {
        console.warn('Erro ao carregar cache:', e);
    }
}

// Carregar fonte otimizada
async function loadSourceOptimized(source) {
    if (!source.hasMore || source.isFetching) return;
    
    source.isFetching = true;
    
    try {
        const url = `${source.baseUrl}?_embed&per_page=${BATCH_SIZE}&page=${source.currentPage}&timestamp=${Date.now()}`;
        const response = await fetch(url, {
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            if (response.status === 400) {
                source.hasMore = false;
            }
            throw new Error(`Erro ao buscar ${source.name}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
            source.hasMore = false;
            return;
        }
        
        source.currentPage++;
        
        await processSourceArticlesWithCache(source, data);
        
    } catch (error) {
        console.error(`Erro ao carregar ${source.name}:`, error);
        source.hasMore = false;
    } finally {
        source.isFetching = false;
        checkAllSourcesLoaded();
    }
}

// [Restante das funções permanece similar, mas usando as versões otimizadas]

// ========== INICIALIZAÇÃO OTIMIZADA ==========

// Inicializar página
async function initPage() {
    // Inicializar cache
    initCache();
    
    // Configurar handlers otimizados
    setupOptimizedClickHandlers();
    
    // Carregar notícias
    await loadAllSourcesOptimized();
    
    // Configurar pré-carregamento ao rolar
    setupScrollPreload();
    
    console.log('Página otimizada carregada com sucesso!');
}

// Configurar pré-carregamento ao rolar
function setupScrollPreload() {
    let scrollTimer;
    window.addEventListener('scroll', () => {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => {
            const cards = container.querySelectorAll('.card');
            cards.forEach(card => {
                if (isElementInViewport(card) && !card.dataset.preloaded) {
                    const hash = card.dataset.hash;
                    const title = card.querySelector('.card-title').textContent;
                    const source = card.querySelector('.source-tag').textContent;
                    
                    card.dataset.preloaded = 'true';
                    preloadNewsContent(hash, title, source);
                }
            });
        }, 200);
    });
}

// Iniciar quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', initPage);

// Atalhos de teclado otimizados
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeInfoModal();
        closeSidebar();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById("search-input").focus();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        manualRefresh();
    }
    
    // Atalho para limpar cache (Ctrl+Shift+C)
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
        e.preventDefault();
        if (confirm('Limpar cache de notícias?')) {
            clearNewsCache();
        }
    }
});

// Limpar cache de notícias
function clearNewsCache() {
    try {
        const cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        cachedNews.forEach(hash => {
            localStorage.removeItem(`news_${hash}`);
        });
        localStorage.removeItem('cached_news');
        localStorage.setItem('cache_info', JSON.stringify({
            version: CACHE_VERSION,
            size: 0,
            lastUpdate: new Date().toISOString()
        }));
        
        alert('Cache limpo com sucesso!');
        location.reload();
    } catch (e) {
        console.error('Erro ao limpar cache:', e);
    }
}

// [Restante do código permanece igual, mas substitua as chamadas antigas pelas novas]
</script>
</body>
</html>