<!doctype html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Not√≠cias CLD - P√°gina Inicial</title>
    <meta name="description" content="Agregador de not√≠cias de Mo√ßambique em tempo real">
    <meta name="robots" content="index, follow">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f3f5;
            margin: 0;
            color: #111;
        }

        /* HEADER */
        header {
            background: #1a73e8;
            color: white;
            padding: 18px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            position: relative;
        }

        .header-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            color: #1a73e8;
            border: none;
            padding: 7px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .header-btn:hover {
            opacity: 0.9;
            transform: translateY(-50%) scale(1.05);
        }

        #menu-btn { left: 15px; }
        #refresh-btn { right: 15px; }

        /* SIDEBAR */
        #sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: none;
            z-index: 9998;
        }

        #sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: #fff;
            box-shadow: 2px 0 6px rgba(0,0,0,.2);
            padding: 20px;
            box-sizing: border-box;
            transition: .3s;
            z-index: 9999;
            overflow-y: auto;
        }

        #sidebar.open {
            left: 0;
        }

        #sidebar h2 {
            color: #1a73e8;
            margin-top: 0;
            font-size: 18px;
        }

        #sidebar p {
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }

        #close-sidebar {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 18px;
            color: #333;
        }

        /* CATEGORIAS */
        .categories {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-btn {
            background: #e8f0fe;
            border: 1px solid #dce6f5;
            color: #1a73e8;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .category-btn:hover {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        .category-btn.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        /* BOT√ïES MODAL */
        .modal-buttons {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-btn:hover {
            background: #0d62d9;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(26, 115, 232, 0.3);
        }

        /* SEARCH */
        .search-container {
            max-width: 950px;
            margin: 12px auto;
            padding: 0 12px;
        }

        #search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
            background: #fff;
            color: #111;
            transition: all 0.3s;
        }

        #search-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        /* LISTA - MANTENDO APAR√äNCIA ORIGINAL */
        #news-container {
            max-width: 950px;
            margin: auto;
            padding: 12px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,.08);
            cursor: pointer;
            transition: .2s;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid #e8e8e8;
        }
        .card:hover{ 
            transform:scale(1.01); 
            box-shadow:0 4px 12px rgba(0,0,0,.12);
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .card-text{ 
            width:70%; 
            cursor: pointer;
        }
        .card-title{ 
            font-size:16px;
            font-weight:bold;
            color:#111;
            margin-bottom:4px;
            line-height:1.3;
        }
        .card-meta{
            font-size:12px;
            color:#777;
            display:flex;
            align-items:center;
            gap:8px;
            flex-wrap: wrap;
        }

        .source-tag{
            background:#e8f0fe;
            color:#1a73e8;
            padding:2px 8px;
            border-radius:12px;
            font-size:11px;
            font-weight:bold;
        }

        .card img{
            width:120px;
            height:85px;
            object-fit:cover;
            border-radius:10px;
            background:#eee;
        }

        .category-tag {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .sociedade-tag {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
        }

        .politica-tag {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
        }

        .economia-tag {
            background: rgba(255, 152, 0, 0.1);
            color: #ef6c00;
        }

        .esportes-tag {
            background: rgba(33, 150, 243, 0.1);
            color: #1565c0;
        }

        .cultura-tag {
            background: rgba(156, 39, 176, 0.1);
            color: #7b1fa2;
        }

        .saude-tag {
            background: rgba(0, 150, 136, 0.1);
            color: #00796b;
        }

        .tech-tag {
            background: rgba(96, 125, 139, 0.1);
            color: #37474f;
        }

        /* LOADER INFINITO */
        #infinite-loader {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .infinite-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e8e8e8;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MODAL INFO */
        #info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        #info-modal-content {
            background: #fff;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }

        #info-modal-header {
            background: linear-gradient(135deg, #1a73e8, #0d62d9);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #info-modal-header h2 {
            margin: 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #info-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        #info-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        #info-modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(85vh - 80px);
        }

        /* SHARE PREVIEW */
        .share-preview {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1a73e8;
        }

        .share-preview small {
            color: #666;
            font-size: 12px;
        }

        .copy-link-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .copy-link-btn:hover {
            background: #0d62d9;
        }

        /* QUICK NAVIGATION */
        .quick-nav {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .nav-btn {
            background: #1a73e8;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #0d62d9;
            transform: translateY(-3px);
        }

        /* PRELOADER */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .preloader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .card-text {
                width: 65%;
            }
            
            .card img {
                width: 100px;
                height: 75px;
            }
            
            .header-btn {
                padding: 6px 10px;
                font-size: 16px;
            }
            
            .quick-nav {
                bottom: 15px;
                right: 15px;
            }
            
            .nav-btn {
                width: 45px;
                height: 45px;
            }
        }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- PRELOADER -->
    <div class="preloader" id="preloader">
        <div style="text-align: center;">
            <div style="width: 60px; height: 60px; border: 5px solid #e8e8e8; border-top: 5px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p style="color: #666; font-weight: bold;">Carregando not√≠cias...</p>
        </div>
    </div>

    <header>
        <button class="header-btn" id="menu-btn" onclick="openSidebar()">‚ò∞</button>
        Not√≠cias CLD
        <button class="header-btn" id="refresh-btn" onclick="manualRefresh()">‚Üª</button>
    </header>

    <!-- SIDEBAR -->
    <div id="sidebar-overlay"></div>
    <div id="sidebar">
        <span id="close-sidebar" onclick="closeSidebar()">‚úñ</span>
        <h2>Categorias</h2>
        <div class="categories">
            <button class="category-btn active" onclick="filterByCategory('todos')">Todos</button>
            <button class="category-btn" onclick="filterByCategory('sociedade')">Sociedade</button>
            <button class="category-btn" onclick="filterByCategory('pol√≠tica')">Pol√≠tica</button>
            <button class="category-btn" onclick="filterByCategory('economia')">Economia</button>
            <button class="category-btn" onclick="filterByCategory('esportes')">Esportes</button>
            <button class="category-btn" onclick="filterByCategory('cultura')">Cultura</button>
            <button class="category-btn" onclick="filterByCategory('sa√∫de')">Sa√∫de</button>
            <button class="category-btn" onclick="filterByCategory('tecnologia')">Tecnologia</button>
        </div>

        <h2>A√ß√µes</h2>
        <div class="modal-buttons">
            <button class="modal-btn" onclick="openInfoModal('sobre')">
                <i class="fas fa-info-circle"></i> Sobre a Plataforma
            </button>
            <button class="modal-btn" onclick="openInfoModal('contato')">
                <i class="fas fa-envelope"></i> Contacto
            </button>
        </div>
    </div>

    <!-- BUSCA -->
    <div class="search-container">
        <input id="search-input" placeholder="üîç Buscar not√≠cias..." onkeyup="searchNews()">
    </div>

    <!-- LISTA DE NOT√çCIAS -->
    <div id="news-container">
        <!-- Not√≠cias ser√£o carregadas aqui -->
    </div>

    <!-- LOADER INFINITO -->
    <div id="infinite-loader" style="display:none;">
        <div class="infinite-spinner"></div>
        Carregando mais not√≠cias...
    </div>

    <!-- QUICK NAVIGATION -->
    <div class="quick-nav">
        <button class="nav-btn" onclick="scrollToTop()" title="Voltar ao topo">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button class="nav-btn" onclick="manualRefresh()" title="Atualizar not√≠cias">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- MODAL INFO -->
    <div id="info-modal">
        <div id="info-modal-content">
            <div id="info-modal-header">
                <h2><i class="fas" id="modal-icon"></i> <span id="modal-title"></span></h2>
                <button id="info-modal-close">‚úñ</button>
            </div>
            <div id="info-modal-body"></div>
        </div>
    </div>

    <script>
        // SISTEMA DE CACHE OTIMIZADO
        class NewsCache {
            constructor() {
                this.CACHE_KEY = 'newsCache_v2';
                this.TIMESTAMP_KEY = 'newsCacheTimestamp_v2';
                this.CACHE_DURATION = 30 * 60 * 1000; // 30 minutos
            }

            isValid() {
                const timestamp = localStorage.getItem(this.TIMESTAMP_KEY);
                if (!timestamp) return false;
                
                return Date.now() - parseInt(timestamp) < this.CACHE_DURATION;
            }

            get() {
                if (!this.isValid()) {
                    this.clear();
                    return null;
                }
                
                const cached = localStorage.getItem(this.CACHE_KEY);
                return cached ? JSON.parse(cached) : null;
            }

            set(data) {
                localStorage.setItem(this.CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(this.TIMESTAMP_KEY, Date.now().toString());
            }

            clear() {
                localStorage.removeItem(this.CACHE_KEY);
                localStorage.removeItem(this.TIMESTAMP_KEY);
            }

            updateArticle(article) {
                const cached = this.get();
                if (cached) {
                    const index = cached.findIndex(n => n.id === article.id);
                    if (index !== -1) {
                        cached[index] = article;
                    } else {
                        cached.unshift(article);
                    }
                    this.set(cached);
                }
            }
        }

        // VARI√ÅVEIS GLOBAIS
        let news = [];
        let filteredNews = [];
        let hashes = new Set();
        const BATCH_SIZE = 20; // Aumentado para carregar mais r√°pido
        let isLoadingMore = false;
        let allSourcesLoaded = false;
        let currentCategory = 'todos';
        const newsCache = new NewsCache();

        // CATEGORIAS
        const CATEGORIES = {
            'todos': { name: 'Todos', color: '#1a73e8' },
            'sociedade': { name: 'Sociedade', color: '#2e7d32', class: 'sociedade-tag' },
            'pol√≠tica': { name: 'Pol√≠tica', color: '#c62828', class: 'politica-tag' },
            'economia': { name: 'Economia', color: '#ef6c00', class: 'economia-tag' },
            'esportes': { name: 'Esportes', color: '#1565c0', class: 'esportes-tag' },
            'cultura': { name: 'Cultura', color: '#7b1fa2', class: 'cultura-tag' },
            'sa√∫de': { name: 'Sa√∫de', color: '#00796b', class: 'saude-tag' },
            'tecnologia': { name: 'Tecnologia', color: '#37474f', class: 'tech-tag' }
        };

        // ELEMENTOS DOM
        const container = document.getElementById("news-container");
        const infiniteLoader = document.getElementById("infinite-loader");
        const infoModal = document.getElementById("info-modal");
        const infoModalClose = document.getElementById("info-modal-close");
        const modalTitle = document.getElementById("modal-title");
        const modalIcon = document.getElementById("modal-icon");
        const preloader = document.getElementById("preloader");

        // CONFIGURA√á√ÉO DAS FONTES OTIMIZADA
        const sources = [
            { 
                name: "O Pa√≠s", 
                baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 1
            },
            {
                name: "Jornal Not√≠cias",
                baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 1
            },
            {
                name: "Canal de Mo√ßambique",
                baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 2
            },
            { 
                name: "Carta de Mo√ßambique", 
                baseUrl: "https://cartamz.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 2
            },
            {
                name: "Time de Todos",
                baseUrl: "https://timesdetodos.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 3
            },
            { 
                name: "Integrity", 
                baseUrl: "https://integritymagazine.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 3
            },
            { 
                name: "Savana", 
                baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 3
            },
            {
                name: "JornalMZ",
                baseUrl: "https://jornalmz.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 4
            },
            {
                name: "Checka",
                baseUrl: "https://checka.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 4
            },
            {
                name: "Stop",
                baseUrl: "https://www.stop.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 4
            },
            {
                name: "Club of Mozambique",
                baseUrl: "https://clubofmozambique.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 5
            },
            {
                name: "Zitamar News",
                baseUrl: "https://www.zitamar.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false,
                priority: 5
            }
        ];

        // FUN√á√ïES DE UTILIDADE R√ÅPIDAS
        function formatDate(d) {
            const date = new Date(d);
            const now = new Date();
            const diff = now - date;
            
            // Se for menos de 1 hora, mostrar "h√° X minutos"
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `h√° ${minutes} ${minutes === 1 ? 'minuto' : 'minutos'}`;
            }
            
            // Se for hoje, mostrar apenas hora
            if (date.toDateString() === now.toDateString()) {
                return `hoje √†s ${date.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            // Se for ontem
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return `ontem √†s ${date.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            // Caso contr√°rio, mostrar data completa
            return date.toLocaleDateString('pt-PT', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function generateSlug(title) {
            return title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 40);
        }

        function generateNewsId(title, source, date) {
            const shortTitle = title.substring(0, 30);
            const sourceAbbr = source.substring(0, 3).toLowerCase().replace(/\s/g, '');
            const dateStr = new Date(date).getTime().toString(36);
            const slug = generateSlug(shortTitle);
            return `${sourceAbbr}-${slug}-${dateStr}`;
        }

        function stripHTML(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        // FUN√á√ïES DE INTERFACE
        function openSidebar() {
            document.getElementById("sidebar").classList.add("open");
            document.getElementById("sidebar-overlay").style.display = "block";
        }

        function closeSidebar() {
            document.getElementById("sidebar").classList.remove("open");
            document.getElementById("sidebar-overlay").style.display = "none";
        }

        document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentCategory = category;
            
            if (category === 'todos') {
                filteredNews = [...news];
            } else {
                filteredNews = news.filter(article => {
                    const articleCategory = determineCategory(article.title, article.content);
                    return articleCategory === category;
                });
            }
            
            const searchText = document.getElementById("search-input").value.toLowerCase();
            if (searchText) {
                filteredNews = filteredNews.filter(n =>
                    n.title.toLowerCase().includes(searchText) || 
                    n.source.toLowerCase().includes(searchText)
                );
            }
            
            container.innerHTML = '';
            filteredNews.forEach(article => {
                renderSingleNews(article);
            });
            
            // Salva filtro atual
            localStorage.setItem('currentFilter', category);
        }

        function searchNews() {
            const q = document.getElementById("search-input").value.toLowerCase();
            
            let tempFiltered = [...news];
            
            if (currentCategory !== 'todos') {
                tempFiltered = news.filter(article => {
                    const articleCategory = determineCategory(article.title, article.content);
                    return articleCategory === category;
                });
            }
            
            filteredNews = tempFiltered.filter(n =>
                n.title.toLowerCase().includes(q) || 
                n.source.toLowerCase().includes(q) ||
                (n.excerpt && n.excerpt.toLowerCase().includes(q))
            );
            
            container.innerHTML = '';
            filteredNews.forEach(article => {
                renderSingleNews(article);
            });
        }

        // MODAL INFO OTIMIZADA
        function openInfoModal(type) {
            closeSidebar();
            
            let title = '';
            let icon = '';
            let content = '';
            
            if (type === 'sobre') {
                title = 'Sobre a Plataforma';
                icon = 'fa-info-circle';
                content = `
                    <div style="line-height: 1.6;">
                        <h3 style="color: #1a73e8; margin-top: 0;">üì∞ Agregador de Not√≠cias</h3>
                        <p>Plataforma que re√∫ne not√≠cias das principais fontes de Mo√ßambique em tempo real.</p>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h4 style="margin-top: 0;">‚ö° Carregamento R√°pido</h4>
                            <p>Sistema otimizado para carregar not√≠cias instantaneamente dos links compartilhados.</p>
                        </div>
                        
                        <button onclick="copyPlatformLink()" style="background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                            <i class="fas fa-link"></i> Copiar Link da Plataforma
                        </button>
                    </div>
                `;
            } else if (type === 'contato') {
                title = 'Contacto';
                icon = 'fa-envelope';
                content = `
                    <div style="line-height: 1.6;">
                        <h3 style="color: #1a73e8; margin-top: 0;">üìû Contacte-nos</h3>
                        <p><strong>Email:</strong> claudioarmando001@gmail.com</p>
                        <p><strong>Telefone:</strong> +258 869 667 677</p>
                        <p><em>Hor√°rio: Seg-Sex, 08:00-18:00</em></p>
                    </div>
                `;
            }
            
            modalTitle.textContent = title;
            modalIcon.className = `fas ${icon}`;
            document.getElementById("info-modal-body").innerHTML = content;
            infoModal.style.display = "flex";
        }

        function closeInfoModal() {
            infoModal.style.display = "none";
        }

        infoModalClose.addEventListener('click', closeInfoModal);
        infoModal.addEventListener('click', (e) => {
            if (e.target.id === 'info-modal') closeInfoModal();
        });

        function copyPlatformLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link da plataforma copiado!');
            });
        }

        // DETERMINAR CATEGORIA R√ÅPIDA
        function determineCategory(title, content) {
            const text = (title + ' ' + (content || '')).toLowerCase();
            
            const categoryPatterns = {
                'pol√≠tica': /\b(pol√≠tica|governo|presidente|elei√ß√µes|partido|parlamento|ministro)\b/,
                'economia': /\b(economia|neg√≥cio|empresa|investimento|banco|finan√ßas|mercado)\b/,
                'esportes': /\b(esporte|futebol|jogo|atleta|campeonato|liga|competi√ß√£o)\b/,
                'sa√∫de': /\b(sa√∫de|hospital|m√©dico|doen√ßa|vacina|tratamento|epidemia)\b/,
                'tecnologia': /\b(tecnologia|internet|digital|aplicativo|software|startup|inovac√ß√£o)\b/,
                'cultura': /\b(cultura|arte|m√∫sica|teatro|cinema|literatura|tradi√ß√£o)\b/
            };
            
            for (const [category, pattern] of Object.entries(categoryPatterns)) {
                if (pattern.test(text)) {
                    return category;
                }
            }
            
            return 'sociedade';
        }

        // RENDERIZAR NOT√çCIA (APAR√äNCIA ORIGINAL)
        function renderSingleNews(article) {
            if (container.querySelector(`[data-id="${article.id}"]`)) return;
            
            const category = article.category || determineCategory(article.title, article.content);
            article.category = category;
            
            if (!article.id) {
                article.id = generateNewsId(article.title, article.source, article.date);
            }
            
            const newsUrl = `leitura.html?id=${article.id}`;
            
            const c = document.createElement("div");
            c.className = "card";
            c.dataset.id = article.id;
            c.dataset.category = category;
            c.dataset.date = article.date;
            
            c.innerHTML = `
                <div class="card-text" onclick="window.location.href='${newsUrl}'">
                    <div class="card-title">${article.title}</div>
                    <div class="card-meta">
                        <span class="source-tag">${article.source}</span>
                        <span class="category-tag ${CATEGORIES[category]?.class || 'sociedade-tag'}">
                            ${CATEGORIES[category]?.name || 'Sociedade'}
                        </span>
                        <span>${formatDate(article.date)}</span>
                    </div>
                </div>
                <img src="${article.image}" loading="lazy" alt="${article.title}" 
                     onclick="window.location.href='${newsUrl}'"
                     onerror="this.src='https://via.placeholder.com/120x85/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
            `;
            
            // Ordena√ß√£o por data (mais recente primeiro)
            let inserted = false;
            const cards = container.querySelectorAll('.card');
            const newDate = new Date(article.date).getTime();
            
            for (let i = 0; i < cards.length; i++) {
                const cardDate = new Date(cards[i].dataset.date).getTime();
                if (newDate > cardDate) {
                    container.insertBefore(c, cards[i]);
                    inserted = true;
                    break;
                }
            }
            
            if (!inserted) {
                container.appendChild(c);
            }
        }

        // CARREGAMENTO OTIMIZADO
        async function processSourceArticles(source, articles) {
            const newArticles = [];
            
            for (const article of articles) {
                const hash = (article.title.rendered + article.link).replace(/\W/g, "");
                
                if (hashes.has(hash)) continue;
                hashes.add(hash);
                
                const newsItem = {
                    id: generateNewsId(article.title.rendered, source.name, article.date),
                    title: article.title.rendered,
                    content: article.content.rendered,
                    excerpt: stripHTML(article.excerpt?.rendered || '').substring(0, 150),
                    image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                           article.jetpack_featured_media_url ||
                           "https://via.placeholder.com/300x200",
                    source: source.name,
                    date: article.date || article.modified,
                    link: article.link,
                    hash: hash
                };
                
                newArticles.push(newsItem);
            }
            
            // Processamento em lote para melhor performance
            const batchSize = 5;
            for (let i = 0; i < newArticles.length; i += batchSize) {
                const batch = newArticles.slice(i, i + batchSize);
                
                batch.forEach(newsItem => {
                    news.push(newsItem);
                    filteredNews.push(newsItem);
                    renderSingleNews(newsItem);
                });
                
                // Pequena pausa para n√£o bloquear a UI
                if (i + batchSize < newArticles.length) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
        }

        async function loadSource(source) {
            if (!source.hasMore || source.isFetching) return;
            
            source.isFetching = true;
            
            try {
                const url = `${source.baseUrl}?_embed&per_page=${BATCH_SIZE}&page=${source.currentPage}`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    source.hasMore = false;
                    return;
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    source.hasMore = false;
                    return;
                }
                
                source.currentPage++;
                await processSourceArticles(source, data);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.warn(`Erro na fonte ${source.name}:`, error);
                }
                source.hasMore = false;
            } finally {
                source.isFetching = false;
                checkAllSourcesLoaded();
            }
        }

        // CARREGAMENTO COM CACHE
        async function loadAllSources(forceRefresh = false) {
            // Esconde preloader ap√≥s 1.5 segundos no m√°ximo
            setTimeout(() => {
                preloader.classList.add('hidden');
            }, 1500);
            
            // Verifica cache primeiro
            if (!forceRefresh) {
                const cached = newsCache.get();
                if (cached) {
                    news = cached;
                    filteredNews = [...cached];
                    
                    // Renderiza do cache primeiro
                    container.innerHTML = '';
                    filteredNews.forEach(article => {
                        renderSingleNews(article);
                    });
                    
                    preloader.classList.add('hidden');
                    
                    // Depois carrega atualiza√ß√µes em background
                    setTimeout(() => loadFreshNews(), 1000);
                    return;
                }
            }
            
            // Se n√£o tem cache ou forceRefresh = true
            news = [];
            filteredNews = [];
            hashes.clear();
            allSourcesLoaded = false;
            container.innerHTML = '';
            
            sources.forEach(source => {
                source.currentPage = 1;
                source.hasMore = true;
                source.isFetching = false;
            });
            
            // Carrega fontes priorit√°rias primeiro
            const prioritySources = [...sources].sort((a, b) => a.priority - b.priority);
            
            // Carrega fontes priorit√°rias em paralelo
            const promises = prioritySources.map(source => loadSource(source));
            await Promise.allSettled(promises);
            
            // Ordena e salva no cache
            reorderAllNewsByDate();
            newsCache.set(news);
            
            preloader.classList.add('hidden');
        }

        // CARREGAR NOT√çCIAS FRESCAS EM BACKGROUND
        async function loadFreshNews() {
            // Reseta apenas algumas fontes para atualiza√ß√£o
            const freshSources = sources.filter(s => s.priority <= 2);
            freshSources.forEach(source => {
                source.currentPage = 1;
                source.hasMore = true;
            });
            
            // Carrega em background
            const promises = freshSources.map(source => loadSource(source));
            Promise.allSettled(promises).then(() => {
                if (news.length > 0) {
                    reorderAllNewsByDate();
                    newsCache.set(news);
                }
            });
        }

        function reorderAllNewsByDate() {
            news.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredNews.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Re-renderiza mantendo os cards existentes
            const existingCards = {};
            container.querySelectorAll('.card').forEach(card => {
                existingCards[card.dataset.id] = card;
            });
            
            container.innerHTML = '';
            filteredNews.forEach(article => {
                if (existingCards[article.id]) {
                    container.appendChild(existingCards[article.id]);
                } else {
                    renderSingleNews(article);
                }
            });
        }

        async function loadMoreNews() {
            if (isLoadingMore || allSourcesLoaded) return;
            
            isLoadingMore = true;
            infiniteLoader.style.display = 'block';
            
            // Carrega das fontes que ainda t√™m conte√∫do
            const activeSources = sources.filter(s => s.hasMore);
            const promises = activeSources.map(source => loadSource(source));
            
            await Promise.allSettled(promises);
            
            allSourcesLoaded = sources.every(source => !source.hasMore);
            isLoadingMore = false;
            infiniteLoader.style.display = 'none';
            
            // Atualiza cache
            newsCache.set(news);
        }

        function checkAllSourcesLoaded() {
            allSourcesLoaded = sources.every(source => !source.hasMore);
            if (allSourcesLoaded) infiniteLoader.style.display = 'none';
        }

        // CONTROLES
        function manualRefresh() {
            newsCache.clear();
            loadAllSources(true);
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // SCROLL INFINITO OTIMIZADO
        let scrollTimer;
        window.addEventListener("scroll", () => {
            if (scrollTimer) clearTimeout(scrollTimer);
            
            scrollTimer = setTimeout(() => {
                const scrollPosition = window.innerHeight + window.scrollY;
                const threshold = document.body.offsetHeight - 500;
                
                if (scrollPosition >= threshold && !isLoadingMore && !allSourcesLoaded) {
                    loadMoreNews();
                }
            }, 200);
        });

        // DETECTAR SE VEM DE UM LINK DIRETO
        function checkDirectLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const directId = urlParams.get('direct');
            
            if (directId) {
                // Remove o par√¢metro da URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                
                // Redireciona para a p√°gina de leitura
                window.location.href = `leitura.html?id=${directId}`;
                return true;
            }
            
            return false;
        }

        // CARREGAR FILTRO SALVO
        function loadSavedFilter() {
            const savedFilter = localStorage.getItem('currentFilter');
            if (savedFilter && CATEGORIES[savedFilter]) {
                currentCategory = savedFilter;
                
                // Ativa o bot√£o correspondente
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${savedFilter}'`)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Aplica o filtro
                filterByCategory(savedFilter);
            }
        }

        // INICIALIZA√á√ÉO R√ÅPIDA
        document.addEventListener('DOMContentLoaded', () => {
            // Verifica se √© um redirecionamento direto
            if (!checkDirectLink()) {
                // Carrega not√≠cias normalmente
                loadAllSources();
                loadSavedFilter();
            }
        });

        // ATUALIZA√á√ÉO PERI√ìDICA
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                loadFreshNews();
            }
        }, 5 * 60 * 1000); // A cada 5 minutos

        // ATALHOS DE TECLADO
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeInfoModal();
                closeSidebar();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById("search-input").focus();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                manualRefresh();
            }
        });

        // SERVICE WORKER PARA CACHE AVAN√áADO (OPCIONAL)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }

        // EXPORTAR FUN√á√ïES PARA USO GLOBAL
        window.openNews = function(articleId) {
            window.location.href = `leitura.html?id=${articleId}`;
        };
    </script>
</body>
</html>