<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Not√≠cias CLD - Agregador de Not√≠cias de Mo√ßambique</title>
<meta name="description" content="Agregador de not√≠cias de Mo√ßambique em tempo real">
<meta name="robots" content="index, follow">
<style>
body{
    font-family:Arial,sans-serif;
    background:#f2f3f5;
    margin:0;
    color:#111;
}

/* HEADER */
header{
    background:#1a73e8;
    color:white;
    padding:18px;
    text-align:center;
    font-size:20px;
    font-weight:bold;
    position:relative;
}

.header-btn{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    background:white;
    color:#1a73e8;
    border:none;
    padding:7px 12px;
    border-radius:8px;
    cursor:pointer;
    font-size:18px;
    font-weight:bold;
    transition: all 0.3s;
}

.header-btn:hover {
    opacity: 0.9;
    transform: translateY(-50%) scale(1.05);
}

#menu-btn{ left:15px; }
#refresh-btn{ right:15px; }

/* SIDEBAR */
#sidebar-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.5);
    display:none;
    z-index:9998;
}

#sidebar{
    position:fixed;
    top:0;
    left:-280px;
    width:280px;
    height:100vh;
    background:#fff;
    box-shadow:2px 0 6px rgba(0,0,0,.2);
    padding:20px;
    box-sizing:border-box;
    transition:.3s;
    z-index:9999;
    overflow-y:auto;
}

#sidebar.open{
    left:0;
}

#sidebar h2{
    color:#1a73e8;
    margin-top:0;
    font-size:18px;
}

#sidebar p{
    font-size:14px;
    color:#555;
    line-height:1.5;
}

#sidebar .contact div{
    margin:8px 0;
    font-size:14px;
}

#close-sidebar{
    position:absolute;
    top:15px;
    right:15px;
    cursor:pointer;
    font-size:18px;
    color:#333;
}

/* CATEGORIAS */
.categories {
    margin: 15px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.category-btn {
    background: #e8f0fe;
    border: 1px solid #dce6f5;
    color: #1a73e8;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s;
    font-weight: 500;
}

.category-btn:hover {
    background: #1a73e8;
    color: white;
    border-color: #1a73e8;
}

.category-btn.active {
    background: #1a73e8;
    color: white;
    border-color: #1a73e8;
}

/* BOT√ïES MODAL */
.modal-buttons {
    margin: 20px 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.modal-btn {
    background: #1a73e8;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    font-weight: bold;
    transition: all 0.3s;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-btn:hover {
    background: #0d62d9;
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(26, 115, 232, 0.3);
}

.modal-btn i {
    font-size: 18px;
}

/* SEARCH */
.search-container{
    max-width:950px;
    margin:12px auto;
    padding:0 12px;
}
#search-input{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid #ddd;
    font-size:16px;
    background:#fff;
    color:#111;
    transition: all 0.3s;
}

#search-input:focus {
    outline: none;
    border-color: #1a73e8;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
}

/* LISTA */
#news-container{
    max-width:950px;
    margin:auto;
    padding:12px;
}

.card{
    background:white;
    border-radius:12px;
    padding:12px;
    margin-bottom:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 2px 5px rgba(0,0,0,.08);
    cursor:pointer;
    transition:.2s;
    animation: fadeIn 0.5s ease-out;
    border: 1px solid #e8e8e8;
}
.card:hover{ 
    transform:scale(1.01); 
    box-shadow:0 4px 12px rgba(0,0,0,.12);
}

@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.card-text{ width:70%; }
.card-title{ 
    font-size:16px;
    font-weight:bold;
    color:#111;
    margin-bottom:4px;
    line-height:1.3;
}
.card-meta{
    font-size:12px;
    color:#777;
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap: wrap;
}

.source-tag{
    background:#e8f0fe;
    color:#1a73e8;
    padding:2px 8px;
    border-radius:12px;
    font-size:11px;
    font-weight:bold;
}

.card img{
    width:120px;
    height:85px;
    object-fit:cover;
    border-radius:10px;
    background:#eee;
}

.category-tag {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
}

.sociedade-tag {
    background: rgba(76, 175, 80, 0.1);
    color: #2e7d32;
}

.politica-tag {
    background: rgba(244, 67, 54, 0.1);
    color: #c62828;
}

.economia-tag {
    background: rgba(255, 152, 0, 0.1);
    color: #ef6c00;
}

.esportes-tag {
    background: rgba(33, 150, 243, 0.1);
    color: #1565c0;
}

.cultura-tag {
    background: rgba(156, 39, 176, 0.1);
    color: #7b1fa2;
}

.saude-tag {
    background: rgba(0, 150, 136, 0.1);
    color: #00796b;
}

.tech-tag {
    background: rgba(96, 125, 139, 0.1);
    color: #37474f;
}

/* LOADER INFINITO */
#infinite-loader {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 14px;
}

.infinite-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #e8e8e8;
    border-top: 3px solid #1a73e8;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* MODAL INFO (SOBRE E CONTATO) - MELHORADO */
#info-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 10001;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-out;
}

#info-modal-content {
    background: #fff;
    width: 90%;
    max-width: 500px;
    max-height: 85vh;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    overflow: hidden;
    position: relative;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#info-modal-header {
    background: linear-gradient(135deg, #1a73e8, #0d62d9);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#info-modal-header h2 {
    margin: 0;
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

#info-modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

#info-modal-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}

#info-modal-body {
    padding: 25px;
    overflow-y: auto;
    max-height: calc(85vh - 80px);
}

/* CONTE√öDO INFO MODAL */
.info-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.info-section:last-child {
    margin-bottom: 0;
    border-bottom: none;
}

.info-section h3 {
    color: #1a73e8;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.info-section p {
    line-height: 1.6;
    color: #444;
    margin-bottom: 15px;
}

.info-section ul {
    padding-left: 20px;
    margin-bottom: 15px;
}

.info-section li {
    margin-bottom: 8px;
    line-height: 1.5;
}

/* CONTATO INFO */
.contact-info {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s;
}

.contact-item:hover {
    background: #e8f0fe;
    transform: translateX(5px);
}

.contact-item i {
    color: #1a73e8;
    font-size: 18px;
    width: 24px;
}

.contact-item span {
    font-size: 15px;
    color: #333;
}

.contact-link {
    color: #1a73e8;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s;
}

.contact-link:hover {
    color: #0d62d9;
    text-decoration: underline;
}

/* SOCIAL LINKS */
.social-links {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.social-btn {
    flex: 1;
    min-width: 120px;
    padding: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
}

.social-btn i {
    font-size: 16px;
}

.social-btn.whatsapp {
    background: #25d366;
    color: white;
}

.social-btn.whatsapp:hover {
    background: #1da851;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
}

.social-btn.email {
    background: #ea4335;
    color: white;
}

.social-btn.email:hover {
    background: #d23c2e;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
}

.social-btn.phone {
    background: #34a853;
    color: white;
}

.social-btn.phone:hover {
    background: #2d9148;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
}

/* BADGE DESTAQUE */
.info-badge {
    display: inline-block;
    background: linear-gradient(135deg, #1a73e8, #0d62d9);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 15px;
}

.info-highlight {
    background: #e8f0fe;
    border-left: 4px solid #1a73e8;
    padding: 15px;
    border-radius: 0 8px 8px 0;
    margin: 20px 0;
}

.info-highlight p {
    margin: 0;
    color: #1a73e8;
    font-weight: 500;
}

/* FEATURES GRID */
.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin: 20px 0;
}

.feature-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    transition: all 0.3s;
}

.feature-item:hover {
    background: #e8f0fe;
    transform: translateY(-3px);
}

.feature-item i {
    color: #1a73e8;
    font-size: 20px;
    margin-bottom: 8px;
    display: block;
}

.feature-item span {
    font-size: 12px;
    color: #555;
    font-weight: 500;
}

/* WHATSAPP FLOATING BUTTON */
.whatsapp-channel-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #25d366;
    background-image: url('https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg');
    background-repeat: no-repeat;
    background-position: center;
    background-size: 65%;
    color: white;
    border: none;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    z-index: 1000;
    font-size: 0;
    transition: all 0.3s ease;
    padding: 0;
}

.whatsapp-channel-btn:hover {
    transform: translateY(-3px) scale(1.1);
    box-shadow: 0 6px 16px rgba(37, 211, 102, 0.4);
}

.whatsapp-channel-btn::after {
    content: attr(title);
    position: absolute;
    right: 70px;
    background: #25d366;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    transform: translateX(10px);
    transition: all 0.3s ease;
    pointer-events: none;
}

.whatsapp-channel-btn:hover::after {
    opacity: 1;
    transform: translateX(0);
}

/* NOT√çCIAS RELACIONADAS */
.related-news-container {
    display: grid;
    gap: 15px;
    margin-top: 15px;
}

.related-news-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    border-left: 4px solid #1a73e8;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: inherit;
}

.related-news-card:hover {
    background: #e8f0fe;
    transform: translateX(5px);
    text-decoration: none;
    color: inherit;
}

.related-news-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
}

.related-news-text {
    flex: 1;
}

.related-news-title {
    font-size: 14px;
    font-weight: 600;
    color: #111;
    margin-bottom: 4px;
    line-height: 1.3;
}

.related-news-meta {
    font-size: 11px;
    color: #666;
    display: flex;
    align-items: center;
    gap: 8px;
}

.no-related-news {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 14px;
    background: #f8f9fa;
    border-radius: 8px;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header>
<button class="header-btn" id="menu-btn" onclick="openSidebar()">‚ò∞</button>
Not√≠cias CLD
<button class="header-btn" id="refresh-btn" onclick="manualRefresh()">‚Üª</button>
</header>

<!-- SIDEBAR -->
<div id="sidebar-overlay"></div>
<div id="sidebar">
<span id="close-sidebar" onclick="closeSidebar()">‚úñ</span>
<h2>Categorias</h2>
<div class="categories">
<button class="category-btn active" onclick="filterByCategory('todos')">Todos</button>
<button class="category-btn" onclick="filterByCategory('sociedade')">Sociedade</button>
<button class="category-btn" onclick="filterByCategory('pol√≠tica')">Pol√≠tica</button>
<button class="category-btn" onclick="filterByCategory('economia')">Economia</button>
<button class="category-btn" onclick="filterByCategory('esportes')">Esportes</button>
<button class="category-btn" onclick="filterByCategory('cultura')">Cultura</button>
<button class="category-btn" onclick="filterByCategory('sa√∫de')">Sa√∫de</button>
<button class="category-btn" onclick="filterByCategory('tecnologia')">Tecnologia</button>
</div>

<h2>A√ß√µes</h2>
<div class="modal-buttons">
<button class="modal-btn" onclick="openInfoModal('sobre')">
    <i class="fas fa-info-circle"></i> Sobre a Plataforma
</button>
<button class="modal-btn" onclick="openInfoModal('contato')">
    <i class="fas fa-envelope"></i> Contacto
</button>
</div>
</div>

<!-- BUSCA -->
<div class="search-container">
<input id="search-input" placeholder="üîç Buscar not√≠cias..." onkeyup="searchNews()">
</div>

<!-- LISTA COM RENDERIZA√á√ÉO EM TEMPO REAL -->
<div id="news-container">
<!-- Not√≠cias aparecer√£o aqui automaticamente -->
</div>

<!-- LOADER PARA SCROLL INFINITO -->
<div id="infinite-loader" style="display:none;">
    <div class="infinite-spinner"></div>
    Carregando mais not√≠cias...
</div>

<!-- MODAL INFO (SOBRE/CONTATO) - MELHORADA -->
<div id="info-modal">
<div id="info-modal-content">
<div id="info-modal-header">
    <h2><i class="fas" id="modal-icon"></i> <span id="modal-title"></span></h2>
    <button id="info-modal-close">‚úñ</button>
</div>
<div id="info-modal-body"></div>
</div>
</div>

<!-- WHATSAPP CHANNEL BUTTON -->
<button class="whatsapp-channel-btn" onclick="openWhatsAppChannel()" title="Canal WhatsApp" aria-label="Abrir canal oficial no WhatsApp">
</button>

<script>
// VARI√ÅVEIS GLOBAIS
let news = []; // Todas as not√≠cias carregadas
let filteredNews = []; // Not√≠cias filtradas para busca
let hashes = new Set(); // Para evitar duplicatas
const BATCH_SIZE = 15; // Quantas not√≠cias carregar por fonte
let isLoadingMore = false; // Flag para evitar m√∫ltiplos carregamentos
let allSourcesLoaded = false; // Se todas as fontes foram completamente carregadas
let currentCategory = 'todos'; // Categoria atual selecionada

// CATEGORIAS DISPON√çVEIS
const CATEGORIES = {
    'todos': { name: 'Todos', color: '#1a73e8' },
    'sociedade': { name: 'Sociedade', color: '#2e7d32', class: 'sociedade-tag' },
    'pol√≠tica': { name: 'Pol√≠tica', color: '#c62828', class: 'politica-tag' },
    'economia': { name: 'Economia', color: '#ef6c00', class: 'economia-tag' },
    'esportes': { name: 'Esportes', color: '#1565c0', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', color: '#7b1fa2', class: 'cultura-tag' },
    'sa√∫de': { name: 'Sa√∫de', color: '#00796b', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', color: '#37474f', class: 'tech-tag' }
};

// ELEMENTOS DOM
const container = document.getElementById("news-container");
const infiniteLoader = document.getElementById("infinite-loader");
const infoModal = document.getElementById("info-modal");
const infoModalClose = document.getElementById("info-modal-close");
const modalTitle = document.getElementById("modal-title");
const modalIcon = document.getElementById("modal-icon");

// CONSTANTES
const WHATSAPP_CHANNEL_URL = "https://whatsapp.com/channel/0029Vb7BeBI7T8bRTbjcsN0t";

// CONFIGURA√á√ÉO DAS FONTES
const sources = [
    { 
        name: "O Pa√≠s", 
        baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Time de Todos",
        baseUrl: "https://timesdetodos.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Integrity", 
        baseUrl: "https://integritymagazine.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Jornal Not√≠cias",
        baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Savana", 
        baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "JornalMZ",
        baseUrl: "https://jornalmz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Checka",
        baseUrl: "https://checka.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Canal de Mo√ßambique",
        baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Stop",
        baseUrl: "https://www.stop.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Club of Mozambique",
        baseUrl: "https://clubofmozambique.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Zitamar News",
        baseUrl: "https://www.zitamar.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Carta de Mo√ßambique", 
        baseUrl: "https://cartamz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    }
];

/* ========== FUN√á√ÉO PARA GERAR SLUG ========== */

// Fun√ß√£o para gerar slug amig√°vel para URLs
function generateSlug(text) {
    return text
        .toLowerCase()
        .replace(/[^\w\s-√†√°√¢√£√®√©√™√¨√≠√Æ√≤√≥√¥√µ√π√∫√ª√±√ß]/g, '')
        .replace(/[√†√°√¢√£]/g, 'a')
        .replace(/[√®√©√™]/g, 'e')
        .replace(/[√¨√≠√Æ]/g, 'i')
        .replace(/[√≤√≥√¥√µ]/g, 'o')
        .replace(/[√π√∫√ª]/g, 'u')
        .replace(/√±/g, 'n')
        .replace(/√ß/g, 'c')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '')
        .substring(0, 100);
}

/* ========== FUN√á√ÉO PARA GERAR LINK DA NOT√çCIA ========== */

function generateNewsLink(article) {
    const slug = generateSlug(article.title);
    const sourceSlug = generateSlug(article.source);
    return `leitura.html?source=${encodeURIComponent(sourceSlug)}&slug=${encodeURIComponent(slug)}&id=${article.hash}`;
}

/* ========== FUN√á√ïES DE INTERFACE ========== */

/* SIDEBAR */
function openSidebar(){
    document.getElementById("sidebar").classList.add("open");
    document.getElementById("sidebar-overlay").style.display="block";
}
function closeSidebar(){
    document.getElementById("sidebar").classList.remove("open");
    document.getElementById("sidebar-overlay").style.display="none";
}

document.getElementById('sidebar-overlay').addEventListener('click', function(event) {
    if (event.target === this) {
        closeSidebar();
    }
});

/* DATA */
function formatDate(d){
    return new Date(d).toLocaleString("pt-PT");
}

/* CATEGORIAS */
function filterByCategory(category) {
    // Atualiza bot√µes ativos
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentCategory = category;
    
    // Aplica filtro de categoria
    if (category === 'todos') {
        filteredNews = [...news];
    } else {
        filteredNews = news.filter(article => {
            const articleCategory = determineCategory(article.title, article.content);
            return articleCategory === category;
        });
    }
    
    // Re-aplica busca se houver texto na busca
    const searchText = document.getElementById("search-input").value.toLowerCase();
    if (searchText) {
        filteredNews = filteredNews.filter(n =>
            n.title.toLowerCase().includes(searchText) || 
            n.source.toLowerCase().includes(searchText)
        );
    }
    
    // Re-renderiza
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

/* BUSCA */
function searchNews(){
    const q = document.getElementById("search-input").value.toLowerCase();
    
    // Primeiro filtra por categoria
    let tempFiltered = [...news];
    
    if (currentCategory !== 'todos') {
        tempFiltered = news.filter(article => {
            const articleCategory = determineCategory(article.title, article.content);
            return articleCategory === currentCategory;
        });
    }
    
    // Depois aplica o filtro de busca
    filteredNews = tempFiltered.filter(n =>
        n.title.toLowerCase().includes(q) || 
        n.source.toLowerCase().includes(q)
    );
    
    // Limpa e re-renderiza todas as not√≠cias filtradas
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

/* MODAL INFO (SOBRE/CONTATO) - MELHORADA */
function openInfoModal(type) {
    closeSidebar(); // Fecha a sidebar quando abre a modal
    
    let title = '';
    let icon = '';
    let content = '';
    
    if (type === 'sobre') {
        title = 'Sobre a Plataforma';
        icon = 'fa-info-circle';
        content = `
        <div class="info-content">
            <span class="info-badge">üì∞ Agregador de Not√≠cias</span>
            
            <div class="info-section">
                <h3><i class="fas fa-bullhorn"></i> Descri√ß√£o</h3>
                <p>Agregador independente de not√≠cias de Mo√ßambique, reunindo conte√∫dos de v√°rias fontes confi√°veis em tempo real. A plataforma tem como objetivo facilitar o acesso √† informa√ß√£o de qualidade sobre Mo√ßambique.</p>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-newspaper"></i> Fontes Inclu√≠das</h3>
                <ul>
                    <li><strong>O Pa√≠s</strong> - Jornal de refer√™ncia nacional</li>
                    <li><strong>Jornal Not√≠cias</strong> - Not√≠cias di√°rias</li>
                    <li><strong>Canal de Mo√ßambique</strong> - An√°lises e reportagens</li>
                    <li><strong>Carta de Mo√ßambique</strong> - Pol√≠tica e economia</li>
                    <li><strong>Club of Mozambique</strong> - Neg√≥cios e investimentos</li>
                    <li><strong>Stop</strong> - Not√≠cias gerais</li>
                    <li><strong>Zitamar News</strong> - An√°lises especializadas</li>
                    <li><strong>Time de Todos</strong> - Desporto e cultura</li>
                    <li><strong>JornalMZ</strong> - Not√≠cias diversas</li>
                    <li><strong>Checka</strong> - Fact-checking e an√°lises</li>
                </ul>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-tags"></i> Categorias</h3>
                <p>As not√≠cias s√£o automaticamente classificadas em 7 categorias principais:</p>
                <div class="features-grid">
                    <div class="feature-item">
                        <i class="fas fa-users"></i>
                        <span>Sociedade</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-landmark"></i>
                        <span>Pol√≠tica</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Economia</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-futbol"></i>
                        <span>Esportes</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-paint-brush"></i>
                        <span>Cultura</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-heartbeat"></i>
                        <span>Sa√∫de</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-laptop"></i>
                        <span>Tecnologia</span>
                    </div>
                </div>
            </div>
            
            <div class="info-highlight">
                <p><i class="fas fa-lightbulb"></i> <strong>Nota Importante:</strong> Esta √© uma plataforma independente e n√£o possui afilia√ß√£o oficial com as fontes de not√≠cias listadas. O conte√∫do √© agregado automaticamente das fontes originais.</p>
            </div>
        </div>
        `;
    } else if (type === 'contato') {
        title = 'Contacto';
        icon = 'fa-envelope';
        content = `
        <div class="info-content">
            <span class="info-badge">üìû Entre em Contacto</span>
            
            <div class="info-section">
                <h3><i class="fas fa-headset"></i> Canais de Atendimento</h3>
                <p>Temos v√°rios canais dispon√≠veis para o atender:</p>
                
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <div>
                            <strong>Email Principal</strong><br>
                            <a href="mailto:claudioarmando001@gmail.com" class="contact-link">claudioarmando001@gmail.com</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <div>
                            <strong>Telefone/WhatsApp</strong><br>
                            <a href="tel:+258869667677" class="contact-link">+258 869 667 677</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <strong>Hor√°rio de Atendimento</strong><br>
                            Seg-Sex: 08:00 - 18:00<br>
                            S√°bado: 09:00 - 13:00
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h3><i class="fab fa-whatsapp"></i> Canal Oficial WhatsApp</h3>
                <p>Receba as principais not√≠cias diretamente no seu WhatsApp:</p>
                <button class="social-btn whatsapp" onclick="openWhatsAppChannel()">
                    <i class="fab fa-whatsapp"></i> Entrar no Canal
                </button>
                <p style="font-size: 13px; color: #666; margin-top: 10px;">Receba atualiza√ß√µes em tempo real sem custos adicionais.</p>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-comments"></i> A√ß√µes R√°pidas</h3>
                <div class="social-links">
                    <button class="social-btn email" onclick="window.open('mailto:claudioarmando001@gmail.com?subject=Contacto%20Jornal%20Mo√ßambique', '_blank')">
                        <i class="fas fa-envelope"></i> Enviar Email
                    </button>
                    <button class="social-btn whatsapp" onclick="window.open('https://wa.me/258869667677?text=Ol√°%20Jornal%20Mo√ßambique,%20gostaria%20de%20mais%20informa√ß√µes', '_blank')">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="social-btn phone" onclick="window.location.href='tel:+258869667677'">
                        <i class="fas fa-phone"></i> Ligar Agora
                    </button>
                </div>
            </div>
            
            <div class="info-highlight">
                <p><i class="fas fa-clock"></i> <strong>Resposta R√°pida:</strong> Respondemos a todos os contactos em at√© 24 horas √∫teis.</p>
            </div>
        </div>
        `;
    }
    
    // Atualiza t√≠tulo e √≠cone da modal
    modalTitle.textContent = title;
    modalIcon.className = `fas ${icon}`;
    document.getElementById("info-modal-body").innerHTML = content;
    
    // Mostra a modal
    infoModal.style.display = "flex";
    
    // Adiciona efeito de entrada
    setTimeout(() => {
        document.getElementById("info-modal-content").style.transform = "translateY(0)";
    }, 10);
}

function closeInfoModal() {
    infoModal.style.display = "none";
}

// Event Listeners para a modal info
infoModalClose.addEventListener('click', closeInfoModal);

infoModal.addEventListener('click', (e) => {
    if (e.target.id === 'info-modal') {
        closeInfoModal();
    }
});

/* ========== RENDERIZA√á√ÉO EM TEMPO REAL ========== */

// Determina categoria baseada no conte√∫do da not√≠cia
function determineCategory(title, content) {
    const text = (title + ' ' + content).toLowerCase();
    
    // Palavras-chave para cada categoria
    const keywords = {
        'sociedade': ['sociedade', 'social', 'comunidade', 'educa√ß√£o', 'escola', 'universidade', 
                     'aluno', 'professor', 'fam√≠lia', 'habita√ß√£o', 'bairro', 'comunit√°rio'],
        'pol√≠tica': ['pol√≠tica', 'pol√≠tico', 'governo', 'presidente', 'ministro', 'elei√ß√µes', 
                    'partido', 'parlamento', 'assembleia', 'diplomacia', 'embaixada', 'voto'],
        'economia': ['economia', 'econ√¥mico', 'neg√≥cio', 'empresa', 'investimento', 'banco', 
                    'finan√ßas', 'mercado', 'bolsa', 'imposto', 'crescimento', 'infla√ß√£o'],
        'esportes': ['esporte', 'futebol', 'jogo', 'atleta', 'campeonato', 'liga', 
                    'competi√ß√£o', 'gin√°sio', 'treino', 'sele√ß√£o', 'est√°dio', 'golo'],
        'cultura': ['cultura', 'cultural', 'arte', 'm√∫sica', 'teatro', 'cinema', 
                   'literatura', 'poesia', 'tradi√ß√£o', 'festival', 'exposi√ß√£o', 'artista'],
        'sa√∫de': ['sa√∫de', 'hospital', 'm√©dico', 'enfermeiro', 'doen√ßa', 'vacina', 
                 'tratamento', 'cl√≠nica', 'epidemia', 'pandemia', 'medicamento', 'cirurgia'],
        'tecnologia': ['tecnologia', 'tecnol√≥gico', 'internet', 'digital', 'aplicativo', 
                      'software', 'startup', 'inova√ß√£o', 'ci√™ncia', 'pesquisa', 'rob√¥', 'IA']
    };
    
    // Conta ocorr√™ncias para cada categoria
    let scores = {};
    Object.keys(keywords).forEach(cat => {
        scores[cat] = 0;
        keywords[cat].forEach(keyword => {
            if (text.includes(keyword)) {
                scores[cat]++;
            }
        });
    });
    
    // Encontra categoria com maior pontua√ß√£o
    let maxScore = 0;
    let selectedCategory = 'sociedade'; // default
    
    Object.keys(scores).forEach(cat => {
        if (scores[cat] > maxScore) {
            maxScore = scores[cat];
            selectedCategory = cat;
        }
    });
    
    // Se nenhuma palavra-chave foi encontrada, usa heur√≠stica baseada no t√≠tulo
    if (maxScore === 0) {
        if (title.toLowerCase().includes('futebol') || title.toLowerCase().includes('desporto')) {
            return 'esportes';
        } else if (title.toLowerCase().includes('econ') || title.toLowerCase().includes('neg√≥cio')) {
            return 'economia';
        } else if (title.toLowerCase().includes('arte') || title.toLowerCase().includes('m√∫sica')) {
            return 'cultura';
        } else if (title.toLowerCase().includes('hospital') || title.toLowerCase().includes('m√©dico')) {
            return 'sa√∫de';
        } else if (title.toLowerCase().includes('tech') || title.toLowerCase().includes('digital')) {
            return 'tecnologia';
        } else {
            // Distribui√ß√£o aleat√≥ria controlada para diversidade
            const categories = Object.keys(CATEGORIES).filter(cat => cat !== 'todos');
            return categories[Math.floor(Math.random() * categories.length)];
        }
    }
    
    return selectedCategory;
}

// Renderiza uma √∫nica not√≠cia imediatamente
function renderSingleNews(article) {
    if (container.querySelector(`[data-hash="${article.hash}"]`)) return;
    
    const category = article.category || determineCategory(article.title, article.content);
    article.category = category; // Armazena a categoria determinada
    
    const newsLink = generateNewsLink(article);
    
    const c = document.createElement("a");
    c.className = "card";
    c.dataset.hash = article.hash;
    c.dataset.category = category;
    c.href = newsLink;
    c.style.textDecoration = 'none';
    c.style.color = 'inherit';
    c.innerHTML = `
    <div class="card-text">
        <div class="card-title">${article.title}</div>
        <div class="card-meta">
            <span class="source-tag">${article.source}</span>
            <span class="category-tag ${CATEGORIES[category].class}">${CATEGORIES[category].name}</span>
            <span>${formatDate(article.date)}</span>
        </div>
    </div>
    <img src="${article.image}" loading="lazy" alt="${article.title}" onerror="this.src='https://via.placeholder.com/120x85/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
    `;
    
    // Encontra a posi√ß√£o correta para manter ordena√ß√£o por data (mais recente primeiro)
    let inserted = false;
    const cards = container.querySelectorAll('.card');
    
    for (let i = 0; i < cards.length; i++) {
        const cardDate = new Date(cards[i].dataset.date || 0);
        const newDate = new Date(article.date);
        
        if (newDate > cardDate) {
            container.insertBefore(c, cards[i]);
            inserted = true;
            break;
        }
    }
    
    // Se n√£o encontrou posi√ß√£o (ou √© a primeira not√≠cia), adiciona no final
    if (!inserted) {
        container.appendChild(c);
    }
    
    // Armazena a data como atributo para futuras ordena√ß√µes
    c.dataset.date = article.date;
    
    // Salva no localStorage para acesso na p√°gina de leitura
    saveNewsToLocalStorage(article);
}

/* ========== LOCALSTORAGE FUNCTIONS ========== */

function saveNewsToLocalStorage(article) {
    try {
        // Pega not√≠cias existentes
        let savedNews = JSON.parse(localStorage.getItem('cld_news') || '[]');
        
        // Verifica se j√° existe
        const exists = savedNews.some(n => n.hash === article.hash);
        
        if (!exists) {
            // Adiciona a nova not√≠cia
            savedNews.push(article);
            
            // Mant√©m apenas as 200 not√≠cias mais recentes
            if (savedNews.length > 200) {
                savedNews = savedNews.slice(-200);
            }
            
            // Salva no localStorage
            localStorage.setItem('cld_news', JSON.stringify(savedNews));
        }
    } catch (e) {
        console.error('Erro ao salvar no localStorage:', e);
    }
}

/* ========== CARREGAMENTO DE NOT√çCIAS EM TEMPO REAL ========== */

// Processa artigos de uma fonte e renderiza imediatamente
async function processSourceArticles(source, articles) {
    const newArticles = [];
    
    for (const article of articles) {
        const hash = (article.title.rendered + article.link).replace(/\W/g, "");
        
        if (hashes.has(hash)) continue;
        
        hashes.add(hash);
        
        const newsItem = {
            title: article.title.rendered,
            content: article.content.rendered,
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   "https://via.placeholder.com/300x200",
            source: source.name,
            date: article.date || article.modified,
            link: article.link,
            hash: hash
        };
        
        newArticles.push(newsItem);
    }
    
    // Ordena as novas not√≠cias por data (mais recente primeiro)
    newArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Adiciona √†s listas e renderiza cada uma
    for (const newsItem of newArticles) {
        news.push(newsItem);
        filteredNews.push(newsItem);
        
        // Renderiza IMEDIATAMENTE
        renderSingleNews(newsItem);
        
        // Pequena pausa para anima√ß√£o suave
        await new Promise(resolve => setTimeout(resolve, 30));
    }
}

// Carrega not√≠cias de uma fonte espec√≠fica
async function loadSource(source) {
    if (!source.hasMore || source.isFetching) return;
    
    source.isFetching = true;
    
    try {
        const url = `${source.baseUrl}?_embed&per_page=${BATCH_SIZE}&page=${source.currentPage}&t=${Date.now()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            if (response.status === 400) {
                source.hasMore = false;
            }
            throw new Error(`Erro ao buscar ${source.name}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
            source.hasMore = false;
            return;
        }
        
        source.currentPage++;
        
        // Processa e renderiza as not√≠cias imediatamente
        await processSourceArticles(source, data);
        
    } catch (error) {
        console.error(`Erro ao carregar ${source.name}:`, error);
        source.hasMore = false;
    } finally {
        source.isFetching = false;
        
        // Verifica se todas as fontes foram carregadas
        checkAllSourcesLoaded();
    }
}

// Carrega not√≠cias de todas as fontes simultaneamente
async function loadAllSources() {
    // Limpa dados anteriores
    news = [];
    filteredNews = [];
    hashes.clear();
    allSourcesLoaded = false;
    
    // Limpa o container
    container.innerHTML = '';
    
    // Reseta fontes
    sources.forEach(source => {
        source.currentPage = 1;
        source.hasMore = true;
        source.isFetching = false;
    });
    
    // Carrega todas as fontes em paralelo
    const promises = sources.map(source => loadSource(source));
    
    // Aguarda todas as fontes terminarem o primeiro carregamento
    await Promise.allSettled(promises);
    
    // Reordena todas as not√≠cias por data (mais recente primeiro)
    reorderAllNewsByDate();
}

// Reordena TODAS as not√≠cias por data (mais recente primeiro)
function reorderAllNewsByDate() {
    // Ordena os arrays
    news.sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredNews.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Limpa e re-renderiza em ordem
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

// Carrega mais not√≠cias (scroll infinito)
async function loadMoreNews() {
    if (isLoadingMore || allSourcesLoaded) return;
    
    isLoadingMore = true;
    infiniteLoader.style.display = 'block';
    
    let anySourceHasMore = false;
    const promises = [];
    
    // Carrega de todas as fontes que ainda t√™m conte√∫do
    for (const source of sources) {
        if (source.hasMore) {
            promises.push(loadSource(source));
            
            if (source.hasMore) {
                anySourceHasMore = true;
            }
        }
    }
    
    // Aguarda todas as fontes terminarem
    await Promise.allSettled(promises);
    
    // Verifica se todas as fontes foram completamente carregadas
    allSourcesLoaded = !anySourceHasMore;
    
    isLoadingMore = false;
    infiniteLoader.style.display = 'none';
}

function checkAllSourcesLoaded() {
    allSourcesLoaded = sources.every(source => !source.hasMore);
    
    if (allSourcesLoaded) {
        infiniteLoader.style.display = 'none';
    }
}

/* ========== CONTROLES ========== */

function manualRefresh() {
    // Limpa o container
    container.innerHTML = '';
    
    // Fecha modais se estiverem abertas
    closeInfoModal();
    
    // Recarrega tudo
    loadAllSources();
}

function openWhatsAppChannel() {
    window.open(WHATSAPP_CHANNEL_URL, '_blank', 'noopener,noreferrer');
    closeInfoModal();
}

/* ========== SCROLL INFINITO ========== */

let scrollTimeout;
const SCROLL_THRESHOLD = 300;

window.addEventListener("scroll", () => {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    
    scrollTimeout = setTimeout(() => {
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - SCROLL_THRESHOLD;
        
        if (scrollPosition >= threshold && !isLoadingMore && !allSourcesLoaded) {
            loadMoreNews();
        }
    }, 150);
});

/* ========== INICIALIZA√á√ÉO ========== */

// Inicia o carregamento
loadAllSources();

// Atualiza a cada 5 minutos se a p√°gina estiver vis√≠vel
setInterval(() => {
    if (document.visibilityState === 'visible' && !isLoadingMore) {
        // Carrega apenas se o usu√°rio estiver no final da p√°gina
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - 500;
        
        if (scrollPosition >= threshold) {
            loadMoreNews();
        }
    }
}, 300000);

/* ========== ATALHOS DE TECLADO ========== */

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeInfoModal();
        closeSidebar();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById("search-input").focus();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        manualRefresh();
    }
});

// Inicializa a contagem de not√≠cias por categoria
function updateCategoryStats() {
    const stats = {};
    Object.keys(CATEGORIES).forEach(cat => {
        if (cat !== 'todos') {
            stats[cat] = 0;
        }
    });
    
    news.forEach(article => {
        if (article.category && stats[article.category] !== undefined) {
            stats[article.category]++;
        }
    });
    
    // Atualiza os bot√µes com contagem
    document.querySelectorAll('.category-btn').forEach(btn => {
        const cat = btn.getAttribute('onclick')?.match(/filterByCategory\('([^']+)'\)/)?.[1];
        if (cat && cat !== 'todos' && stats[cat]) {
            btn.innerHTML = `${CATEGORIES[cat].name} <span style="background: white; color: #1a73e8; padding: 1px 6px; border-radius: 10px; font-size: 11px;">${stats[cat]}</span>`;
        }
    });
}

// Atualiza estat√≠sticas periodicamente
setInterval(updateCategoryStats, 10000);
</script>
</body>
</html>