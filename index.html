<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notícias CLD - Agregador de Notícias</title>
<meta name="description" content="Agregador de notícias de Moçambique em tempo real">
<meta name="robots" content="index, follow">
<style>
/* [Todo o CSS anterior permanece igual] */
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<!-- [Estrutura HTML anterior permanece igual] -->

<script>
// ========== VARIÁVEIS GLOBAIS ==========
let news = [];
let filteredNews = [];
let hashes = new Set();
const BATCH_SIZE = 15;
let isLoadingMore = false;
let allSourcesLoaded = false;
let currentCategory = 'todos';

// CATEGORIAS DISPONÍVEIS
const CATEGORIES = {
    'todos': { name: 'Todos', color: '#1a73e8' },
    'sociedade': { name: 'Sociedade', color: '#2e7d32', class: 'sociedade-tag' },
    'política': { name: 'Política', color: '#c62828', class: 'politica-tag' },
    'economia': { name: 'Economia', color: '#ef6c00', class: 'economia-tag' },
    'esportes': { name: 'Esportes', color: '#1565c0', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', color: '#7b1fa2', class: 'cultura-tag' },
    'saúde': { name: 'Saúde', color: '#00796b', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', color: '#37474f', class: 'tech-tag' }
};

// ELEMENTOS DOM
const container = document.getElementById("news-container");
const infiniteLoader = document.getElementById("infinite-loader");

// CONSTANTES
const WHATSAPP_CHANNEL_URL = "https://whatsapp.com/channel/0029Vb7BeBI7T8bRTbjcsN0t";

// FONTES DE NOTÍCIAS
const sources = [
    { 
        name: "O País", 
        baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Time de Todos",
        baseUrl: "https://timesdetodos.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Integrity", 
        baseUrl: "https://integritymagazine.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Jornal Notícias",
        baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Savana", 
        baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "JornalMZ",
        baseUrl: "https://jornalmz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Checka",
        baseUrl: "https://checka.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Canal de Moçambique",
        baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Stop",
        baseUrl: "https://www.stop.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Club of Mozambique",
        baseUrl: "https://clubofmozambique.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Zitamar News",
        baseUrl: "https://www.zitamar.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Carta de Moçambique", 
        baseUrl: "https://cartamz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    }
];

// ========== FUNÇÕES DE UTILIDADE ==========

// Gerar hash único para a notícia - CORRIGIDO
function generateNewsHash(article) {
    // Usar link como base para o hash para garantir consistência
    const link = article.link || article.guid?.rendered || '';
    const title = article.title?.rendered || '';
    
    // Criar hash mais consistente
    const hashString = link + title;
    let hash = 0;
    for (let i = 0; i < hashString.length; i++) {
        const char = hashString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    
    return Math.abs(hash).toString(36).substring(0, 12);
}

// Salvar notícia no cache - MELHORADO
function saveToCache(article, sourceName) {
    try {
        const hash = generateNewsHash(article);
        const newsItem = {
            id: hash,
            title: article.title?.rendered || article.title || '',
            content: article.content?.rendered || article.content || '',
            excerpt: article.excerpt?.rendered || article.excerpt || '',
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   article.featured_media_url ||
                   "https://via.placeholder.com/300x200",
            source: sourceName || "Desconhecido",
            date: article.date || article.modified || new Date().toISOString(),
            link: article.link || article.guid?.rendered || '',
            originalData: article // Salvar dados originais completos
        };
        
        // Salvar no localStorage
        localStorage.setItem(`news_${hash}`, JSON.stringify(newsItem));
        
        // Adicionar à lista geral de notícias em cache
        let cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        if (!cachedNews.includes(hash)) {
            cachedNews.push(hash);
            // Manter apenas 200 notícias em cache
            if (cachedNews.length > 200) {
                const removed = cachedNews.shift();
                localStorage.removeItem(`news_${removed}`);
            }
            localStorage.setItem('cached_news', JSON.stringify(cachedNews));
        }
        
        return hash;
    } catch (e) {
        console.error('Erro ao salvar no cache:', e);
        return null;
    }
}

// ========== FUNÇÕES DE INTERFACE ==========
// [Funções de interface permanecem iguais]

// ========== RENDERIZAÇÃO ==========

function determineCategory(title, content) {
    const text = ((title || '') + ' ' + (content || '')).toLowerCase();
    
    if (text.includes('futebol') || text.includes('desporto') || text.includes('jogo') || text.includes('atleta')) {
        return 'esportes';
    } else if (text.includes('economia') || text.includes('negócio') || text.includes('empresa') || text.includes('investimento')) {
        return 'economia';
    } else if (text.includes('política') || text.includes('governo') || text.includes('presidente') || text.includes('ministro')) {
        return 'política';
    } else if (text.includes('saúde') || text.includes('hospital') || text.includes('médico') || text.includes('enfermeiro')) {
        return 'saúde';
    } else if (text.includes('tecnologia') || text.includes('digital') || text.includes('internet') || text.includes('aplicativo')) {
        return 'tecnologia';
    } else if (text.includes('cultura') || text.includes('arte') || text.includes('música') || text.includes('teatro')) {
        return 'cultura';
    } else {
        return 'sociedade';
    }
}

function renderSingleNews(article) {
    if (!article || !article.hash) return;
    
    const existingCard = container.querySelector(`[data-hash="${article.hash}"]`);
    if (existingCard) return;
    
    const category = article.category || determineCategory(article.title, article.content);
    article.category = category;
    
    // GERAR LINK MELHORADO - INCLUINDO DADOS ADICIONAIS
    const newsLink = `leitura.html?n=${article.hash}&t=${encodeURIComponent(article.title.substring(0, 50))}&s=${encodeURIComponent(article.source)}`;
    
    const c = document.createElement("a");
    c.className = "card";
    c.dataset.hash = article.hash;
    c.dataset.category = category;
    c.href = newsLink;
    c.style.textDecoration = 'none';
    c.style.color = 'inherit';
    c.innerHTML = `
    <div class="card-text">
        <div class="card-title">${article.title}</div>
        <div class="card-meta">
            <span class="source-tag">${article.source}</span>
            <span class="category-tag ${CATEGORIES[category]?.class || 'sociedade-tag'}">${CATEGORIES[category]?.name || 'Sociedade'}</span>
            <span>${formatDate(article.date)}</span>
        </div>
    </div>
    <img src="${article.image}" loading="lazy" alt="${article.title}" 
         onerror="this.src='https://via.placeholder.com/120x85/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
    `;
    
    let inserted = false;
    const cards = container.querySelectorAll('.card');
    
    for (let i = 0; i < cards.length; i++) {
        const cardDate = new Date(cards[i].dataset.date || 0);
        const newDate = new Date(article.date);
        
        if (newDate > cardDate) {
            container.insertBefore(c, cards[i]);
            inserted = true;
            break;
        }
    }
    
    if (!inserted) {
        container.appendChild(c);
    }
    
    c.dataset.date = article.date;
}

// ========== CARREGAMENTO DE NOTÍCIAS ==========

async function processSourceArticles(source, articles) {
    const newArticles = [];
    
    for (const article of articles) {
        if (!article || !article.link) continue;
        
        const hash = generateNewsHash(article);
        
        if (hashes.has(hash)) continue;
        
        hashes.add(hash);
        
        const newsItem = {
            title: article.title?.rendered || article.title || '',
            content: article.content?.rendered || article.content || '',
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   article.featured_media_url ||
                   "https://via.placeholder.com/300x200",
            source: source.name,
            date: article.date || article.modified || new Date().toISOString(),
            link: article.link || article.guid?.rendered || '',
            hash: hash,
            originalData: article
        };
        
        // Salvar no cache imediatamente
        saveToCache(article, source.name);
        
        newArticles.push(newsItem);
    }
    
    newArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    for (const newsItem of newArticles) {
        news.push(newsItem);
        filteredNews.push(newsItem);
        
        renderSingleNews(newsItem);
        
        await new Promise(resolve => setTimeout(resolve, 30));
    }
}

async function loadSource(source) {
    if (!source.hasMore || source.isFetching) return;
    
    source.isFetching = true;
    
    try {
        const url = `${source.baseUrl}?_embed&per_page=${BATCH_SIZE}&page=${source.currentPage}&t=${Date.now()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            if (response.status === 400) {
                source.hasMore = false;
            }
            console.warn(`Erro ao buscar ${source.name}:`, response.status);
            return;
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
            source.hasMore = false;
            return;
        }
        
        source.currentPage++;
        
        await processSourceArticles(source, data);
        
    } catch (error) {
        console.error(`Erro ao carregar ${source.name}:`, error);
        source.hasMore = false;
    } finally {
        source.isFetching = false;
        checkAllSourcesLoaded();
    }
}

async function loadAllSources() {
    news = [];
    filteredNews = [];
    hashes.clear();
    allSourcesLoaded = false;
    
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Carregando notícias...</div>';
    
    sources.forEach(source => {
        source.currentPage = 1;
        source.hasMore = true;
        source.isFetching = false;
    });
    
    const promises = sources.map(source => loadSource(source));
    await Promise.allSettled(promises);
    
    reorderAllNewsByDate();
}

function reorderAllNewsByDate() {
    news.sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredNews.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    container.innerHTML = '';
    if (filteredNews.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">Nenhuma notícia encontrada.</div>';
    } else {
        filteredNews.forEach(article => {
            renderSingleNews(article);
        });
    }
}

// [Restante do código permanece igual...]

// ========== INICIALIZAÇÃO ==========

document.addEventListener('DOMContentLoaded', function() {
    loadAllSources();
    
    // Carregar notícias do cache como fallback
    setTimeout(() => {
        if (news.length === 0) {
            loadNewsFromCache();
        }
    }, 2000);
});

function loadNewsFromCache() {
    try {
        const cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        const cachedItems = [];
        
        cachedNews.forEach(hash => {
            const item = localStorage.getItem(`news_${hash}`);
            if (item) {
                const newsItem = JSON.parse(item);
                cachedItems.push({
                    ...newsItem,
                    hash: hash
                });
            }
        });
        
        if (cachedItems.length > 0) {
            cachedItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            cachedItems.forEach(article => {
                if (!hashes.has(article.hash)) {
                    hashes.add(article.hash);
                    news.push(article);
                    filteredNews.push(article);
                    renderSingleNews(article);
                }
            });
            
            if (news.length > 0) {
                console.log(`Carregadas ${news.length} notícias do cache`);
            }
        }
    } catch (e) {
        console.error('Erro ao carregar do cache:', e);
    }
}

// [Restante do código permanece igual...]
</script>
</body>
</html>