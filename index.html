<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Not√≠cias CLD - Agregador de Not√≠cias</title>
<meta name="description" content="Agregador de not√≠cias de Mo√ßambique em tempo real">
<meta name="robots" content="index, follow">
<style>
/* CSS OTIMIZADO - Minificado inline */
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f5f7fa;margin:0;color:#1a1a1a;line-height:1.4;overflow-x:hidden}header{background:linear-gradient(135deg,#1a73e8,#0d47a1);color:#fff;padding:16px 20px;text-align:center;font-size:20px;font-weight:700;position:sticky;top:0;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.15)}.header-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.9);color:#1a73e8;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;transition:all .2s;backdrop-filter:blur(10px)}.header-btn:hover{background:#fff;transform:translateY(-50%) scale(1.05)}#menu-btn{left:20px}#refresh-btn{right:20px}#sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:9998;animation:fadeIn .2s ease}#sidebar{position:fixed;top:0;left:-300px;width:300px;height:100vh;background:#fff;box-shadow:2px 0 12px rgba(0,0,0,.15);padding:20px;transition:transform .25s cubic-bezier(0.4,0,0.2,1);z-index:9999;overflow-y:auto;-webkit-overflow-scrolling:touch}#sidebar.open{transform:translateX(300px)}.categories{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin:20px 0}.category-btn{background:#f0f7ff;border:2px solid transparent;color:#1a73e8;padding:10px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s;text-align:center}.category-btn:hover{background:#e3f2fd;transform:translateY(-1px)}.category-btn.active{background:#1a73e8;color:#fff;border-color:#1a73e8}.search-container{max-width:1000px;margin:20px auto;padding:0 20px}#search-input{width:100%;padding:14px 20px;border-radius:12px;border:2px solid #e1e5eb;font-size:16px;background:#fff;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.05)}#search-input:focus{outline:none;border-color:#1a73e8;box-shadow:0 0 0 3px rgba(26,115,232,.15)}#news-container{max-width:1000px;margin:0 auto;padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}@media(max-width:768px){#news-container{grid-template-columns:1fr;padding:15px}}.card{background:#fff;border-radius:16px;padding:0;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.08);cursor:pointer;transition:all .2s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;height:100%;position:relative;border:1px solid rgba(0,0,0,.05)}.card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,.12);border-color:#1a73e8}.card img{width:100%;height:180px;object-fit:cover;display:block;background:linear-gradient(135deg,#667eea,#764ba2)}.card-text{padding:20px;flex:1;display:flex;flex-direction:column}.card-title{font-size:17px;font-weight:700;color:#1a1a1a;margin-bottom:12px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}.card-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:auto;padding-top:15px;border-top:1px solid #f0f0f0}.source-tag{background:#e8f0fe;color:#1a73e8;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700}.category-tag{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700}.sociedade-tag{background:#e8f5e9;color:#2e7d32}.politica-tag{background:#ffebee;color:#c62828}.economia-tag{background:#fff3e0;color:#ef6c00}.esportes-tag{background:#e3f2fd;color:#1565c0}.cultura-tag{background:#f3e5f5;color:#7b1fa2}.saude-tag{background:#e0f2f1;color:#00796b}.tech-tag{background:#eceff1;color:#37474f}#infinite-loader{text-align:center;padding:30px 20px}#infinite-spinner{display:inline-block;width:24px;height:24px;border:3px solid rgba(26,115,232,.1);border-top:3px solid #1a73e8;border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.loading-shimmer{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}.card.skeleton .card-title{height:20px;width:90%;margin-bottom:10px}.card.skeleton .card-meta span{height:16px;width:60px}@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}.toast{position:fixed;bottom:20px;right:20px;background:#323232;color:#fff;padding:12px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:10000;animation:slideUp .3s ease;display:none;max-width:320px}.toast.success{background:#4caf50}.toast.error{background:#f44336}.toast.info{background:#2196f3}@keyframes slideUp{from{transform:translateY(100px);opacity:0}to{transform:translateY(0);opacity:1}}.offline-banner{position:sticky;top:0;background:#ff9800;color:#fff;text-align:center;padding:10px;font-size:14px;font-weight:600;z-index:1001;animation:slideDown .3s ease}@keyframes slideDown{from{transform:translateY(-100%);opacity:0}to{transform:translateY(0);opacity:1}}.empty-state{text-align:center;padding:60px 20px}.empty-state i{font-size:64px;color:#b0bec5;margin-bottom:20px}.empty-state h3{color:#546e7a;margin-bottom:10px}.empty-state p{color:#90a4ae;max-width:400px;margin:0 auto}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" as="style">
</head>
<body>
<header>
<button class="header-btn" id="menu-btn" aria-label="Abrir menu">‚ò∞</button>
Not√≠cias CLD
<button class="header-btn" id="refresh-btn" aria-label="Atualizar not√≠cias">‚Üª</button>
</header>

<div id="sidebar-overlay"></div>
<aside id="sidebar" aria-label="Menu lateral">
<button id="close-sidebar" aria-label="Fechar menu" style="position:absolute;top:15px;right:15px;background:none;border:none;font-size:20px;cursor:pointer;color:#666">‚úñ</button>
<h2 style="margin-bottom:20px;color:#1a73e8">Categorias</h2>
<div class="categories">
<button class="category-btn active" data-category="todos">Todos</button>
<button class="category-btn" data-category="sociedade">Sociedade</button>
<button class="category-btn" data-category="pol√≠tica">Pol√≠tica</button>
<button class="category-btn" data-category="economia">Economia</button>
<button class="category-btn" data-category="esportes">Esportes</button>
<button class="category-btn" data-category="cultura">Cultura</button>
<button class="category-btn" data-category="sa√∫de">Sa√∫de</button>
<button class="category-btn" data-category="tecnologia">Tecnologia</button>
</div>
</aside>

<div class="search-container">
<input id="search-input" placeholder="üîç Buscar not√≠cias..." aria-label="Buscar not√≠cias">
</div>

<main id="news-container" role="main">
<!-- Skeleton loading -->
<div class="card skeleton loading-shimmer">
    <div class="loading-shimmer" style="height:180px;border-radius:16px 16px 0 0"></div>
    <div class="card-text">
        <div class="card-title loading-shimmer"></div>
        <div class="card-meta">
            <span class="loading-shimmer"></span>
            <span class="loading-shimmer"></span>
        </div>
    </div>
</div>
<!-- Duplicar skeleton para visual inicial -->
<div class="card skeleton loading-shimmer">
    <div class="loading-shimmer" style="height:180px;border-radius:16px 16px 0 0"></div>
    <div class="card-text">
        <div class="card-title loading-shimmer"></div>
        <div class="card-meta">
            <span class="loading-shimmer"></span>
            <span class="loading-shimmer"></span>
        </div>
    </div>
</div>
</main>

<div id="infinite-loader" style="display:none">
<div id="infinite-spinner"></div>
<div>Carregando mais not√≠cias...</div>
</div>

<div class="toast" id="toast"></div>

<script>
// ========== CONFIGURA√á√ÉO DE PERFORMANCE ==========
'use strict';

// Configura√ß√µes
const CONFIG = {
    BATCH_SIZE: 20,
    CACHE_SIZE: 500,
    DEBOUNCE_DELAY: 150,
    THROTTLE_DELAY: 50,
    SCROLL_THRESHOLD: 300,
    REQUEST_TIMEOUT: 5000,
    MAX_RETRIES: 2
};

// Inicializa√ß√£o otimizada
const state = {
    news: new Map(), // Usar Map para O(1) lookup
    filteredNews: [],
    activeCategory: 'todos',
    searchQuery: '',
    isLoading: false,
    page: 1,
    hasMore: true,
    lastScrollY: 0,
    scrollTimer: null,
    requestQueue: new Set(),
    cache: new Map(),
    offline: !navigator.onLine
};

// Cache IndexedDB para grandes dados
let db;
const initDB = () => {
    return new Promise((resolve) => {
        if (!window.indexedDB) {
            console.warn('IndexedDB n√£o suportado, usando localStorage');
            resolve(false);
            return;
        }
        
        const request = indexedDB.open('newsCache', 1);
        
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains('news')) {
                db.createObjectStore('news', { keyPath: 'hash' });
            }
            if (!db.objectStoreNames.contains('metadata')) {
                db.createObjectStore('metadata', { keyPath: 'key' });
            }
        };
        
        request.onsuccess = (e) => {
            db = e.target.result;
            console.log('IndexedDB inicializado');
            resolve(true);
        };
        
        request.onerror = () => resolve(false);
    });
};

// Fontes otimizadas com fallbacks
const NEWS_SOURCES = [
    {
        id: 'opais',
        name: 'O Pa√≠s',
        url: 'https://www.opais.co.mz/wp-json/wp/v2/posts',
        priority: 1
    },
    {
        id: 'jornalnoticias',
        name: 'Jornal Not√≠cias',
        url: 'https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts',
        priority: 1
    },
    {
        id: 'cartamz',
        name: 'Carta de Mo√ßambique',
        url: 'https://cartamz.com/wp-json/wp/v2/posts',
        priority: 2
    },
    {
        id: 'clubmoz',
        name: 'Club of Mozambique',
        url: 'https://clubofmozambique.com/wp-json/wp/v2/posts',
        priority: 2
    },
    {
        id: 'savana',
        name: 'Savana',
        url: 'https://savana.co.mz/wp-json/wp/v2/posts',
        priority: 3
    }
];

// ========== FUN√á√ïES DE PERFORMANCE ==========

// Debounce otimizado
const debounce = (fn, delay) => {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
    };
};

// Throttle otimizado
const throttle = (fn, limit) => {
    let inThrottle;
    return (...args) => {
        if (!inThrottle) {
            fn(...args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
};

// Hash r√°pido com xxHash simplificado
const fastHash = (str) => {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return Math.abs(hash).toString(36);
};

// Gerar ID √∫nico para not√≠cia
const generateNewsId = (article, source) => {
    const key = `${source.id}_${article.id || article.link}`;
    return fastHash(key);
};

// ========== CACHE OTIMIZADO ==========

const cacheManager = {
    async saveNews(articles) {
        const savePromises = articles.map(article => {
            const key = `news_${article.id}`;
            state.cache.set(key, article);
            
            // Salvar tamb√©m no localStorage para fallback r√°pido
            try {
                localStorage.setItem(key, JSON.stringify(article));
            } catch (e) {
                // Se localStorage cheio, limpar alguns itens
                if (e.name === 'QuotaExceededError') {
                    this.cleanOldCache();
                    localStorage.setItem(key, JSON.stringify(article));
                }
            }
        });
        
        await Promise.allSavePromises;
        
        // Atualizar √≠ndice no IndexedDB se dispon√≠vel
        if (db) {
            const transaction = db.transaction(['news'], 'readwrite');
            const store = transaction.objectStore('news');
            
            articles.forEach(article => {
                store.put(article);
            });
        }
    },
    
    async getNews(id) {
        // 1. Tentar cache em mem√≥ria
        const cached = state.cache.get(`news_${id}`);
        if (cached) return cached;
        
        // 2. Tentar localStorage
        try {
            const local = localStorage.getItem(`news_${id}`);
            if (local) {
                const article = JSON.parse(local);
                state.cache.set(`news_${id}`, article);
                return article;
            }
        } catch (e) {
            console.warn('Erro ao acessar localStorage:', e);
        }
        
        // 3. Tentar IndexedDB
        if (db) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['news'], 'readonly');
                const store = transaction.objectStore('news');
                const request = store.get(id);
                
                request.onsuccess = () => {
                    if (request.result) {
                        state.cache.set(`news_${id}`, request.result);
                        resolve(request.result);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = () => resolve(null);
            });
        }
        
        return null;
    },
    
    cleanOldCache() {
        // Limpar cache mais antigo
        const keys = Object.keys(localStorage);
        const newsKeys = keys.filter(k => k.startsWith('news_'));
        
        if (newsKeys.length > CONFIG.CACHE_SIZE) {
            // Ordenar por timestamp (se dispon√≠vel) ou remover os mais antigos
            const toRemove = newsKeys.slice(0, newsKeys.length - CONFIG.CACHE_SIZE);
            toRemove.forEach(key => {
                localStorage.removeItem(key);
                state.cache.delete(key);
            });
        }
    },
    
    async prefetchNews() {
        // Pr√©-carregar not√≠cias prov√°veis
        if (state.news.size > 0) {
            const recentNews = Array.from(state.news.values())
                .slice(0, 10)
                .map(n => this.getNews(n.id));
            
            await Promise.all(recentNews);
        }
    }
};

// ========== REQUISI√á√ïES OTIMIZADAS ==========

const fetchWithRetry = async (url, retries = CONFIG.MAX_RETRIES) => {
    for (let i = 0; i <= retries; i++) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT);
            
            const response = await fetch(url, {
                signal: controller.signal,
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache'
                }
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            return await response.json();
        } catch (error) {
            if (i === retries) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
    }
};

const fetchParallel = async (sources) => {
    const fetchPromises = sources.map(async (source) => {
        try {
            const url = `${source.url}?_embed&per_page=${CONFIG.BATCH_SIZE}&page=${state.page}`;
            const data = await fetchWithRetry(url);
            
            return {
                source: source.id,
                data: data || [],
                error: null
            };
        } catch (error) {
            console.warn(`Falha na fonte ${source.name}:`, error);
            return {
                source: source.id,
                data: [],
                error: error.message
            };
        }
    });
    
    return Promise.allSettled(fetchPromises);
};

// ========== PROCESSAMENTO DE DADOS ==========

const processArticles = (articles, source) => {
    return articles.map(article => {
        const id = generateNewsId(article, source);
        
        // Extrair imagem de forma otimizada
        let image = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="200" viewBox="0 0 400 200"%3E%3Crect width="400" height="200" fill="%231a73e8"/%3E%3Ctext x="50%25" y="50%25" font-family="Arial" font-size="24" fill="white" text-anchor="middle" dy=".3em"%3ENOT%C3%8DCIAS CLD%3C/text%3E%3C/svg%3E';
        
        if (article._embedded?.['wp:featuredmedia']?.[0]?.source_url) {
            image = article._embedded['wp:featuredmedia'][0].source_url;
        } else if (article.jetpack_featured_media_url) {
            image = article.jetpack_featured_media_url;
        } else if (article.thumbnail_url) {
            image = article.thumbnail_url;
        }
        
        // Determinar categoria com regex otimizado
        const text = (article.title.rendered + ' ' + article.excerpt?.rendered).toLowerCase();
        let category = 'sociedade';
        
        if (/(futebol|desporto|jogo|atleta|esporte)/i.test(text)) category = 'esportes';
        else if (/(economia|neg√≥cio|empresa|investimento|finan√ßa)/i.test(text)) category = 'economia';
        else if (/(pol√≠tica|governo|presidente|ministro|parlamento)/i.test(text)) category = 'pol√≠tica';
        else if (/(sa√∫de|hospital|m√©dico|enfermeiro|doen√ßa)/i.test(text)) category = 'sa√∫de';
        else if (/(tecnologia|digital|internet|aplicativo|smartphone)/i.test(text)) category = 'tecnologia';
        else if (/(cultura|arte|m√∫sica|teatro|dan√ßa)/i.test(text)) category = 'cultura';
        
        return {
            id,
            title: article.title.rendered || article.title,
            excerpt: article.excerpt?.rendered?.replace(/<[^>]+>/g, '').substring(0, 150) + '...' || '',
            image,
            source: source.name,
            sourceId: source.id,
            date: article.date || new Date().toISOString(),
            timestamp: new Date(article.date || Date.now()).getTime(),
            category,
            url: article.link || `https://${source.name.toLowerCase().replace(/\s/g, '')}.co.mz`,
            priority: source.priority
        };
    });
};

// ========== RENDERIZA√á√ÉO OTIMIZADA ==========

const renderer = {
    container: document.getElementById('news-container'),
    template: null,
    
    init() {
        // Criar template uma vez
        this.template = document.createElement('div');
        this.template.className = 'card';
        this.template.innerHTML = `
            <img loading="lazy" alt="">
            <div class="card-text">
                <div class="card-title"></div>
                <div class="card-meta">
                    <span class="source-tag"></span>
                    <span class="category-tag"></span>
                </div>
            </div>
        `;
    },
    
    renderNews(articles, clear = false) {
        if (clear) {
            this.container.innerHTML = '';
            // Adicionar skeletons para transi√ß√£o suave
            this.showSkeletons(6);
        }
        
        // Remover skeletons
        const skeletons = this.container.querySelectorAll('.skeleton');
        skeletons.forEach(s => s.remove());
        
        // Usar DocumentFragment para renderiza√ß√£o em batch
        const fragment = document.createDocumentFragment();
        
        articles.forEach(article => {
            const card = this.createCard(article);
            if (card) fragment.appendChild(card);
        });
        
        this.container.appendChild(fragment);
        
        // Pr√©-carregar imagens das pr√≥ximas not√≠cias
        this.prefetchImages(articles.slice(0, 3));
    },
    
    createCard(article) {
        if (this.container.querySelector(`[data-id="${article.id}"]`)) return null;
        
        const card = this.template.cloneNode(true);
        card.dataset.id = article.id;
        card.dataset.category = article.category;
        card.dataset.timestamp = article.timestamp;
        
        // Usar requestIdleCallback para renderiza√ß√£o n√£o cr√≠tica
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                this.updateCardContent(card, article);
            });
        } else {
            this.updateCardContent(card, article);
        }
        
        card.addEventListener('click', (e) => {
            e.preventDefault();
            this.openNews(article);
        }, { passive: true });
        
        return card;
    },
    
    updateCardContent(card, article) {
        const img = card.querySelector('img');
        const title = card.querySelector('.card-title');
        const source = card.querySelector('.source-tag');
        const category = card.querySelector('.category-tag');
        
        // Otimizar carregamento de imagem
        if (article.image && !article.image.startsWith('data:')) {
            img.src = article.image;
            img.onerror = () => {
                img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="200" viewBox="0 0 400 200"%3E%3Crect width="400" height="200" fill="%231a73e8"/%3E%3Ctext x="50%25" y="50%25" font-family="Arial" font-size="24" fill="white" text-anchor="middle" dy=".3em"%3E' + encodeURIComponent(article.source.substring(0, 2)) + '%3C/text%3E%3C/svg%3E';
            };
        } else {
            img.src = article.image;
        }
        
        title.textContent = article.title;
        source.textContent = article.source;
        category.textContent = article.category;
        category.className = `category-tag ${article.category}-tag`;
    },
    
    showSkeletons(count) {
        for (let i = 0; i < count; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'card skeleton loading-shimmer';
            skeleton.innerHTML = `
                <div class="loading-shimmer" style="height:180px;border-radius:16px 16px 0 0"></div>
                <div class="card-text">
                    <div class="card-title loading-shimmer"></div>
                    <div class="card-meta">
                        <span class="loading-shimmer"></span>
                        <span class="loading-shimmer"></span>
                    </div>
                </div>
            `;
            this.container.appendChild(skeleton);
        }
    },
    
    prefetchImages(articles) {
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        observer.unobserve(img);
                    }
                });
            });
            
            articles.forEach(article => {
                if (article.image && !article.image.startsWith('data:')) {
                    const img = new Image();
                    img.dataset.src = article.image;
                    observer.observe(img);
                }
            });
        }
    },
    
    openNews(article) {
        // Gerar URL otimizada
        const slug = article.title
            .toLowerCase()
            .replace(/[^\w\s]/g, '')
            .replace(/\s+/g, '-')
            .substring(0, 60);
        
        const url = `leitura.html?n=${article.id}&t=${slug}&s=${article.sourceId}`;
        
        // Salvar no sessionStorage para acesso r√°pido
        sessionStorage.setItem('currentNews', JSON.stringify(article));
        
        // Navegar com transi√ß√£o
        document.body.style.opacity = '0.7';
        setTimeout(() => {
            window.location.href = url;
        }, 150);
    },
    
    showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
};

// ========== FILTRAGEM E BUSCA ==========

const filterNews = () => {
    let filtered = Array.from(state.news.values());
    
    // Filtrar por categoria
    if (state.activeCategory !== 'todos') {
        filtered = filtered.filter(article => article.category === state.activeCategory);
    }
    
    // Filtrar por busca
    if (state.searchQuery.trim()) {
        const query = state.searchQuery.toLowerCase();
        filtered = filtered.filter(article =>
            article.title.toLowerCase().includes(query) ||
            article.excerpt.toLowerCase().includes(query) ||
            article.source.toLowerCase().includes(query)
        );
    }
    
    // Ordenar por data e prioridade
    filtered.sort((a, b) => {
        if (a.priority !== b.priority) return b.priority - a.priority;
        return b.timestamp - a.timestamp;
    });
    
    state.filteredNews = filtered;
    return filtered;
};

// ========== CARREGAMENTO DE NOT√çCIAS ==========

const loadNews = async (initial = false) => {
    if (state.isLoading || (!initial && !state.hasMore)) return;
    
    state.isLoading = true;
    
    if (initial) {
        renderer.showSkeletons(6);
        state.page = 1;
        state.hasMore = true;
        state.news.clear();
    }
    
    try {
        // Carregar fontes priorit√°rias primeiro
        const prioritySources = NEWS_SOURCES.filter(s => s.priority === 1);
        const otherSources = NEWS_SOURCES.filter(s => s.priority > 1);
        
        const [priorityResults, otherResults] = await Promise.all([
            fetchParallel(prioritySources),
            fetchParallel(otherSources)
        ]);
        
        const allArticles = [];
        
        // Processar resultados priorit√°rios primeiro
        priorityResults.forEach(result => {
            if (result.status === 'fulfilled' && result.value.data.length > 0) {
                const source = NEWS_SOURCES.find(s => s.id === result.value.source);
                const processed = processArticles(result.value.data, source);
                allArticles.push(...processed);
            }
        });
        
        // Processar outras fontes
        otherResults.forEach(result => {
            if (result.status === 'fulfilled' && result.value.data.length > 0) {
                const source = NEWS_SOURCES.find(s => s.id === result.value.source);
                const processed = processArticles(result.value.data, source);
                allArticles.push(...processed);
            }
        });
        
        // Adicionar ao estado
        allArticles.forEach(article => {
            if (!state.news.has(article.id)) {
                state.news.set(article.id, article);
            }
        });
        
        // Atualizar cache
        await cacheManager.saveNews(allArticles);
        
        // Renderizar
        const filtered = filterNews();
        renderer.renderNews(filtered.slice(0, initial ? 20 : filtered.length), initial);
        
        state.page++;
        state.hasMore = allArticles.length >= CONFIG.BATCH_SIZE;
        
        if (initial) {
            // Pr√©-carregar pr√≥ximas not√≠cias
            setTimeout(() => cacheManager.prefetchNews(), 1000);
        }
        
    } catch (error) {
        console.error('Erro ao carregar not√≠cias:', error);
        renderer.showToast('Erro ao carregar not√≠cias', 'error');
    } finally {
        state.isLoading = false;
        document.getElementById('infinite-loader').style.display = 'none';
    }
};

// ========== EVENT HANDLERS OTIMIZADOS ==========

const setupEventListeners = () => {
    // Sidebar
    document.getElementById('menu-btn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('sidebar-overlay').style.display = 'block';
    });
    
    document.getElementById('close-sidebar').addEventListener('click', closeSidebar);
    document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);
    
    // Categorias
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            state.activeCategory = e.target.dataset.category;
            filterNews();
            renderer.renderNews(state.filteredNews, true);
        });
    });
    
    // Busca
    const searchInput = document.getElementById('search-input');
    const handleSearch = debounce((e) => {
        state.searchQuery = e.target.value;
        filterNews();
        renderer.renderNews(state.filteredNews, true);
    }, CONFIG.DEBOUNCE_DELAY);
    
    searchInput.addEventListener('input', handleSearch);
    
    // Refresh
    document.getElementById('refresh-btn').addEventListener('click', () => {
        loadNews(true);
        renderer.showToast('Atualizando not√≠cias...', 'info');
    });
    
    // Scroll infinito
    const handleScroll = throttle(() => {
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - CONFIG.SCROLL_THRESHOLD;
        
        if (scrollPosition >= threshold && !state.isLoading && state.hasMore) {
            document.getElementById('infinite-loader').style.display = 'block';
            loadNews(false);
        }
    }, CONFIG.THROTTLE_DELAY);
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    
    // Offline/online
    window.addEventListener('online', () => {
        state.offline = false;
        renderer.showToast('Conex√£o restaurada', 'success');
        if (state.news.size === 0) loadNews(true);
    });
    
    window.addEventListener('offline', () => {
        state.offline = true;
        renderer.showToast('Modo offline ativado', 'error');
    });
};

const closeSidebar = () => {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebar-overlay').style.display = 'none';
};

// ========== INICIALIZA√á√ÉO R√ÅPIDA ==========

const init = async () => {
    // 1. Inicializar renderizador
    renderer.init();
    
    // 2. Inicializar IndexedDB (em paralelo)
    const dbPromise = initDB();
    
    // 3. Carregar not√≠cias do cache primeiro
    try {
        const cachedNews = JSON.parse(localStorage.getItem('last_news') || '[]');
        if (cachedNews.length > 0) {
            cachedNews.forEach(article => state.news.set(article.id, article));
            const filtered = filterNews();
            renderer.renderNews(filtered.slice(0, 10));
            renderer.showToast('Carregado do cache', 'info');
        }
    } catch (e) {
        console.warn('Erro ao carregar cache:', e);
    }
    
    // 4. Configurar event listeners
    setupEventListeners();
    
    // 5. Aguardar IndexedDB e carregar not√≠cias
    await dbPromise;
    
    // 6. Carregar not√≠cias novas
    if (navigator.onLine) {
        setTimeout(() => loadNews(true), 100);
    }
    
    // 7. Otimiza√ß√µes de performance
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(console.warn);
    }
    
    // 8. Prefetch cr√≠tico
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.href = 'leitura.html';
    document.head.appendChild(link);
    
    console.log('Aplica√ß√£o inicializada com alta performance');
};

// Iniciar imediatamente
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

// Web Worker para processamento em background
if (window.Worker) {
    const worker = new Worker('news-worker.js');
    worker.onmessage = (e) => {
        console.log('Worker processou:', e.data.length, 'not√≠cias');
    };
}

// Exportar para debug
window.appState = state;
</script>
</body>
</html>