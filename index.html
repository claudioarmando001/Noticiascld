<!doctype html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Not√≠cias CLD - P√°gina Inicial</title>
    <meta name="description" content="Agregador de not√≠cias de Mo√ßambique em tempo real">
    <meta name="robots" content="index, follow">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f3f5;
            margin: 0;
            color: #111;
        }

        /* HEADER */
        header {
            background: #1a73e8;
            color: white;
            padding: 18px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            position: relative;
        }

        .header-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            color: #1a73e8;
            border: none;
            padding: 7px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .header-btn:hover {
            opacity: 0.9;
            transform: translateY(-50%) scale(1.05);
        }

        #menu-btn { left: 15px; }
        #refresh-btn { right: 15px; }

        /* SIDEBAR */
        #sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: none;
            z-index: 9998;
        }

        #sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: #fff;
            box-shadow: 2px 0 6px rgba(0,0,0,.2);
            padding: 20px;
            box-sizing: border-box;
            transition: .3s;
            z-index: 9999;
            overflow-y: auto;
        }

        #sidebar.open {
            left: 0;
        }

        #sidebar h2 {
            color: #1a73e8;
            margin-top: 0;
            font-size: 18px;
        }

        #sidebar p {
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }

        #close-sidebar {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 18px;
            color: #333;
        }

        /* CATEGORIAS */
        .categories {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-btn {
            background: #e8f0fe;
            border: 1px solid #dce6f5;
            color: #1a73e8;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .category-btn:hover {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        .category-btn.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        /* BOT√ïES MODAL */
        .modal-buttons {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-btn:hover {
            background: #0d62d9;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(26, 115, 232, 0.3);
        }

        /* SEARCH */
        .search-container {
            max-width: 950px;
            margin: 12px auto;
            padding: 0 12px;
        }

        #search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
            background: #fff;
            color: #111;
            transition: all 0.3s;
        }

        #search-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        /* LISTA */
        #news-container {
            max-width: 950px;
            margin: auto;
            padding: 12px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,.08);
            cursor: pointer;
            transition: .2s;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid #e8e8e8;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .card:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0,0,0,.12);
        }

        .card-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-text {
            width: 70%;
        }

        .card-title {
            font-size: 16px;
            font-weight: bold;
            color: #111;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .card-meta {
            font-size: 12px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .source-tag {
            background: #e8f0fe;
            color: #1a73e8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .card img {
            width: 120px;
            height: 85px;
            object-fit: cover;
            border-radius: 10px;
            background: #eee;
        }

        .category-tag {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .sociedade-tag {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
        }

        .politica-tag {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
        }

        .economia-tag {
            background: rgba(255, 152, 0, 0.1);
            color: #ef6c00;
        }

        .esportes-tag {
            background: rgba(33, 150, 243, 0.1);
            color: #1565c0;
        }

        .cultura-tag {
            background: rgba(156, 39, 176, 0.1);
            color: #7b1fa2;
        }

        .saude-tag {
            background: rgba(0, 150, 136, 0.1);
            color: #00796b;
        }

        .tech-tag {
            background: rgba(96, 125, 139, 0.1);
            color: #37474f;
        }

        /* LOADER INFINITO */
        #infinite-loader {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .infinite-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e8e8e8;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MODAL INFO */
        #info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        #info-modal-content {
            background: #fff;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }

        #info-modal-header {
            background: linear-gradient(135deg, #1a73e8, #0d62d9);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #info-modal-header h2 {
            margin: 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #info-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        #info-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        #info-modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(85vh - 80px);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .card-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .card-text {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .card img {
                width: 100%;
                height: 150px;
            }
            
            .header {
                font-size: 18px;
                padding: 15px;
            }
        }

        /* SHARE PREVIEW */
        .share-preview {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1a73e8;
        }

        .share-preview small {
            color: #666;
            font-size: 12px;
        }

        .copy-link-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .copy-link-btn:hover {
            background: #0d62d9;
        }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <button class="header-btn" id="menu-btn" onclick="openSidebar()">‚ò∞</button>
        Not√≠cias CLD
        <button class="header-btn" id="refresh-btn" onclick="manualRefresh()">‚Üª</button>
    </header>

    <!-- SIDEBAR -->
    <div id="sidebar-overlay"></div>
    <div id="sidebar">
        <span id="close-sidebar" onclick="closeSidebar()">‚úñ</span>
        <h2>Categorias</h2>
        <div class="categories">
            <button class="category-btn active" onclick="filterByCategory('todos')">Todos</button>
            <button class="category-btn" onclick="filterByCategory('sociedade')">Sociedade</button>
            <button class="category-btn" onclick="filterByCategory('pol√≠tica')">Pol√≠tica</button>
            <button class="category-btn" onclick="filterByCategory('economia')">Economia</button>
            <button class="category-btn" onclick="filterByCategory('esportes')">Esportes</button>
            <button class="category-btn" onclick="filterByCategory('cultura')">Cultura</button>
            <button class="category-btn" onclick="filterByCategory('sa√∫de')">Sa√∫de</button>
            <button class="category-btn" onclick="filterByCategory('tecnologia')">Tecnologia</button>
        </div>

        <h2>A√ß√µes</h2>
        <div class="modal-buttons">
            <button class="modal-btn" onclick="openInfoModal('sobre')">
                <i class="fas fa-info-circle"></i> Sobre a Plataforma
            </button>
            <button class="modal-btn" onclick="openInfoModal('contato')">
                <i class="fas fa-envelope"></i> Contacto
            </button>
        </div>
    </div>

    <!-- BUSCA -->
    <div class="search-container">
        <input id="search-input" placeholder="üîç Buscar not√≠cias..." onkeyup="searchNews()">
    </div>

    <!-- LISTA DE NOT√çCIAS -->
    <div id="news-container">
        <!-- Not√≠cias ser√£o carregadas aqui -->
    </div>

    <!-- LOADER INFINITO -->
    <div id="infinite-loader" style="display:none;">
        <div class="infinite-spinner"></div>
        Carregando mais not√≠cias...
    </div>

    <!-- MODAL INFO -->
    <div id="info-modal">
        <div id="info-modal-content">
            <div id="info-modal-header">
                <h2><i class="fas" id="modal-icon"></i> <span id="modal-title"></span></h2>
                <button id="info-modal-close">‚úñ</button>
            </div>
            <div id="info-modal-body"></div>
        </div>
    </div>

    <script>
        // VARI√ÅVEIS GLOBAIS
        let news = [];
        let filteredNews = [];
        let hashes = new Set();
        const BATCH_SIZE = 15;
        let isLoadingMore = false;
        let allSourcesLoaded = false;
        let currentCategory = 'todos';

        // CATEGORIAS
        const CATEGORIES = {
            'todos': { name: 'Todos', color: '#1a73e8' },
            'sociedade': { name: 'Sociedade', color: '#2e7d32', class: 'sociedade-tag' },
            'pol√≠tica': { name: 'Pol√≠tica', color: '#c62828', class: 'politica-tag' },
            'economia': { name: 'Economia', color: '#ef6c00', class: 'economia-tag' },
            'esportes': { name: 'Esportes', color: '#1565c0', class: 'esportes-tag' },
            'cultura': { name: 'Cultura', color: '#7b1fa2', class: 'cultura-tag' },
            'sa√∫de': { name: 'Sa√∫de', color: '#00796b', class: 'saude-tag' },
            'tecnologia': { name: 'Tecnologia', color: '#37474f', class: 'tech-tag' }
        };

        // ELEMENTOS DOM
        const container = document.getElementById("news-container");
        const infiniteLoader = document.getElementById("infinite-loader");
        const infoModal = document.getElementById("info-modal");
        const infoModalClose = document.getElementById("info-modal-close");
        const modalTitle = document.getElementById("modal-title");
        const modalIcon = document.getElementById("modal-icon");

        // CONFIGURA√á√ÉO DAS FONTES
        const sources = [
            { 
                name: "O Pa√≠s", 
                baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            {
                name: "Time de Todos",
                baseUrl: "https://timesdetodos.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            { 
                name: "Integrity", 
                baseUrl: "https://integritymagazine.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            {
                name: "Jornal Not√≠cias",
                baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            { 
                name: "Savana", 
                baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            {
                name: "JornalMZ",
                baseUrl: "https://jornalmz.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            {
                name: "Checka",
                baseUrl: "https://checka.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            {
                name: "Canal de Mo√ßambique",
                baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            {
                name: "Stop",
                baseUrl: "https://www.stop.co.mz/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            {
                name: "Club of Mozambique",
                baseUrl: "https://clubofmozambique.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            {
                name: "Zitamar News",
                baseUrl: "https://www.zitamar.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            },
            { 
                name: "Carta de Mo√ßambique", 
                baseUrl: "https://cartamz.com/wp-json/wp/v2/posts",
                currentPage: 1,
                hasMore: true,
                isFetching: false
            }
        ];

        // FUN√á√ïES DE UTILIDADE
        function formatDate(d) {
            return new Date(d).toLocaleString("pt-PT");
        }

        function generateSlug(title) {
            return title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 50);
        }

        function generateNewsId(title, source, date) {
            const shortTitle = title.substring(0, 30);
            const sourceAbbr = source.substring(0, 3).toLowerCase();
            const dateStr = new Date(date).getTime().toString(36);
            return `${sourceAbbr}-${generateSlug(shortTitle)}-${dateStr}`;
        }

        // FUN√á√ïES DE INTERFACE
        function openSidebar() {
            document.getElementById("sidebar").classList.add("open");
            document.getElementById("sidebar-overlay").style.display = "block";
        }

        function closeSidebar() {
            document.getElementById("sidebar").classList.remove("open");
            document.getElementById("sidebar-overlay").style.display = "none";
        }

        document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentCategory = category;
            
            if (category === 'todos') {
                filteredNews = [...news];
            } else {
                filteredNews = news.filter(article => {
                    const articleCategory = determineCategory(article.title, article.content);
                    return articleCategory === category;
                });
            }
            
            const searchText = document.getElementById("search-input").value.toLowerCase();
            if (searchText) {
                filteredNews = filteredNews.filter(n =>
                    n.title.toLowerCase().includes(searchText) || 
                    n.source.toLowerCase().includes(searchText)
                );
            }
            
            container.innerHTML = '';
            filteredNews.forEach(article => {
                renderSingleNews(article);
            });
        }

        function searchNews() {
            const q = document.getElementById("search-input").value.toLowerCase();
            
            let tempFiltered = [...news];
            
            if (currentCategory !== 'todos') {
                tempFiltered = news.filter(article => {
                    const articleCategory = determineCategory(article.title, article.content);
                    return articleCategory === currentCategory;
                });
            }
            
            filteredNews = tempFiltered.filter(n =>
                n.title.toLowerCase().includes(q) || 
                n.source.toLowerCase().includes(q)
            );
            
            container.innerHTML = '';
            filteredNews.forEach(article => {
                renderSingleNews(article);
            });
        }

        // MODAL INFO
        function openInfoModal(type) {
            closeSidebar();
            
            let title = '';
            let icon = '';
            let content = '';
            
            if (type === 'sobre') {
                title = 'Sobre a Plataforma';
                icon = 'fa-info-circle';
                content = `
                    <div class="info-content">
                        <h3>üì∞ Agregador de Not√≠cias</h3>
                        <p>Agregador independente de not√≠cias de Mo√ßambique, reunindo conte√∫dos de v√°rias fontes confi√°veis em tempo real.</p>
                        
                        <h4>Funcionalidades:</h4>
                        <ul>
                            <li>‚úÖ Not√≠cias em tempo real</li>
                            <li>‚úÖ Busca inteligente</li>
                            <li>‚úÖ Categoriza√ß√£o autom√°tica</li>
                            <li>‚úÖ Links permanentes para cada not√≠cia</li>
                            <li>‚úÖ Design responsivo</li>
                        </ul>
                        
                        <div class="share-preview">
                            <small><strong>Compartilhe esta plataforma:</strong></small><br>
                            <button class="copy-link-btn" onclick="copyPlatformLink()">
                                <i class="fas fa-link"></i> Copiar Link da Plataforma
                            </button>
                        </div>
                    </div>
                `;
            } else if (type === 'contato') {
                title = 'Contacto';
                icon = 'fa-envelope';
                content = `
                    <div class="info-content">
                        <h3>üìû Entre em Contacto</h3>
                        
                        <div class="contact-info">
                            <p><strong>Email:</strong> claudioarmando001@gmail.com</p>
                            <p><strong>Telefone:</strong> +258 869 667 677</p>
                        </div>
                        
                        <p><em>Hor√°rio de atendimento: Seg-Sex, 08:00-18:00</em></p>
                    </div>
                `;
            }
            
            modalTitle.textContent = title;
            modalIcon.className = `fas ${icon}`;
            document.getElementById("info-modal-body").innerHTML = content;
            infoModal.style.display = "flex";
        }

        function closeInfoModal() {
            infoModal.style.display = "none";
        }

        infoModalClose.addEventListener('click', closeInfoModal);
        infoModal.addEventListener('click', (e) => {
            if (e.target.id === 'info-modal') closeInfoModal();
        });

        function copyPlatformLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link da plataforma copiado!');
            });
        }

        // DETERMINAR CATEGORIA
        function determineCategory(title, content) {
            const text = (title + ' ' + content).toLowerCase();
            
            const keywords = {
                'sociedade': ['sociedade', 'social', 'comunidade', 'educa√ß√£o', 'escola'],
                'pol√≠tica': ['pol√≠tica', 'governo', 'presidente', 'elei√ß√µes', 'partido'],
                'economia': ['economia', 'neg√≥cio', 'empresa', 'investimento', 'banco'],
                'esportes': ['esporte', 'futebol', 'jogo', 'atleta', 'campeonato'],
                'cultura': ['cultura', 'arte', 'm√∫sica', 'teatro', 'cinema'],
                'sa√∫de': ['sa√∫de', 'hospital', 'm√©dico', 'doen√ßa', 'vacina'],
                'tecnologia': ['tecnologia', 'internet', 'digital', 'aplicativo', 'software']
            };
            
            let scores = {};
            Object.keys(keywords).forEach(cat => {
                scores[cat] = 0;
                keywords[cat].forEach(keyword => {
                    if (text.includes(keyword)) scores[cat]++;
                });
            });
            
            let maxScore = 0;
            let selectedCategory = 'sociedade';
            
            Object.keys(scores).forEach(cat => {
                if (scores[cat] > maxScore) {
                    maxScore = scores[cat];
                    selectedCategory = cat;
                }
            });
            
            if (maxScore === 0) {
                if (title.toLowerCase().includes('futebol')) return 'esportes';
                if (title.toLowerCase().includes('econ')) return 'economia';
                if (title.toLowerCase().includes('arte')) return 'cultura';
                if (title.toLowerCase().includes('hospital')) return 'sa√∫de';
                if (title.toLowerCase().includes('tech')) return 'tecnologia';
                
                const categories = Object.keys(CATEGORIES).filter(cat => cat !== 'todos');
                return categories[Math.floor(Math.random() * categories.length)];
            }
            
            return selectedCategory;
        }

        // RENDERIZAR NOT√çCIA
        function renderSingleNews(article) {
            if (container.querySelector(`[data-id="${article.id}"]`)) return;
            
            const category = article.category || determineCategory(article.title, article.content);
            article.category = category;
            
            // Gera ID √∫nico para a not√≠cia
            article.id = article.id || generateNewsId(article.title, article.source, article.date);
            
            // Gera URL para a p√°gina de leitura
            const newsUrl = `leitura.html?id=${article.id}`;
            
            const c = document.createElement("a");
            c.className = "card";
            c.href = newsUrl;
            c.dataset.id = article.id;
            c.dataset.category = category;
            
            c.innerHTML = `
                <div class="card-content">
                    <div class="card-text">
                        <div class="card-title">${article.title}</div>
                        <div class="card-meta">
                            <span class="source-tag">${article.source}</span>
                            <span class="category-tag ${CATEGORIES[category].class}">${CATEGORIES[category].name}</span>
                            <span>${formatDate(article.date)}</span>
                        </div>
                    </div>
                    <img src="${article.image}" loading="lazy" alt="${article.title}" onerror="this.src='https://via.placeholder.com/120x85/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
                </div>
            `;
            
            // Encontra a posi√ß√£o correta para ordena√ß√£o por data
            let inserted = false;
            const cards = container.querySelectorAll('.card');
            
            for (let i = 0; i < cards.length; i++) {
                const cardDate = new Date(cards[i].dataset.date || 0);
                const newDate = new Date(article.date);
                
                if (newDate > cardDate) {
                    container.insertBefore(c, cards[i]);
                    inserted = true;
                    break;
                }
            }
            
            if (!inserted) {
                container.appendChild(c);
            }
            
            c.dataset.date = article.date;
        }

        // CARREGAMENTO DE NOT√çCIAS
        async function processSourceArticles(source, articles) {
            const newArticles = [];
            
            for (const article of articles) {
                const hash = (article.title.rendered + article.link).replace(/\W/g, "");
                
                if (hashes.has(hash)) continue;
                hashes.add(hash);
                
                const newsItem = {
                    id: generateNewsId(article.title.rendered, source.name, article.date),
                    title: article.title.rendered,
                    content: article.content.rendered,
                    image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                           article.jetpack_featured_media_url ||
                           "https://via.placeholder.com/300x200",
                    source: source.name,
                    date: article.date || article.modified,
                    link: article.link,
                    hash: hash
                };
                
                newArticles.push(newsItem);
            }
            
            newArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (const newsItem of newArticles) {
                news.push(newsItem);
                filteredNews.push(newsItem);
                renderSingleNews(newsItem);
                await new Promise(resolve => setTimeout(resolve, 30));
            }
        }

        async function loadSource(source) {
            if (!source.hasMore || source.isFetching) return;
            
            source.isFetching = true;
            
            try {
                const url = `${source.baseUrl}?_embed&per_page=${BATCH_SIZE}&page=${source.currentPage}&t=${Date.now()}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    if (response.status === 400) source.hasMore = false;
                    throw new Error(`Erro ao buscar ${source.name}`);
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    source.hasMore = false;
                    return;
                }
                
                source.currentPage++;
                await processSourceArticles(source, data);
                
            } catch (error) {
                console.error(`Erro ao carregar ${source.name}:`, error);
                source.hasMore = false;
            } finally {
                source.isFetching = false;
                checkAllSourcesLoaded();
            }
        }

        async function loadAllSources() {
            news = [];
            filteredNews = [];
            hashes.clear();
            allSourcesLoaded = false;
            container.innerHTML = '';
            
            sources.forEach(source => {
                source.currentPage = 1;
                source.hasMore = true;
                source.isFetching = false;
            });
            
            const promises = sources.map(source => loadSource(source));
            await Promise.allSettled(promises);
            reorderAllNewsByDate();
            
            // Armazena no localStorage para uso na p√°gina de leitura
            localStorage.setItem('newsCache', JSON.stringify(news));
            localStorage.setItem('newsCacheTimestamp', Date.now());
        }

        function reorderAllNewsByDate() {
            news.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredNews.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = '';
            filteredNews.forEach(article => {
                renderSingleNews(article);
            });
        }

        async function loadMoreNews() {
            if (isLoadingMore || allSourcesLoaded) return;
            
            isLoadingMore = true;
            infiniteLoader.style.display = 'block';
            
            let anySourceHasMore = false;
            const promises = [];
            
            for (const source of sources) {
                if (source.hasMore) {
                    promises.push(loadSource(source));
                    if (source.hasMore) anySourceHasMore = true;
                }
            }
            
            await Promise.allSettled(promises);
            allSourcesLoaded = !anySourceHasMore;
            
            isLoadingMore = false;
            infiniteLoader.style.display = 'none';
            
            // Atualiza cache
            localStorage.setItem('newsCache', JSON.stringify(news));
        }

        function checkAllSourcesLoaded() {
            allSourcesLoaded = sources.every(source => !source.hasMore);
            if (allSourcesLoaded) infiniteLoader.style.display = 'none';
        }

        // CONTROLES
        function manualRefresh() {
            container.innerHTML = '';
            closeInfoModal();
            loadAllSources();
        }

        // SCROLL INFINITO
        let scrollTimeout;
        const SCROLL_THRESHOLD = 300;

        window.addEventListener("scroll", () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            
            scrollTimeout = setTimeout(() => {
                const scrollPosition = window.innerHeight + window.scrollY;
                const threshold = document.body.offsetHeight - SCROLL_THRESHOLD;
                
                if (scrollPosition >= threshold && !isLoadingMore && !allSourcesLoaded) {
                    loadMoreNews();
                }
            }, 150);
        });

        // INICIALIZA√á√ÉO
        loadAllSources();

        // Atualiza periodicamente
        setInterval(() => {
            if (document.visibilityState === 'visible' && !isLoadingMore) {
                const scrollPosition = window.innerHeight + window.scrollY;
                const threshold = document.body.offsetHeight - 500;
                
                if (scrollPosition >= threshold) {
                    loadMoreNews();
                }
            }
        }, 300000);

        // ATALHOS DE TECLADO
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeInfoModal();
                closeSidebar();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById("search-input").focus();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                manualRefresh();
            }
        });
    </script>
</body>
</html>