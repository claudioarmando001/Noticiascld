<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Not√≠cias CLD - Agregador de Not√≠cias de Mo√ßambique</title>
<meta name="description" content="Agregador de not√≠cias de Mo√ßambique em tempo real">
<meta name="robots" content="index, follow">
<style>
/* ... (mantenha todo o CSS anterior) ... */
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header>
<button class="header-btn" id="menu-btn" onclick="openSidebar()">‚ò∞</button>
Not√≠cias CLD
<button class="header-btn" id="refresh-btn" onclick="manualRefresh()">‚Üª</button>
</header>

<!-- SIDEBAR -->
<div id="sidebar-overlay"></div>
<div id="sidebar">
<span id="close-sidebar" onclick="closeSidebar()">‚úñ</span>
<h2>Categorias</h2>
<div class="categories">
<button class="category-btn active" onclick="filterByCategory('todos')">Todos</button>
<button class="category-btn" onclick="filterByCategory('sociedade')">Sociedade</button>
<button class="category-btn" onclick="filterByCategory('pol√≠tica')">Pol√≠tica</button>
<button class="category-btn" onclick="filterByCategory('economia')">Economia</button>
<button class="category-btn" onclick="filterByCategory('esportes')">Esportes</button>
<button class="category-btn" onclick="filterByCategory('cultura')">Cultura</button>
<button class="category-btn" onclick="filterByCategory('sa√∫de')">Sa√∫de</button>
<button class="category-btn" onclick="filterByCategory('tecnologia')">Tecnologia</button>
</div>

<h2>A√ß√µes</h2>
<div class="modal-buttons">
<button class="modal-btn" onclick="openInfoModal('sobre')">
    <i class="fas fa-info-circle"></i> Sobre a Plataforma
</button>
<button class="modal-btn" onclick="openInfoModal('contato')">
    <i class="fas fa-envelope"></i> Contacto
</button>
</div>
</div>

<!-- BUSCA -->
<div class="search-container">
<input id="search-input" placeholder="üîç Buscar not√≠cias..." onkeyup="searchNews()">
</div>

<!-- LISTA COM RENDERIZA√á√ÉO EM TEMPO REAL -->
<div id="news-container">
<!-- Not√≠cias aparecer√£o aqui automaticamente -->
</div>

<!-- LOADER PARA SCROLL INFINITO -->
<div id="infinite-loader" style="display:none;">
    <div class="infinite-spinner"></div>
    Carregando mais not√≠cias...
</div>

<!-- MODAL INFO (SOBRE/CONTATO) - MELHORADA -->
<div id="info-modal">
<div id="info-modal-content">
<div id="info-modal-header">
    <h2><i class="fas" id="modal-icon"></i> <span id="modal-title"></span></h2>
    <button id="info-modal-close">‚úñ</button>
</div>
<div id="info-modal-body"></div>
</div>
</div>

<!-- WHATSAPP CHANNEL BUTTON -->
<button class="whatsapp-channel-btn" onclick="openWhatsAppChannel()" title="Canal WhatsApp" aria-label="Abrir canal oficial no WhatsApp">
</button>

<script>
// VARI√ÅVEIS GLOBAIS
let news = []; // Todas as not√≠cias carregadas
let filteredNews = []; // Not√≠cias filtradas para busca
let hashes = new Set(); // Para evitar duplicatas
const BATCH_SIZE = 15; // Quantas not√≠cias carregar por fonte
let isLoadingMore = false; // Flag para evitar m√∫ltiplos carregamentos
let allSourcesLoaded = false; // Se todas as fontes foram completamente carregadas
let currentCategory = 'todos'; // Categoria atual selecionada

// CATEGORIAS DISPON√çVEIS
const CATEGORIES = {
    'todos': { name: 'Todos', color: '#1a73e8' },
    'sociedade': { name: 'Sociedade', color: '#2e7d32', class: 'sociedade-tag' },
    'pol√≠tica': { name: 'Pol√≠tica', color: '#c62828', class: 'politica-tag' },
    'economia': { name: 'Economia', color: '#ef6c00', class: 'economia-tag' },
    'esportes': { name: 'Esportes', color: '#1565c0', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', color: '#7b1fa2', class: 'cultura-tag' },
    'sa√∫de': { name: 'Sa√∫de', color: '#00796b', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', color: '#37474f', class: 'tech-tag' }
};

// ELEMENTOS DOM
const container = document.getElementById("news-container");
const infiniteLoader = document.getElementById("infinite-loader");
const infoModal = document.getElementById("info-modal");
const infoModalClose = document.getElementById("info-modal-close");
const modalTitle = document.getElementById("modal-title");
const modalIcon = document.getElementById("modal-icon");

// CONSTANTES
const PLATFORM_URL = window.location.origin;
const WHATSAPP_CHANNEL_URL = "https://whatsapp.com/channel/0029Vb7BeBI7T8bRTbjcsN0t";

// CONFIGURA√á√ÉO DAS FONTES
const sources = [
    { 
        name: "O Pa√≠s", 
        baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Time de Todos",
        baseUrl: "https://timesdetodos.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Integrity", 
        baseUrl: "https://integritymagazine.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Jornal Not√≠cias",
        baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Savana", 
        baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "JornalMZ",
        baseUrl: "https://jornalmz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Checka",
        baseUrl: "https://checka.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Canal de Mo√ßambique",
        baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Stop",
        baseUrl: "https://www.stop.co.mz/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Club of Mozambique",
        baseUrl: "https://clubofmozambique.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    {
        name: "Zitamar News",
        baseUrl: "https://www.zitamar.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    },
    { 
        name: "Carta de Mo√ßambique", 
        baseUrl: "https://cartamz.com/wp-json/wp/v2/posts",
        currentPage: 1,
        hasMore: true,
        isFetching: false
    }
];

// ========== SISTEMA DE ARMAZENAMENTO ==========
const STORAGE_KEY = 'noticias_cld';
const MAX_STORED_ARTICLES = 100;

// Inicializa o armazenamento
function initializeStorage() {
    if (!localStorage.getItem(STORAGE_KEY)) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            articles: [],
            lastUpdated: new Date().toISOString(),
            version: '1.0'
        }));
    }
}

// Armazena artigo no localStorage
function storeArticle(article) {
    const storage = JSON.parse(localStorage.getItem(STORAGE_KEY));
    
    // Verifica se o artigo j√° existe
    const existingIndex = storage.articles.findIndex(a => a.id === article.id);
    
    if (existingIndex !== -1) {
        // Atualiza artigo existente
        storage.articles[existingIndex] = article;
    } else {
        // Adiciona novo artigo
        storage.articles.unshift(article);
        
        // Mant√©m apenas os artigos mais recentes
        if (storage.articles.length > MAX_STORED_ARTICLES) {
            storage.articles = storage.articles.slice(0, MAX_STORED_ARTICLES);
        }
    }
    
    storage.lastUpdated = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(storage));
}

// Busca artigo pelo ID
function getArticleById(id) {
    const storage = JSON.parse(localStorage.getItem(STORAGE_KEY));
    return storage.articles.find(article => article.id === id);
}

// Busca artigo pelo hash
function getArticleByHash(hash) {
    const storage = JSON.parse(localStorage.getItem(STORAGE_KEY));
    return storage.articles.find(article => article.hash === hash);
}

// ========== FUN√á√ïES DE INTERFACE ==========

/* SIDEBAR */
function openSidebar(){
    document.getElementById("sidebar").classList.add("open");
    document.getElementById("sidebar-overlay").style.display="block";
}
function closeSidebar(){
    document.getElementById("sidebar").classList.remove("open");
    document.getElementById("sidebar-overlay").style.display="none";
}

document.getElementById('sidebar-overlay').addEventListener('click', function(event) {
    if (event.target === this) {
        closeSidebar();
    }
});

/* DATA */
function formatDate(d){
    return new Date(d).toLocaleString("pt-PT");
}

/* CATEGORIAS */
function filterByCategory(category) {
    // Atualiza bot√µes ativos
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentCategory = category;
    
    // Aplica filtro de categoria
    if (category === 'todos') {
        filteredNews = [...news];
    } else {
        filteredNews = news.filter(article => {
            const articleCategory = determineCategory(article.title, article.content);
            return articleCategory === category;
        });
    }
    
    // Re-aplica busca se houver texto na busca
    const searchText = document.getElementById("search-input").value.toLowerCase();
    if (searchText) {
        filteredNews = filteredNews.filter(n =>
            n.title.toLowerCase().includes(searchText) || 
            n.source.toLowerCase().includes(searchText)
        );
    }
    
    // Re-renderiza
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

/* BUSCA */
function searchNews(){
    const q = document.getElementById("search-input").value.toLowerCase();
    
    // Primeiro filtra por categoria
    let tempFiltered = [...news];
    
    if (currentCategory !== 'todos') {
        tempFiltered = news.filter(article => {
            const articleCategory = determineCategory(article.title, article.content);
            return articleCategory === currentCategory;
        });
    }
    
    // Depois aplica o filtro de busca
    filteredNews = tempFiltered.filter(n =>
        n.title.toLowerCase().includes(q) || 
        n.source.toLowerCase().includes(q)
    );
    
    // Limpa e re-renderiza todas as not√≠cias filtradas
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

/* MODAL INFO (SOBRE/CONTATO) - MELHORADA */
function openInfoModal(type) {
    closeSidebar(); // Fecha a sidebar quando abre a modal
    
    let title = '';
    let icon = '';
    let content = '';
    
    if (type === 'sobre') {
        title = 'Sobre a Plataforma';
        icon = 'fa-info-circle';
        content = `
        <div class="info-content">
            <span class="info-badge">üì∞ Agregador de Not√≠cias</span>
            
            <div class="info-section">
                <h3><i class="fas fa-bullhorn"></i> Descri√ß√£o</h3>
                <p>Agregador independente de not√≠cias de Mo√ßambique, reunindo conte√∫dos de v√°rias fontes confi√°veis em tempo real. A plataforma tem como objetivo facilitar o acesso √† informa√ß√£o de qualidade sobre Mo√ßambique.</p>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-newspaper"></i> Fontes Inclu√≠das</h3>
                <ul>
                    <li><strong>O Pa√≠s</strong> - Jornal de refer√™ncia nacional</li>
                    <li><strong>Jornal Not√≠cias</strong> - Not√≠cias di√°rias</li>
                    <li><strong>Canal de Mo√ßambique</strong> - An√°lises e reportagens</li>
                    <li><strong>Carta de Mo√ßambique</strong> - Pol√≠tica e economia</li>
                    <li><strong>Club of Mozambique</strong> - Neg√≥cios e investimentos</li>
                    <li><strong>Stop</strong> - Not√≠cias gerais</li>
                    <li><strong>Zitamar News</strong> - An√°lises especializadas</li>
                    <li><strong>Time de Todos</strong> - Desporto e cultura</li>
                    <li><strong>JornalMZ</strong> - Not√≠cias diversas</li>
                    <li><strong>Checka</strong> - Fact-checking e an√°lises</li>
                </ul>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-tags"></i> Categorias</h3>
                <p>As not√≠cias s√£o automaticamente classificadas em 7 categorias principais:</p>
                <div class="features-grid">
                    <div class="feature-item">
                        <i class="fas fa-users"></i>
                        <span>Sociedade</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-landmark"></i>
                        <span>Pol√≠tica</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Economia</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-futbol"></i>
                        <span>Esportes</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-paint-brush"></i>
                        <span>Cultura</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-heartbeat"></i>
                        <span>Sa√∫de</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-laptop"></i>
                        <span>Tecnologia</span>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-bolt"></i> Funcionalidades</h3>
                <ul>
                    <li>‚úÖ <strong>Atualiza√ß√£o em tempo real</strong> - Novas not√≠cias carregadas automaticamente</li>
                    <li>‚úÖ <strong>Busca inteligente</strong> - Encontre not√≠cias por palavras-chave</li>
                    <li>‚úÖ <strong>Categoriza√ß√£o autom√°tica</strong> - Sistema inteligente de classifica√ß√£o</li>
                    <li>‚úÖ <strong>Filtros por categoria</strong> - Visualize apenas o que interessa</li>
                    <li>‚úÖ <strong>Compartilhamento f√°cil</strong> - Partilhe em redes sociais com um clique</li>
                    <li>‚úÖ <strong>Design responsivo</strong> - Funciona em todos os dispositivos</li>
                    <li>‚úÖ <strong>Canal WhatsApp</strong> - Receba atualiza√ß√µes no seu telefone</li>
                    <li>‚úÖ <strong>Scroll infinito</strong> - Carrega mais not√≠cias automaticamente</li>
                </ul>
            </div>
            
            <div class="info-highlight">
                <p><i class="fas fa-lightbulb"></i> <strong>Nota Importante:</strong> Esta √© uma plataforma independente e n√£o possui afilia√ß√£o oficial com as fontes de not√≠cias listadas. O conte√∫do √© agregado automaticamente das fontes originais.</p>
            </div>
        </div>
        `;
    } else if (type === 'contato') {
        title = 'Contacto';
        icon = 'fa-envelope';
        content = `
        <div class="info-content">
            <span class="info-badge">üìû Entre em Contacto</span>
            
            <div class="info-section">
                <h3><i class="fas fa-headset"></i> Canais de Atendimento</h3>
                <p>Temos v√°rios canais dispon√≠veis para o atender:</p>
                
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <div>
                            <strong>Email Principal</strong><br>
                            <a href="mailto:claudioarmando001@gmail.com" class="contact-link">claudioarmando001@gmail.com</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <div>
                            <strong>Telefone/WhatsApp</strong><br>
                            <a href="tel:+258869667677" class="contact-link">+258 869 667 677</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <strong>Hor√°rio de Atendimento</strong><br>
                            Seg-Sex: 08:00 - 18:00<br>
                            S√°bado: 09:00 - 13:00
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h3><i class="fab fa-whatsapp"></i> Canal Oficial WhatsApp</h3>
                <p>Receba as principais not√≠cias diretamente no seu WhatsApp:</p>
                <button class="social-btn whatsapp" onclick="openWhatsAppChannel()">
                    <i class="fab fa-whatsapp"></i> Entrar no Canal
                </button>
                <p style="font-size: 13px; color: #666; margin-top: 10px;">Receba atualiza√ß√µes em tempo real sem custos adicionais.</p>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-comments"></i> A√ß√µes R√°pidas</h3>
                <div class="social-links">
                    <button class="social-btn email" onclick="window.open('mailto:claudioarmando001@gmail.com?subject=Contacto%20Jornal%20Mo√ßambique', '_blank')">
                        <i class="fas fa-envelope"></i> Enviar Email
                    </button>
                    <button class="social-btn whatsapp" onclick="window.open('https://wa.me/258869667677?text=Ol√°%20Jornal%20Mo√ßambique,%20gostaria%20de%20mais%20informa√ß√µes', '_blank')">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="social-btn phone" onclick="window.location.href='tel:+258869667677'">
                        <i class="fas fa-phone"></i> Ligar Agora
                    </button>
                </div>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-lightbulb"></i> Sugest√µes e Contribui√ß√µes</h3>
                <p>Valorizamos o feedback dos nossos utilizadores para melhorar continuamente a plataforma.</p>
                
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-bug"></i>
                        <div>
                            <strong>Reportar Problema</strong><br>
                            Encontrou um bug ou erro? Nos informe!
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fas fa-lightbulb"></i>
                        <div>
                            <strong>Sugest√£o de Melhoria</strong><br>
                            Tem ideias para melhorar a plataforma?
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fas fa-newspaper"></i>
                        <div>
                            <strong>Nova Fonte de Not√≠cias</strong><br>
                            Tem uma fonte de not√≠cias para sugerir?
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-highlight">
                <p><i class="fas fa-clock"></i> <strong>Resposta R√°pida:</strong> Respondemos a todos os contactos em at√© 24 horas √∫teis.</p>
            </div>
        </div>
        `;
    }
    
    // Atualiza t√≠tulo e √≠cone da modal
    modalTitle.textContent = title;
    modalIcon.className = `fas ${icon}`;
    document.getElementById("info-modal-body").innerHTML = content;
    
    // Mostra a modal
    infoModal.style.display = "flex";
    
    // Adiciona efeito de entrada
    setTimeout(() => {
        document.getElementById("info-modal-content").style.transform = "translateY(0)";
    }, 10);
}

function closeInfoModal() {
    infoModal.style.display = "none";
}

// Event Listeners para a modal info
infoModalClose.addEventListener('click', closeInfoModal);

infoModal.addEventListener('click', (e) => {
    if (e.target.id === 'info-modal') {
        closeInfoModal();
    }
});

// ========== SISTEMA DE SLUG E URLs ==========

// Gera um ID √∫nico para cada not√≠cia
function generateArticleId(title, source, date) {
    const str = `${title}-${source}-${date}`;
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash = hash & hash;
    }
    return Math.abs(hash).toString(36);
}

// Cria slug amig√°vel para URL
function createSlug(title) {
    return title
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
        .replace(/[^\w\s-]/g, '') // Remove caracteres especiais
        .replace(/\s+/g, '-')     // Substitui espa√ßos por h√≠fens
        .replace(/-+/g, '-')      // Remove m√∫ltiplos h√≠fens
        .trim()
        .substring(0, 80);        // Limita o tamanho
}

// Gera URL amig√°vel para a not√≠cia
function generateArticleUrl(article) {
    const slug = createSlug(article.title);
    return `${PLATFORM_URL}/leitura.html?id=${article.id}&slug=${slug}`;
}

// ========== RENDERIZA√á√ÉO EM TEMPO REAL ==========

// Determina categoria baseada no conte√∫do da not√≠cia
function determineCategory(title, content) {
    const text = (title + ' ' + content).toLowerCase();
    
    // Palavras-chave para cada categoria
    const keywords = {
        'sociedade': ['sociedade', 'social', 'comunidade', 'educa√ß√£o', 'escola', 'universidade', 
                     'aluno', 'professor', 'fam√≠lia', 'habita√ß√£o', 'bairro', 'comunit√°rio'],
        'pol√≠tica': ['pol√≠tica', 'pol√≠tico', 'governo', 'presidente', 'ministro', 'elei√ß√µes', 
                    'partido', 'parlamento', 'assembleia', 'diplomacia', 'embaixada', 'voto'],
        'economia': ['economia', 'econ√¥mico', 'neg√≥cio', 'empresa', 'investimento', 'banco', 
                    'finan√ßas', 'mercado', 'bolsa', 'imposto', 'crescimento', 'infla√ß√£o'],
        'esportes': ['esporte', 'futebol', 'jogo', 'atleta', 'campeonato', 'liga', 
                    'competi√ß√£o', 'gin√°sio', 'treino', 'sele√ß√£o', 'est√°dio', 'golo'],
        'cultura': ['cultura', 'cultural', 'arte', 'm√∫sica', 'teatro', 'cinema', 
                   'literatura', 'poesia', 'tradi√ß√£o', 'festival', 'exposi√ß√£o', 'artista'],
        'sa√∫de': ['sa√∫de', 'hospital', 'm√©dico', 'enfermeiro', 'doen√ßa', 'vacina', 
                 'tratamento', 'cl√≠nica', 'epidemia', 'pandemia', 'medicamento', 'cirurgia'],
        'tecnologia': ['tecnologia', 'tecnol√≥gico', 'internet', 'digital', 'aplicativo', 
                      'software', 'startup', 'inova√ß√£o', 'ci√™ncia', 'pesquisa', 'rob√¥', 'IA']
    };
    
    // Conta ocorr√™ncias para cada categoria
    let scores = {};
    Object.keys(keywords).forEach(cat => {
        scores[cat] = 0;
        keywords[cat].forEach(keyword => {
            if (text.includes(keyword)) {
                scores[cat]++;
            }
        });
    });
    
    // Encontra categoria com maior pontua√ß√£o
    let maxScore = 0;
    let selectedCategory = 'sociedade'; // default
    
    Object.keys(scores).forEach(cat => {
        if (scores[cat] > maxScore) {
            maxScore = scores[cat];
            selectedCategory = cat;
        }
    });
    
    // Se nenhuma palavra-chave foi encontrada, usa heur√≠stica baseada no t√≠tulo
    if (maxScore === 0) {
        if (title.toLowerCase().includes('futebol') || title.toLowerCase().includes('desporto')) {
            return 'esportes';
        } else if (title.toLowerCase().includes('econ') || title.toLowerCase().includes('neg√≥cio')) {
            return 'economia';
        } else if (title.toLowerCase().includes('arte') || title.toLowerCase().includes('m√∫sica')) {
            return 'cultura';
        } else if (title.toLowerCase().includes('hospital') || title.toLowerCase().includes('m√©dico')) {
            return 'sa√∫de';
        } else if (title.toLowerCase().includes('tech') || title.toLowerCase().includes('digital')) {
            return 'tecnologia';
        } else {
            // Distribui√ß√£o aleat√≥ria controlada para diversidade
            const categories = Object.keys(CATEGORIES).filter(cat => cat !== 'todos');
            return categories[Math.floor(Math.random() * categories.length)];
        }
    }
    
    return selectedCategory;
}

// Renderiza uma √∫nica not√≠cia imediatamente
function renderSingleNews(article) {
    if (container.querySelector(`[data-id="${article.id}"]`)) return;
    
    const category = article.category || determineCategory(article.title, article.content);
    article.category = category; // Armazena a categoria determinada
    
    // Gera URL amig√°vel
    const articleUrl = generateArticleUrl(article);
    
    const c = document.createElement("a");
    c.className = "card";
    c.dataset.id = article.id;
    c.dataset.category = category;
    c.href = articleUrl;
    
    c.innerHTML = `
    <div class="card-text">
        <div class="card-title">${article.title}</div>
        <div class="card-meta">
            <span class="source-tag">${article.source}</span>
            <span class="category-tag ${CATEGORIES[category].class}">${CATEGORIES[category].name}</span>
            <span>${formatDate(article.date)}</span>
        </div>
    </div>
    <img src="${article.image}" loading="lazy" alt="${article.title}" onerror="this.src='https://via.placeholder.com/120x85/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
    `;
    
    // Encontra a posi√ß√£o correta para manter ordena√ß√£o por data (mais recente primeiro)
    let inserted = false;
    const cards = container.querySelectorAll('.card');
    
    for (let i = 0; i < cards.length; i++) {
        const cardDate = new Date(cards[i].dataset.date || 0);
        const newDate = new Date(article.date);
        
        if (newDate > cardDate) {
            container.insertBefore(c, cards[i]);
            inserted = true;
            break;
        }
    }
    
    // Se n√£o encontrou posi√ß√£o (ou √© a primeira not√≠cia), adiciona no final
    if (!inserted) {
        container.appendChild(c);
    }
    
    // Armazena a data como atributo para futuras ordena√ß√µes
    c.dataset.date = article.date;
}

// ========== PROCESSAMENTO DE NOT√çCIAS ==========

// Processa artigos de uma fonte
async function processSourceArticles(source, articles) {
    const newArticles = [];
    
    for (const article of articles) {
        // Gera IDs √∫nicos
        const id = generateArticleId(article.title.rendered, source.name, article.date);
        const hash = (article.title.rendered + article.link).replace(/\W/g, "");
        
        if (hashes.has(hash)) continue;
        
        hashes.add(hash);
        
        // Cria objeto da not√≠cia
        const newsItem = {
            id: id,
            hash: hash,
            title: article.title.rendered,
            content: article.content.rendered,
            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   "https://via.placeholder.com/300x200",
            source: source.name,
            date: article.date || article.modified,
            originalLink: article.link,
            slug: createSlug(article.title.rendered),
            category: null // Ser√° determinado depois
        };
        
        newArticles.push(newsItem);
        
        // Armazena no localStorage
        storeArticle(newsItem);
    }
    
    // Ordena as novas not√≠cias por data (mais recente primeiro)
    newArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Adiciona √†s listas e renderiza cada uma
    for (const newsItem of newArticles) {
        news.push(newsItem);
        filteredNews.push(newsItem);
        
        // Renderiza IMEDIATAMENTE
        renderSingleNews(newsItem);
        
        // Pequena pausa para anima√ß√£o suave
        await new Promise(resolve => setTimeout(resolve, 30));
    }
}

// ========== CARREGAMENTO DE NOT√çCIAS ==========

// Carrega not√≠cias de uma fonte espec√≠fica
async function loadSource(source) {
    if (!source.hasMore || source.isFetching) return;
    
    source.isFetching = true;
    
    try {
        const url = `${source.baseUrl}?_embed&per_page=${BATCH_SIZE}&page=${source.currentPage}&t=${Date.now()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            if (response.status === 400) {
                source.hasMore = false;
            }
            throw new Error(`Erro ao buscar ${source.name}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
            source.hasMore = false;
            return;
        }
        
        source.currentPage++;
        
        // Processa e renderiza as not√≠cias
        await processSourceArticles(source, data);
        
    } catch (error) {
        console.error(`Erro ao carregar ${source.name}:`, error);
        source.hasMore = false;
    } finally {
        source.isFetching = false;
        checkAllSourcesLoaded();
    }
}

// Carrega not√≠cias de todas as fontes
async function loadAllSources() {
    // Limpa dados anteriores
    news = [];
    filteredNews = [];
    hashes.clear();
    allSourcesLoaded = false;
    
    // Limpa o container
    container.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Carregando not√≠cias...</div>';
    
    // Reseta fontes
    sources.forEach(source => {
        source.currentPage = 1;
        source.hasMore = true;
        source.isFetching = false;
    });
    
    // Carrega todas as fontes em paralelo
    const promises = sources.map(source => loadSource(source));
    
    await Promise.allSettled(promises);
    
    // Se nenhuma not√≠cia foi carregada, mostra mensagem
    if (news.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:40px; color:#666;">
                <i class="fas fa-newspaper" style="font-size:48px; margin-bottom:20px; color:#ccc;"></i>
                <h3>Nenhuma not√≠cia encontrada</h3>
                <p>Tente atualizar a p√°gina ou verifique sua conex√£o.</p>
                <button onclick="manualRefresh()" style="background:#1a73e8; color:white; border:none; padding:10px 20px; border-radius:8px; margin-top:15px; cursor:pointer;">Tentar novamente</button>
            </div>
        `;
    }
    
    reorderAllNewsByDate();
}

// Reordena todas as not√≠cias por data
function reorderAllNewsByDate() {
    news.sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredNews.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    container.innerHTML = '';
    filteredNews.forEach(article => {
        renderSingleNews(article);
    });
}

// Carrega mais not√≠cias (scroll infinito)
async function loadMoreNews() {
    if (isLoadingMore || allSourcesLoaded) return;
    
    isLoadingMore = true;
    infiniteLoader.style.display = 'block';
    
    let anySourceHasMore = false;
    const promises = [];
    
    for (const source of sources) {
        if (source.hasMore) {
            promises.push(loadSource(source));
            if (source.hasMore) anySourceHasMore = true;
        }
    }
    
    await Promise.allSettled(promises);
    allSourcesLoaded = !anySourceHasMore;
    
    isLoadingMore = false;
    infiniteLoader.style.display = 'none';
}

function checkAllSourcesLoaded() {
    allSourcesLoaded = sources.every(source => !source.hasMore);
    if (allSourcesLoaded) {
        infiniteLoader.style.display = 'none';
    }
}

// ========== CONTROLES ==========

function manualRefresh() {
    container.innerHTML = '';
    closeInfoModal();
    loadAllSources();
}

function openWhatsAppChannel() {
    window.open(WHATSAPP_CHANNEL_URL, '_blank', 'noopener,noreferrer');
    closeInfoModal();
}

// ========== SCROLL INFINITO ==========

let scrollTimeout;
const SCROLL_THRESHOLD = 300;

window.addEventListener("scroll", () => {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    
    scrollTimeout = setTimeout(() => {
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - SCROLL_THRESHOLD;
        
        if (scrollPosition >= threshold && !isLoadingMore && !allSourcesLoaded) {
            loadMoreNews();
        }
    }, 150);
});

// ========== INICIALIZA√á√ÉO ==========

// Inicializa o armazenamento
initializeStorage();

// Carrega not√≠cias existentes do localStorage para exibi√ß√£o r√°pida
function loadCachedArticles() {
    const storage = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (storage && storage.articles.length > 0) {
        // Exibe not√≠cias em cache primeiro
        news = [...storage.articles];
        filteredNews = [...storage.articles];
        
        // Ordena e renderiza
        reorderAllNewsByDate();
        
        // Mostra mensagem indicando que s√£o not√≠cias em cache
        const firstCard = container.querySelector('.card');
        if (firstCard) {
            container.insertAdjacentHTML('afterbegin', 
                '<div style="text-align:center; padding:10px; background:#e8f0fe; color:#1a73e8; border-radius:8px; margin:10px; font-size:14px;"><i class="fas fa-sync-alt"></i> Carregando not√≠cias mais recentes...</div>'
            );
        }
    }
}

// Inicia o carregamento
loadCachedArticles();
loadAllSources();

// Atualiza a cada 5 minutos
setInterval(() => {
    if (document.visibilityState === 'visible' && !isLoadingMore) {
        loadMoreNews();
    }
}, 300000);

// ========== ATALHOS DE TECLADO ==========

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeInfoModal();
        closeSidebar();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById("search-input").focus();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        manualRefresh();
    }
});
</script>
</body>
</html>