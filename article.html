<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carregando... | Not√≠cias CLD</title>
    <meta name="description" content="Lendo not√≠cia">
    
    <!-- Open Graph -->
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Not√≠cias CLD">
    <meta property="og:url" id="og-url">
    
    <!-- JSON-LD para SEO -->
    <script type="application/ld+json" id="article-jsonld"></script>
    
    <!-- Styles -->
    <style>
    /* Estilos otimizados do artigo (similar ao anterior, mas mais robusto) */
    :root {
        --primary-color: #1a73e8;
        --primary-dark: #0d62d9;
        --text-primary: #202124;
        --text-secondary: #5f6368;
        --border-color: #dadce0;
        --background: #ffffff;
    }
    
    /* Sistema de fallback de links */
    .link-status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }
    
    .link-status.warning {
        background: #fff3cd;
        border-color: #ffc107;
    }
    
    .link-status.error {
        background: #f8d7da;
        border-color: #dc3545;
    }
    
    .link-status.success {
        background: #d1e7dd;
        border-color: #198754;
    }
    
    .fallback-options {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .fallback-btn {
        padding: 8px 16px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .fallback-btn:hover {
        background: var(--primary-dark);
    }
    </style>
</head>
<body>
    <div id="app">
        <!-- Conte√∫do ser√° carregado aqui -->
    </div>
    
    <script>
    // ============================================
    // SISTEMA DE RECUPERA√á√ÉO DE ARTIGO INFAL√çVEL
    // ============================================
    
    class ArticleRecoverySystem {
        constructor() {
            this.strategies = [
                this.strategySessionStorage,
                this.strategyURLParams,
                this.strategyLocalStorage,
                this.strategyIndexedDB,
                this.strategyAPI,
                this.strategyFallbackContent
            ];
        }
        
        async recoverArticle() {
            console.log('üîç Iniciando recupera√ß√£o de artigo...');
            
            for (const strategy of this.strategies) {
                try {
                    console.log(`Tentando estrat√©gia: ${strategy.name}`);
                    const article = await strategy.call(this);
                    
                    if (article && this.validateArticle(article)) {
                        console.log(`‚úÖ Artigo recuperado via ${strategy.name}`);
                        return article;
                    }
                } catch (error) {
                    console.warn(`Estrat√©gia ${strategy.name} falhou:`, error);
                }
            }
            
            throw new Error('N√£o foi poss√≠vel recuperar o artigo');
        }
        
        // Estrat√©gia 1: Session Storage (mais recente)
        async strategySessionStorage() {
            const sessionData = sessionStorage.getItem('currentArticle');
            if (!sessionData) return null;
            
            return JSON.parse(sessionData);
        }
        
        // Estrat√©gia 2: Par√¢metros da URL
        async strategyURLParams() {
            const params = new URLSearchParams(window.location.search);
            const articleId = params.get('id');
            
            if (!articleId) return null;
            
            // Busca no cache global
            return await this.getFromGlobalCache(articleId);
        }
      // Estrat√©gia 3: Local Storage
        async strategyLocalStorage() {
            const backups = JSON.parse(localStorage.getItem('articleBackups') || '{}');
            const params = new URLSearchParams(window.location.search);
            const articleId = params.get('id');
            
            if (articleId && backups[articleId]) {
                return backups[articleId];
            }
            
            // Tenta pelo t√≠tulo
            const titleSlug = params.get('title');
            if (titleSlug) {
                for (const id in backups) {
                    if (this.slugify(backups[id].title) === titleSlug) {
                        return backups[id];
                    }
                }
            }
            
            return null;
        }
        
        // Estrat√©gia 4: IndexedDB
        async strategyIndexedDB() {
            if (!('indexedDB' in window)) return null;
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('NoticiasCLD', 1);
                
                request.onerror = reject;
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['articles'], 'readonly');
                    const store = transaction.objectStore('articles');
                    
                    const params = new URLSearchParams(window.location.search);
                    const articleId = params.get('id');
                    
                    if (!articleId) {
                        resolve(null);
                        return;
                    }
                    
                    const getRequest = store.get(articleId);
                    getRequest.onsuccess = () => resolve(getRequest.result);
                    getRequest.onerror = reject;
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('articles')) {
                        db.createObjectStore('articles', { keyPath: 'id' });
                    }
                };
            });
        }
        
        // Estrat√©gia 5: API
        async strategyAPI() {
            const params = new URLSearchParams(window.location.search);
            const articleId = params.get('id');
            
            if (!articleId) return null;
            
            try {
                const response = await fetch(`/api/article/${articleId}`, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.warn('API falhou:', error);
            }
            
            return null;
        }
        
        // Estrat√©gia 6: Conte√∫do de fallback
        async strategyFallbackContent() {
            const params = new URLSearchParams(window.location.search);
            
            // Tenta reconstruir do m√≠nimo de informa√ß√µes
            return {
                id: params.get('id') || 'fallback_' + Date.now(),
                title: decodeURIComponent(params.get('title') || 'Not√≠cia n√£o dispon√≠vel'),
                excerpt: 'Esta not√≠cia n√£o est√° mais dispon√≠vel em cache.',
                content: this.generateFallbackContent(params),
                source: params.get('source') || 'Fonte desconhecida',
                date: new Date(parseInt(params.get('date')) || Date.now()),
                category: params.get('category') || 'geral',
                fallback: true
            };
        }
        
        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================
        
        async getFromGlobalCache(articleId) {
            // Tenta m√∫ltiplas fontes de cache
            const cacheSources = [
                () => localStorage.getItem(`article_${articleId}`),
                () => sessionStorage.getItem(`article_${articleId}`),
                () => this.getFromServiceWorkerCache(articleId)
            ];
            
            for (const source of cacheSources) {
                try {
                    const data = await source();
                    if (data) return JSON.parse(data);
                } catch (error) {
                    // Continua para pr√≥xima fonte
                }
            }
            
            return null;
        }
        
        async getFromServiceWorkerCache(articleId) {
            if (!navigator.serviceWorker) return null;
            
            const registration = await navigator.serviceWorker.ready;
            const cache = await caches.open('articles-v1');
            const response = await cache.match(`/api/article/${articleId}`);
            
            if (response) {
                return await response.json();
            }
            
            return null;
        }
        
        generateFallbackContent(params) {
            const originalUrl = params.get('original_url');
            const source = params.get('source');
            
            return `
                <div class="link-status error">
                    <h3>‚ö†Ô∏è Conte√∫do N√£o Dispon√≠vel</h3>
                    <p>Esta not√≠cia n√£o est√° mais dispon√≠vel em nossos servidores.</p>
                    
                    ${originalUrl ? `
                    <p><strong>URL Original:</strong> ${originalUrl}</p>
                    <div class="fallback-options">
                        <button class="fallback-btn" onclick="tryOriginalLink('${originalUrl}')">
                            Tentar link original
                        </button>
                        <button class="fallback-btn" onclick="tryArchive('${originalUrl}')">
                            Ver em arquivo
                        </button>
                    </div>
                    ` : ''}
                    
                    ${source ? `<p><strong>Fonte:</strong> ${source}</p>` : ''}
                    
                    <p><em>Esta √© uma vers√£o de fallback. Algumas funcionalidades podem estar limitadas.</em></p>
                </div>
            `;
        }
        
        slugify(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }
        
        validateArticle(article) {
            return article && 
                   article.id && 
                   article.title && 
                   article.title.length > 5 &&
                   article.date;
        }
    }
        // ============================================
    // SISTEMA DE VERIFICA√á√ÉO DE LINKS
    // ============================================
    
    class LinkVerificationSystem {
        constructor() {
            this.verifiedLinks = new Map();
        }
        
        async verifyLink(url, article) {
            const linkId = this.generateLinkId(url, article);
            
            // Verifica cache
            if (this.verifiedLinks.has(linkId)) {
                return this.verifiedLinks.get(linkId);
            }
            
            // Realiza verifica√ß√£o
            const result = await this.performVerification(url, article);
            
            // Armazena resultado
            this.verifiedLinks.set(linkId, result);
            this.storeVerificationResult(linkId, result);
            
            return result;
        }
        
        async performVerification(url, article) {
            const checks = [
                this.checkURLValidity,
                this.checkContentAvailability,
                this.checkArchiveStatus,
                this.checkAlternativeSources
            ];
            
            const results = {
                url: url,
                status: 'unknown',
                alternatives: [],
                timestamp: Date.now(),
                articleId: article?.id
            };
            
            for (const check of checks) {
                try {
                    const checkResult = await check.call(this, url, article);
                    Object.assign(results, checkResult);
                    
                    if (results.status === 'available') {
                        break;
                    }
                } catch (error) {
                    console.warn(`Check ${check.name} falhou:`, error);
                }
            }
            
            return results;
        }
        
        async checkURLValidity(url) {
            try {
                const urlObj = new URL(url);
                
                // Verifica protocolo
                if (!['http:', 'https:'].includes(urlObj.protocol)) {
                    return { status: 'invalid_protocol' };
                }
                
                // Verifica dom√≠nio
                if (!urlObj.hostname) {
                    return { status: 'invalid_domain' };
                }
                
                return { status: 'url_valid' };
            } catch (error) {
                return { status: 'invalid_url' };
            }
        }
        
        async checkContentAvailability(url) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(url, {
                    method: 'HEAD',
                    signal: controller.signal,
                    headers: {
                        'User-Agent': 'NoticiasCLD-LinkChecker/2.0'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    return { 
                        status: 'available',
                        contentType: response.headers.get('content-type'),
                        lastModified: response.headers.get('last-modified')
                    };
                } else {
                    return { status: 'unavailable', statusCode: response.status };
                }
            } catch (error) {
                return { status: 'unreachable', error: error.message };
            }
        }
        
        async checkArchiveStatus(url) {
            try {
                // Verifica Wayback Machine
                const waybackUrl = `https://archive.org/wayback/available?url=${encodeURIComponent(url)}`;
                const response = await fetch(waybackUrl, { timeout: 3000 });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.archived_snapshots?.closest) {
                        return {
                            status: 'archived',
                            archiveUrl: data.archived_snapshots.closest.url,
                            archiveDate: data.archived_snapshots.closest.timestamp
                        };
                    }
                }
            } catch (error) {
                // Ignora erros de arquivo
            }
            
            return { status: 'not_archived' };
        }
        
        async checkAlternativeSources(url) {
            const alternatives = [];
            
            try {
                // Google Cache
                alternatives.push({
                    source: 'Google Cache',
                    url: `https://webcache.googleusercontent.com/search?q=cache:${encodeURIComponent(url)}`,
                    type: 'cache'
                });
         // Archive.is
                alternatives.push({
                    source: 'Archive.is',
                    url: `https://archive.is/newest/${url}`,
                    type: 'archive'
                });
                
                // Verifica cada alternativa
                for (const alt of alternatives) {
                    try {
                        const response = await fetch(alt.url, { method: 'HEAD', timeout: 2000 });
                        alt.available = response.ok;
                    } catch (error) {
                        alt.available = false;
                    }
                }
                
                return { alternatives: alternatives.filter(a => a.available) };
            } catch (error) {
                return { alternatives: [] };
            }
        }
        
        generateLinkId(url, article) {
            return btoa(`${url}|${article?.id || 'unknown'}|${Date.now()}`)
                .replace(/[+/=]/g, '')
                .substring(0, 20);
        }
        
        storeVerificationResult(linkId, result) {
            try {
                const verifications = JSON.parse(localStorage.getItem('linkVerifications') || '{}');
                verifications[linkId] = {
                    ...result,
                    stored: Date.now()
                };
                
                // Limita tamanho
                const keys = Object.keys(verifications);
                if (keys.length > 100) {
                    const oldest = keys.sort((a, b) => 
                        verifications[a].stored - verifications[b].stored
                    )[0];
                    delete verifications[oldest];
                }
                
                localStorage.setItem('linkVerifications', JSON.stringify(verifications));
            } catch (error) {
                console.warn('Erro ao armazenar verifica√ß√£o:', error);
            }
        }
        
        displayLinkStatus(result, container) {
            if (!container) return;
            
            let statusHtml = '';
            
            switch (result.status) {
                case 'available':
                    statusHtml = `
                        <div class="link-status success">
                            <p>‚úÖ Link verificado e dispon√≠vel</p>
                            ${result.lastModified ? 
                                `<small>√öltima modifica√ß√£o: ${new Date(result.lastModified).toLocaleDateString()}</small>` : ''}
                        </div>
                    `;
                    break;
                    
                case 'archived':
                    statusHtml = `
                        <div class="link-status warning">
                            <p>üìö Link dispon√≠vel apenas em arquivo</p>
                            <p>Este conte√∫do foi arquivado em ${new Date(result.archiveDate).toLocaleDateString()}</p>
                            <div class="fallback-options">
                                <a href="${result.archiveUrl}" target="_blank" class="fallback-btn">
                                    Abrir vers√£o arquivada
                                </a>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'unavailable':
                    statusHtml = `
                        <div class="link-status error">
                            <p>‚ùå Link n√£o dispon√≠vel (Erro ${result.statusCode})</p>
                            ${this.displayAlternatives(result.alternatives)}
                        </div>
                    `;
                    break;
                    
                default:
                    statusHtml = `
                        <div class="link-status warning">
                            <p>‚ö†Ô∏è Status do link desconhecido</p>
                            ${this.displayAlternatives(result.alternatives)}
                        </div>
                    `;
            }
            
            container.innerHTML = statusHtml;
        }
        
        displayAlternatives(alternatives) {
            if (!alternatives || alternatives.length === 0) {
                return '<p>Nenhuma alternativa dispon√≠vel no momento.</p>';
            }
            
            return `
                <p><strong>Alternativas dispon√≠veis:</strong></p>
                <div class="fallback-options">
                    ${alternatives.map(alt => `
                        <a href="${alt.url}" target="_blank" class="fallback-btn">
                            ${alt.source}
                        </a>
                    `).join('')}
                </div>
            `;
        }
    }
    
    // ============================================
    // INICIALIZA√á√ÉO DO SISTEMA
    // ============================================
    
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Mostra estado de carregamento
            document.getElementById('app').innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <div style="
                        width: 40px;
                        height: 40px;
                        border: 3px solid #1a73e8;
                        border-top-color: transparent;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 20px;
                    "></div>
                    <p style="color: #5f6368;">Carregando not√≠cia...</p>
                    <p style="font-size: 12px; color: #9aa0a6; margin-top: 10px;">
                        Sistema de recupera√ß√£o ativado
                    </p>
                </div>
            `;
            
            // Inicia sistemas
            const recoverySystem = new ArticleRecoverySystem();
            const verificationSystem = new LinkVerificationSystem();
            
            // Recupera artigo
            const article = await recoverySystem.recoverArticle();
            
            if (!article) {
                throw new Error('Artigo n√£o encontrado');
            }
           // Verifica links se n√£o for fallback
            let linkStatus = null;
            if (!article.fallback && article.originalUrl) {
                linkStatus = await verificationSystem.verifyLink(article.originalUrl, article);
            }
            
            // Renderiza artigo
            renderArticle(article, linkStatus, verificationSystem);
            
            // Atualiza SEO
            updateSEO(article);
            
            // Salva no hist√≥rico
            saveToHistory(article);
            
            console.log('‚úÖ Artigo carregado com sucesso:', article.id);
            
        } catch (error) {
            console.error('‚ùå Erro ao carregar artigo:', error);
            showError(error.message);
        }
    });
    
    // ============================================
    // FUN√á√ïES DE RENDERIZA√á√ÉO
    // ============================================
    
    function renderArticle(article, linkStatus, verificationSystem) {
        const app = document.getElementById('app');
        
        const html = `
            <article>
                <header style="
                    background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
                                url('${article.image}') center/cover;
                    color: white;
                    padding: 40px 20px;
                    text-align: center;
                ">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <h1 style="
                            font-size: 2.5rem;
                            margin-bottom: 20px;
                            line-height: 1.2;
                        ">${article.title}</h1>
                        
                        <div style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            gap: 20px;
                            flex-wrap: wrap;
                            margin-top: 30px;
                            opacity: 0.9;
                        ">
                            <span style="
                                background: rgba(255,255,255,0.2);
                                padding: 5px 15px;
                                border-radius: 20px;
                                font-size: 0.9rem;
                            ">${article.source}</span>
                            
                            <span>${formatDate(article.date)}</span>
                            
                            <span>‚Ä¢</span>
                            
                            <span>${article.readTime || 5} min de leitura</span>
                            
                            <button onclick="toggleSave('${article.id}')" 
                                    style="
                                        background: none;
                                        border: 1px solid white;
                                        color: white;
                                        padding: 5px 15px;
                                        border-radius: 20px;
                                        cursor: pointer;
                                    ">
                                ${isSaved(article.id) ? '‚úì Guardado' : 'Guardar'}
                            </button>
                        </div>
                    </div>
                </header>
                
                <main style="
                    max-width: 800px;
                    margin: 40px auto;
                    padding: 0 20px;
                    line-height: 1.8;
                ">
                    ${linkStatus ? '<div id="link-status-container"></div>' : ''}
                    
                    ${article.fallback ? 
                        `<div class="link-status warning" style="margin-bottom: 30px;">
                            <p><strong>Aviso:</strong> Esta √© uma vers√£o de fallback da not√≠cia.</p>
                        </div>` : ''}
                    
                    <div style="font-size: 1.1rem;">
                        ${article.content}
                    </div>
                    
                    ${article.originalUrl && !article.fallback ? `
                        <div style="
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #eee;
                            text-align: center;
                        ">
                            <a href="${article.originalUrl}" 
                               target="_blank"
                               style="
                                    display: inline-block;
                                    background: #1a73e8;
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 5px;
                                    text-decoration: none;
                               ">
                                Ver not√≠cia original
                            </a>
                        </div>
                    ` : ''}
                </main>
     <footer style="
                    max-width: 800px;
                    margin: 40px auto;
                    padding: 40px 20px;
                    border-top: 1px solid #eee;
                ">
                    <h2 style="margin-bottom: 20px;">Mais Not√≠cias</h2>
                    <div id="related-articles" style="
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                        gap: 20px;
                    ">
                        <!-- Artigos relacionados ser√£o carregados aqui -->
                    </div>
                </footer>
            </article>
        `;
        
        app.innerHTML = html;
        
        // Exibe status do link se dispon√≠vel
        if (linkStatus && verificationSystem) {
            const container = document.getElementById('link-status-container');
            verificationSystem.displayLinkStatus(linkStatus, container);
        }
        
        // Carrega artigos relacionados
        loadRelatedArticles(article);
    }
    
    function showError(message) {
        document.getElementById('app').innerHTML = `
            <div style="
                max-width: 600px;
                margin: 100px auto;
                padding: 40px;
                text-align: center;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            ">
                <h2 style="color: #dc3545; margin-bottom: 20px;">‚ùå Erro ao carregar</h2>
                <p style="color: #666; margin-bottom: 30px;">${message}</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="window.history.back()" style="
                        padding: 10px 20px;
                        background: #6c757d;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                    ">
                        Voltar
                    </button>
                    <button onclick="window.location.href = '/'" style="
                        padding: 10px 20px;
                        background: #1a73e8;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                    ">
                        P√°gina Inicial
                    </button>
                </div>
            </div>
        `;
    }
    
    // ============================================
    // FUN√á√ïES AUXILIARES
    // ============================================
    
    function formatDate(date) {
        return new Date(date).toLocaleDateString('pt-PT', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    function isSaved(articleId) {
        try {
            const saved = JSON.parse(localStorage.getItem('savedArticles') || '[]');
            return saved.includes(articleId);
        } catch (error) {
            return false;
        }
    }
    
    function toggleSave(articleId) {
        try {
            const saved = JSON.parse(localStorage.getItem('savedArticles') || '[]');
            const index = saved.indexOf(articleId);
            
            if (index > -1) {
                saved.splice(index, 1);
                showMessage('Removido dos guardados');
            } else {
                saved.push(articleId);
                showMessage('Not√≠cia guardada');
            }
            
            localStorage.setItem('savedArticles', JSON.stringify(saved));
            
            // Atualiza bot√£o
            const button = document.querySelector(`button[onclick="toggleSave('${articleId}')"]`);
            if (button) {
                button.textContent = isSaved(articleId) ? '‚úì Guardado' : 'Guardar';
            }
            
        } catch (error) {
            showMessage('Erro ao guardar not√≠cia', 'error');
        }
    }
    
    function showMessage(message, type = 'success') {
        // Implementar sistema de notifica√ß√£o
        alert(message);
    }
    
    function updateSEO(article) {
        // Atualiza t√≠tulo
        document.title = `${article.title} | Not√≠cias CLD`;
        
        // Atualiza meta description
        const description = document.querySelector('meta[name="description"]');
        if (description) {
            description.setAttribute('content', 
                article.excerpt || article.title.substring(0, 160));
        }
        
        // Atualiza Open Graph
        const ogTitle = document.querySelector('meta[property="og:title"]');
        if (ogTitle) ogTitle.setAttribute('content', article.title);
        
        const ogDescription = document.querySelector('meta[property="og:description"]');
        if (ogDescription) ogDescription.setAttribute('content', article.excerpt);
        
        const ogImage = document.querySelector('meta[property="og:image"]');
        if (ogImage) ogImage.setAttribute('content', article.image);
        
        const ogUrl = document.querySelector('meta[property="og:url"]');
        if (ogUrl) ogUrl.setAttribute('content', window.location.href);
        
        // Schema.org JSON-LD
        const jsonLd = {
            "@context": "https://schema.org",
            "@type": "NewsArticle",
            "headline": article.title,
            "description": article.excerpt,
            "image": article.image,
            "datePublished": article.date.toISOString(),
            "dateModified": article.date.toISOString(),
            "author": {
                "@type": "Organization",
                "name": article.source
            },
            "publisher": {
                "@type": "Organization",
                "name": "Not√≠cias CLD",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://seusite.com/logo.png"
                }
            },
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": window.location.href
            }
        };
        
        const script = document.getElementById('article-jsonld');
        if (script) {
            script.textContent = JSON.stringify(jsonLd);
        }
    }
    
    function saveToHistory(article) {
        try {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            
            // Remove se j√° existir
            const index = history.findIndex(item => item.id === article.id);
            if (index > -1) {
                history.splice(index, 1);
            }
            
            // Adiciona no in√≠cio
            history.unshift({
                id: article.id,
                title: article.title,
                source: article.source,
                url: window.location.href,
                date: new Date().toISOString()
            });
            
            // Limita tamanho
            if (history.length > 100) {
                history.pop();
            }
            
            localStorage.setItem('readingHistory', JSON.stringify(history));
        } catch (error) {
            console.warn('Erro ao salvar hist√≥rico:', error);
        }
    }
    
    async function loadRelatedArticles(currentArticle) {
        try {
            // Tenta carregar artigos relacionados do cache
            const allArticles = JSON.parse(localStorage.getItem('articlesCache') || '{}');
            if (!allArticles.articles || allArticles.articles.length === 0) {
                return;
            }
            
            // Filtra artigos relacionados (mesma categoria ou fonte)
            const related = allArticles.articles
                .filter(article => 
                    article.id !== currentArticle.id &&
                    (article.category === currentArticle.category || 
                     article.source === currentArticle.source)
                )
                .slice(0, 6)
                .map(article => ({
                    ...article,
                    date: new Date(article.date)
                }));
            
            if (related.length === 0) return;
            
            // Renderiza artigos relacionados
            const container = document.getElementById('related-articles');
            if (!container) return;
            
            container.innerHTML = related.map(article => `
                <div style="
                    border: 1px solid #eee;
                    border-radius: 8px;
                    overflow: hidden;
                    cursor: pointer;
                    transition: transform 0.2s;
                " onclick="openRelatedArticle('${article.id}', '${encodeURIComponent(article.title)}')">
                    ${article.image ? `
                        <img src="${article.image}" 
                             alt="${article.title}"
                             style="width: 100%; height: 150px; object-fit: cover;">
                    ` : ''}
                    
                    <div style="padding: 15px;">
                        <h3 style="
                            font-size: 1rem;
                            margin-bottom: 10px;
                            line-height: 1.3;
                            display: -webkit-box;
                            -webkit-line-clamp: 3;
                            -webkit-box-orient: vertical;
                            overflow: hidden;
                        ">${article.title}</h3>
                        
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            font-size: 0.8rem;
                            color: #666;
                        ">
                            <span>${article.source}</span>
                            <span>${formatTimeAgo(article.date)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
        } catch (error) {
            console.warn('Erro ao carregar artigos relacionados:', error);
        }
    }
    
    function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / 86400000);
        if (diffDays === 0) return 'Hoje';
        if (diffDays === 1) return 'Ontem';
        if (diffDays < 7) return `${diffDays} dias`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} sem`;
        
        return date.toLocaleDateString('pt-PT', { 
            month: 'short', 
            day: 'numeric' 
        });
    }
    
    function openRelatedArticle(articleId, title) {
        // Abre artigo relacionado em nova aba
        window.open(`/article.html?id=${articleId}&title=${title}`, '_blank');
    }
    
    // ============================================
    // FUN√á√ïES DE FALLBACK (para exibi√ß√£o)
    // ============================================
    
    function tryOriginalLink(url) {
        window.open(url, '_blank');
    }
    
    function tryArchive(url) {
        const archiveUrl = `https://web.archive.org/web/${url}`;
        window.open(archiveUrl, '_blank');
    }
    
    // Exporta fun√ß√µes globais
    window.toggleSave = toggleSave;
    window.tryOriginalLink = tryOriginalLink;
    window.tryArchive = tryArchive;
    window.openRelatedArticle = openRelatedArticle;
    
    console.log('‚úÖ Sistema de artigo inicializado');
    </script>
</body>
</html>