<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notícias CLD - Leitura</title>
<meta name="description" content="Leia notícias completas de Moçambique">
<meta name="robots" content="index, follow">
<style>
/* CSS ORIGINAL MANTIDO INTEGRALMENTE */
body{
    font-family:Arial,sans-serif;
    background:#f2f3f5;
    margin:0;
    color:#111;
}

/* HEADER */
header{
    background:#1a73e8;
    color:white;
    padding:18px;
    text-align:center;
    font-size:20px;
    font-weight:bold;
    position:relative;
}

.header-btn{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    background:white;
    color:#1a73e8;
    border:none;
    padding:7px 12px;
    border-radius:8px;
    cursor:pointer;
    font-size:18px;
    font-weight:bold;
    transition: all 0.3s;
}

.header-btn:hover {
    opacity: 0.9;
    transform: translateY(-50%) scale(1.05);
}

#back-btn{ left:15px; }

/* CONTEÚDO PRINCIPAL */
#news-content {
    max-width:950px;
    margin:30px auto;
    padding:20px;
    background:white;
    border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,.08);
}

.news-header {
    margin-bottom:25px;
    padding-bottom:20px;
    border-bottom:2px solid #e8f0fe;
}

.news-title {
    font-size:24px;
    font-weight:bold;
    color:#111;
    margin-bottom:15px;
    line-height:1.4;
}

.news-meta {
    display:flex;
    align-items:center;
    gap:15px;
    flex-wrap:wrap;
    color:#666;
    font-size:14px;
}

.source-tag{
    background:#e8f0fe;
    color:#1a73e8;
    padding:4px 12px;
    border-radius:12px;
    font-size:12px;
    font-weight:bold;
}

.category-tag {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.sociedade-tag {
    background: rgba(76, 175, 80, 0.1);
    color: #2e7d32;
}

.politica-tag {
    background: rgba(244, 67, 54, 0.1);
    color: #c62828;
}

.economia-tag {
    background: rgba(255, 152, 0, 0.1);
    color: #ef6c00;
}

.esportes-tag {
    background: rgba(33, 150, 243, 0.1);
    color: #1565c0;
}

.cultura-tag {
    background: rgba(156, 39, 176, 0.1);
    color: #7b1fa2;
}

.saude-tag {
    background: rgba(0, 150, 136, 0.1);
    color: #00796b;
}

.tech-tag {
    background: rgba(96, 125, 139, 0.1);
    color: #37474f;
}

.news-image {
    width:100%;
    max-height:400px;
    object-fit:cover;
    border-radius:10px;
    margin:20px 0;
}

.news-body {
    line-height:1.8;
    font-size:16px;
    color:#333;
    margin:30px 0;
}

.news-body img {
    max-width:100%;
    height:auto;
    border-radius:8px;
    margin:15px 0;
}

.news-body iframe,
.news-body video {
    max-width:100%;
    border-radius:8px;
    margin:15px 0;
}

/* SHARE SECTION */
.share-section {
    margin:40px 0;
    padding:25px;
    background:#f8f9fa;
    border-radius:12px;
    border-left:4px solid #1a73e8;
}

.share-title {
    font-size:18px;
    color:#1a73e8;
    margin-bottom:20px;
    font-weight:bold;
}

.share-buttons {
    display:flex;
    gap:12px;
    flex-wrap:wrap;
}

.share-btn {
    flex:1;
    min-width:120px;
    padding:12px 20px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-size:14px;
    font-weight:500;
    transition:all 0.3s;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
}

.share-btn:hover {
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
}

.share-btn.facebook {
    background:#1877f2;
    color:white;
}

.share-btn.twitter {
    background:#1da1f2;
    color:white;
}

.share-btn.whatsapp {
    background:#25d366;
    color:white;
}

.share-btn.link {
    background:#6c757d;
    color:white;
}

.share-btn.link.copied {
    background:#28a745;
}

/* RELATED NEWS */
.related-news-section {
    margin-top:50px;
    padding-top:30px;
    border-top:2px solid #e8f0fe;
}

.related-news-title {
    font-size:20px;
    color:#1a73e8;
    margin-bottom:25px;
    font-weight:bold;
}

.related-news-container {
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
    gap:20px;
    margin-top:15px;
}

.related-news-card {
    background:#f8f9fa;
    border-radius:10px;
    padding:15px;
    border-left:4px solid #1a73e8;
    cursor:pointer;
    transition:all 0.3s;
    text-decoration:none;
    color:inherit;
}

.related-news-card:hover {
    background:#e8f0fe;
    transform:translateY(-3px);
    text-decoration:none;
    color:inherit;
}

.related-news-card img {
    width:100%;
    height:150px;
    object-fit:cover;
    border-radius:6px;
    margin-bottom:12px;
}

.related-news-card h3 {
    font-size:16px;
    font-weight:600;
    color:#111;
    margin-bottom:8px;
    line-height:1.3;
}

.related-news-meta {
    font-size:12px;
    color:#666;
    display:flex;
    align-items:center;
    gap:8px;
}

/* LOADER */
.loader {
    text-align:center;
    padding:60px 20px;
}

.spinner {
    display:inline-block;
    width:40px;
    height:40px;
    border:4px solid #e8e8e8;
    border-top:4px solid #1a73e8;
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-bottom:20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    text-align:center;
    padding:60px 20px;
    color:#666;
}

.error-message h2 {
    color:#dc3545;
    margin-bottom:15px;
}

.error-message a {
    display:inline-block;
    margin-top:20px;
    padding:10px 20px;
    background:#1a73e8;
    color:white;
    text-decoration:none;
    border-radius:8px;
    font-weight:bold;
}

.error-message a:hover {
    background:#0d62d9;
}

/* QUICK ACTIONS */
.quick-actions {
    display:flex;
    gap:10px;
    margin-top:20px;
    flex-wrap:wrap;
}

.action-btn {
    padding:8px 15px;
    background:#e8f0fe;
    border:1px solid #dce6f5;
    color:#1a73e8;
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:8px;
    transition:all 0.3s;
}

.action-btn:hover {
    background:#1a73e8;
    color:white;
}

/* NOTIFICATION */
.notification {
    position:fixed;
    top:20px;
    right:20px;
    background:white;
    border-left:4px solid #1a73e8;
    padding:15px 20px;
    border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    z-index:10000;
    display:flex;
    align-items:center;
    gap:10px;
    transform:translateX(120%);
    transition:transform 0.3s ease;
}

.notification.show {
    transform:translateX(0);
}

.notification.success {
    border-left-color:#34a853;
}

.notification.error {
    border-left-color:#ea4335;
}

.notification i {
    font-size:20px;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header>
<button class="header-btn" id="back-btn" onclick="goBack()">← Voltar</button>
Notícias CLD
<div style="width:70px;"></div>
</header>

<div id="news-content">
<div id="loader" class="loader">
    <div class="spinner"></div>
    <p>Carregando notícia...</p>
</div>

<div id="news-container" style="display:none;"></div>

<div id="error-message" class="error-message" style="display:none;">
    <h2><i class="fas fa-exclamation-triangle"></i> Notícia não encontrada</h2>
    <p>A notícia que você está procurando não foi encontrada.</p>
    <p><small>Verifique se o link está correto ou tente novamente mais tarde.</small></p>
    <div class="quick-actions">
        <a href="/">← Página Inicial</a>
        <button class="action-btn" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Recarregar
        </button>
    </div>
</div>
</div>

<div class="notification" id="notification">
    <i class="fas fa-info-circle"></i>
    <span id="notification-text"></span>
</div>

<script>
// ========== SISTEMA DE NOTIFICAÇÃO ==========
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    const text = document.getElementById('notification-text');
    
    notification.className = `notification ${type}`;
    text.textContent = message;
    
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// ========== CACHE INTELIGENTE ==========
class NewsCache {
    constructor() {
        this.cache = new Map();
        this.initCache();
    }
    
    initCache() {
        try {
            const cached = localStorage.getItem('news_cache_v2');
            if (cached) {
                const data = JSON.parse(cached);
                data.forEach(item => {
                    this.cache.set(item.id, item);
                });
            }
        } catch (e) {
            console.warn('Erro ao carregar cache:', e);
        }
    }
    
    get(id) {
        return this.cache.get(id);
    }
    
    // Busca inteligente por múltiplos critérios
    findNews(searchId, title, source) {
        // 1. Busca direta por ID
        if (searchId && this.cache.has(searchId)) {
            return this.cache.get(searchId);
        }
        
        // 2. Busca por título similar
        if (title) {
            const searchTitle = decodeURIComponent(title).toLowerCase();
            for (const [id, article] of this.cache) {
                if (article.title.toLowerCase().includes(searchTitle.substring(0, 50))) {
                    return article;
                }
            }
        }
        
        // 3. Busca por fonte e título
        if (source && title) {
            const searchSource = decodeURIComponent(source).toLowerCase();
            const searchTitle = decodeURIComponent(title).toLowerCase();
            
            for (const [id, article] of this.cache) {
                if (article.source.toLowerCase().includes(searchSource) &&
                    article.title.toLowerCase().includes(searchTitle.substring(0, 40))) {
                    return article;
                }
            }
        }
        
        return null;
    }
}

const newsCache = new NewsCache();

// ========== FUNÇÕES UTILITÁRIAS ==========
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        n: params.get('n'), // ID
        t: params.get('t'), // Título
        s: params.get('s')  // Fonte
    };
}

function formatDate(d) {
    if (!d) return '';
    try {
        const date = new Date(d);
        return date.toLocaleDateString("pt-PT", {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return d;
    }
}

function goBack() {
    if (window.history.length > 1) {
        history.back();
    } else {
        window.location.href = '/';
    }
}

function copyLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        showNotification('Link copiado!', 'success');
    }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Link copiado!', 'success');
    });
}

function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`, '_blank');
}

function shareOnTwitter() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://twitter.com/intent/tweet?text=${title}&url=${url}`, '_blank');
}

function shareOnWhatsApp() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://wa.me/?text=${title}%20-%20${url}`, '_blank');
}

// ========== BUSCA EM FONTES EXTERNAS ==========
async function fetchFromExternalSource(newsId, title, source) {
    const sources = [
        { name: "O País", baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts" },
        { name: "Jornal Notícias", baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts" },
        { name: "Canal de Moçambique", baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts" }
    ];
    
    // Priorizar fonte sugerida
    let sourceList = [...sources];
    if (source) {
        const decodedSource = decodeURIComponent(source);
        const prioritySource = sources.find(s => 
            s.name.toLowerCase().includes(decodedSource.toLowerCase())
        );
        if (prioritySource) {
            sourceList = [prioritySource, ...sources.filter(s => s !== prioritySource)];
        }
    }
    
    for (const src of sourceList) {
        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 3000);
            
            const url = `${src.baseUrl}?per_page=5&search=${encodeURIComponent(decodeURIComponent(title).substring(0, 50))}&_embed`;
            const response = await fetch(url, { signal: controller.signal });
            
            if (!response.ok) continue;
            
            const articles = await response.json();
            
            for (const article of articles) {
                const articleTitle = article.title.rendered.toLowerCase();
                const searchTitle = decodeURIComponent(title).toLowerCase();
                
                if (articleTitle.includes(searchTitle.substring(0, 40))) {
                    return {
                        id: newsId,
                        title: article.title.rendered,
                        content: article.content.rendered,
                        image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                               article.jetpack_featured_media_url ||
                               "https://via.placeholder.com/800x400",
                        source: src.name,
                        date: article.date || article.modified,
                        link: article.link,
                        category: determineCategory(article.title.rendered)
                    };
                }
            }
        } catch (error) {
            console.warn(`Erro na fonte ${src.name}:`, error);
            continue;
        }
    }
    
    return null;
}

function determineCategory(title) {
    const text = title.toLowerCase();
    if (text.includes('futebol') || text.includes('desporto') || text.includes('jogo')) return 'esportes';
    if (text.includes('economia') || text.includes('negócio') || text.includes('empresa')) return 'economia';
    if (text.includes('política') || text.includes('governo') || text.includes('presidente')) return 'política';
    if (text.includes('saúde') || text.includes('hospital') || text.includes('médico')) return 'saúde';
    if (text.includes('tecnologia') || text.includes('digital') || text.includes('internet')) return 'tecnologia';
    if (text.includes('cultura') || text.includes('arte') || text.includes('música')) return 'cultura';
    return 'sociedade';
}

// ========== RENDERIZAÇÃO ==========
function renderNews(article) {
    const category = article.category || determineCategory(article.title);
    
    document.title = `${article.title.substring(0, 60)}${article.title.length > 60 ? '...' : ''} | Notícias CLD`;
    
    const categoryClass = category ? `${category.replace('ç', 'c').replace('á', 'a')}-tag` : 'sociedade-tag';
    const categoryName = {
        'sociedade': 'Sociedade',
        'política': 'Política',
        'economia': 'Economia',
        'esportes': 'Esportes',
        'cultura': 'Cultura',
        'saúde': 'Saúde',
        'tecnologia': 'Tecnologia'
    }[category] || 'Sociedade';
    
    const newsHTML = `
        <div class="news-header">
            <h1 class="news-title">${article.title}</h1>
            <div class="news-meta">
                <span class="source-tag">${article.source}</span>
                <span class="category-tag ${categoryClass}">${categoryName}</span>
                <span><i class="far fa-calendar"></i> ${formatDate(article.date)}</span>
            </div>
        </div>
        
        <img src="${article.image}" class="news-image" alt="${article.title}" 
             loading="lazy"
             onerror="this.onerror=null; this.src='https://via.placeholder.com/800x400/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
        
        <div class="news-body">${article.content}</div>
        
        <div class="share-section">
            <h3 class="share-title"><i class="fas fa-share-alt"></i> Partilhar esta notícia</h3>
            <div class="share-buttons">
                <button class="share-btn facebook" onclick="shareOnFacebook()">
                    <i class="fab fa-facebook-f"></i> Facebook
                </button>
                <button class="share-btn twitter" onclick="shareOnTwitter()">
                    <i class="fab fa-twitter"></i> Twitter
                </button>
                <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-btn link" onclick="copyLink()">
                    <i class="fas fa-link"></i> Copiar Link
                </button>
            </div>
        </div>
        
        <div class="related-news-section">
            <h3 class="related-news-title"><i class="fas fa-newspaper"></i> Mais Notícias</h3>
            <div class="related-news-container" id="related-news-container">
                <p style="text-align:center;color:#666;">Carregando notícias relacionadas...</p>
            </div>
        </div>
        
        <div class="quick-actions" style="margin-top:30px;">
            <a href="/" class="action-btn">
                <i class="fas fa-home"></i> Página Inicial
            </a>
            <button class="action-btn" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Recarregar
            </button>
            <button class="action-btn" onclick="window.print()">
                <i class="fas fa-print"></i> Imprimir
            </button>
        </div>
    `;
    
    document.getElementById('loader').style.display = 'none';
    document.getElementById('news-container').innerHTML = newsHTML;
    document.getElementById('news-container').style.display = 'block';
    
    // Carregar notícias relacionadas
    loadRelatedNews(category, article.id);
}

async function loadRelatedNews(category, excludeId) {
    setTimeout(async () => {
        try {
            const related = [];
            const cachedNews = Array.from(newsCache.cache.values());
            
            for (const article of cachedNews) {
                if (article.id === excludeId) continue;
                if (article.category === category) {
                    related.push(article);
                    if (related.length >= 3) break;
                }
            }
            
            if (related.length > 0) {
                const container = document.getElementById('related-news-container');
                container.innerHTML = related.map(art => `
                    <a href="leitura.html?n=${art.id}&t=${encodeURIComponent(art.title.substring(0,50))}&s=${encodeURIComponent(art.source)}" 
                       class="related-news-card">
                        <img src="${art.image}" alt="${art.title}" loading="lazy"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/300x150/1a73e8/ffffff?text=${encodeURIComponent(art.source.substring(0,2))}'">
                        <h3>${art.title.substring(0, 80)}${art.title.length > 80 ? '...' : ''}</h3>
                        <div class="related-news-meta">
                            <span class="source-tag">${art.source}</span>
                            <span>${formatDate(art.date)}</span>
                        </div>
                    </a>
                `).join('');
            }
        } catch (e) {
            console.warn('Erro ao carregar notícias relacionadas:', e);
        }
    }, 100);
}

function showError() {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('error-message').style.display = 'block';
}

// ========== CARREGAMENTO PRINCIPAL ==========
async function loadNews() {
    const params = getUrlParams();
    
    if (!params.n && !params.t) {
        showError();
        return;
    }
    
    // 1. Tentar buscar no cache
    let article = newsCache.findNews(params.n, params.t, params.s);
    
    if (article) {
        console.log('Notícia encontrada no cache');
        renderNews(article);
        return;
    }
    
    // 2. Se não encontrou no cache, buscar em fontes externas
    if (params.t) {
        console.log('Buscando em fontes externas...');
        article = await fetchFromExternalSource(params.n, params.t, params.s);
        
        if (article) {
            console.log('Notícia encontrada em fonte externa');
            // Salvar no cache para próximas acessos
            newsCache.cache.set(article.id, article);
            
            try {
                const cached = localStorage.getItem('news_cache_v2');
                const data = cached ? JSON.parse(cached) : [];
                data.push(article);
                localStorage.setItem('news_cache_v2', JSON.stringify(data));
            } catch (e) {
                console.warn('Erro ao salvar no cache:', e);
            }
            
            renderNews(article);
            return;
        }
    }
    
    // 3. Se não encontrou em nenhum lugar
    showError();
}

// ========== INICIALIZAÇÃO ==========
document.addEventListener('DOMContentLoaded', () => {
    // Verificar se há parâmetros
    const params = getUrlParams();
    if (!params.n && !params.t) {
        window.location.href = '/';
        return;
    }
    
    loadNews();
    
    // Prevenir erros de imagens
    window.addEventListener('error', function(e) {
        if (e.target.tagName === 'IMG') {
            e.target.src = 'https://via.placeholder.com/300x150/1a73e8/ffffff?text=IMG';
        }
    }, true);
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || (e.key === 'ArrowLeft' && e.altKey)) {
        goBack();
    }
    if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        location.reload();
    }
    if (e.key === 'Home') {
        window.location.href = '/';
    }
});

// Salvar histórico de acesso
window.addEventListener('load', () => {
    const params = getUrlParams();
    if (params.n || params.t) {
        try {
            const history = JSON.parse(localStorage.getItem('reading_history') || '[]');
            const entry = {
                id: params.n,
                title: params.t ? decodeURIComponent(params.t) : 'Notícia',
                date: new Date().toISOString(),
                url: window.location.href
            };
            
            // Evitar duplicados
            if (!history.some(item => item.id === entry.id)) {
                history.unshift(entry);
                if (history.length > 50) history.pop();
                localStorage.setItem('reading_history', JSON.stringify(history));
            }
        } catch (e) {
            console.warn('Erro ao salvar histórico:', e);
        }
    }
});
</script>
</body>
</html>