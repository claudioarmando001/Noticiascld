<!doctype html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ler Notícia - Notícias CLD</title>
    
    <style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    :root {
        --primary-color: #1a73e8;
        --primary-dark: #0d47a1;
        --secondary-color: #4285f4;
        --accent-color: #34a853;
        --text-primary: #202124;
        --text-secondary: #5f6368;
        --text-tertiary: #9aa0a6;
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-tertiary: #f1f3f4;
        --border-color: #dadce0;
        --card-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        --card-hover-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
    }

    body {
        font-family: 'Google Sans', 'Roboto', 'Segoe UI', sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
    }

    /* HEADER */
    .article-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 24px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }

    .back-btn {
        background: none;
        border: none;
        font-size: 18px;
        color: var(--primary-color);
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .back-btn:hover {
        background: var(--bg-secondary);
    }

    .logo-text {
        font-size: 18px;
        font-weight: 500;
        color: var(--text-primary);
        text-decoration: none;
    }

    .article-actions {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        background: var(--bg-secondary);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        color: var(--text-primary);
        transition: all 0.2s;
    }

    .action-btn:hover {
        background: var(--bg-tertiary);
        transform: scale(1.1);
    }

    .action-btn.save-btn.saved {
        background: var(--accent-color);
        color: white;
    }

    .action-btn.share-btn {
        background: var(--primary-color);
        color: white;
    }

    /* ARTICLE CONTENT */
    .article-container {
        max-width: 800px;
        margin: 80px auto 40px;
        padding: 0 24px;
    }

    /* HEADER IMAGE */
    .article-header-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 12px;
        margin-bottom: 32px;
        box-shadow: var(--card-shadow);
    }

    /* ARTICLE HEADER INFO */
    .article-header-info {
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .article-category {
        display: inline-block;
        padding: 6px 14px;
        background: var(--primary-color);
        color: white;
        border-radius: 14px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
    }

    .article-title {
        font-size: 32px;
        font-weight: 500;
        line-height: 1.3;
        color: var(--text-primary);
        margin-bottom: 16px;
    }

    .article-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        color: var(--text-secondary);
        font-size: 14px;
        flex-wrap: wrap;
    }

    .article-source {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }

    .article-date {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .article-saved-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: #e6f4ea;
        color: #137333;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    /* ARTICLE CONTENT */
    .article-content {
        font-size: 18px;
        line-height: 1.8;
        color: var(--text-primary);
    }

    .article-content p {
        margin-bottom: 24px;
    }

    .article-content h2 {
        font-size: 24px;
        font-weight: 500;
        margin: 40px 0 20px;
        color: var(--text-primary);
    }

    .article-content h3 {
        font-size: 20px;
        font-weight: 500;
        margin: 32px 0 16px;
        color: var(--text-primary);
    }

    .article-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 32px 0;
        box-shadow: var(--card-shadow);
    }

    .article-content a {
        color: var(--primary-color);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.2s;
    }

    .article-content a:hover {
        border-bottom: 1px solid var(--primary-color);
    }

    .article-content blockquote {
        border-left: 4px solid var(--primary-color);
        padding-left: 20px;
        margin: 32px 0;
        font-style: italic;
        color: var(--text-secondary);
    }

    .article-content ul, .article-content ol {
        margin: 24px 0 24px 32px;
    }

    .article-content li {
        margin-bottom: 8px;
    }
   /* RELATED NEWS */
    .related-section {
        margin-top: 64px;
        padding-top: 32px;
        border-top: 1px solid var(--border-color);
    }

    .related-title {
        font-size: 20px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .related-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }

    .related-card {
        background: var(--bg-primary);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        transition: all 0.3s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .related-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-hover-shadow);
    }

    .related-card-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .related-card-content {
        padding: 16px;
    }

    .related-card-title {
        font-size: 16px;
        font-weight: 500;
        line-height: 1.4;
        color: var(--text-primary);
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .related-card-source {
        font-size: 12px;
        color: var(--text-tertiary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* SAVED INDICATOR */
    .saved-indicator {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--accent-color);
        color: white;
        padding: 12px 24px;
        border-radius: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
        z-index: 1000;
        animation: slideInUp 0.3s ease-out;
    }

    @keyframes slideInUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* EXPIRY WARNING */
    .expiry-warning {
        background: #fbbc05;
        color: #202124;
        padding: 16px;
        border-radius: 12px;
        margin: 24px 0;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: pulseWarning 2s infinite;
    }

    @keyframes pulseWarning {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    /* SHARE MODAL */
    .share-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .share-modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        position: relative;
        animation: modalIn 0.3s ease-out;
    }

    @keyframes modalIn {
        from { opacity: 0; transform: translateY(-50px) scale(0.9); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .share-modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .share-modal-close:hover {
        background: #f8f9fa;
        color: #ea4335;
        transform: rotate(90deg);
    }

    .share-modal-title {
        font-size: 24px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 20px;
        text-align: center;
    }

    .share-url-container {
        margin-bottom: 24px;
    }

    .share-url {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        font-family: monospace;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .share-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .share-button {
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .share-button.copy {
        background: var(--primary-color);
        color: white;
    }

    .share-button.whatsapp {
        background: #25D366;
        color: white;
    }

    .share-button.facebook {
        background: #4267B2;
        color: white;
    }

    .share-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* NOTIFICATION */
    .notification {
        position: fixed;
        top: 100px;
        right: 24px;
        background: var(--primary-color);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 2000;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .notification.error {
        background: #ea4335;
    }

    .notification.success {
        background: #34a853;
    }

    .notification.warning {
        background: #fbbc05;
    }

    .notification-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 4px;
        font-size: 18px;
    }

    /* RESPONSIVIDADE */
    @media (max-width: 768px) {
        .article-header {
            padding: 0 16px;
            height: 56px;
        }
        
        .article-container {
            margin: 70px auto 30px;
            padding: 0 16px;
        }
        
        .article-header-image {
            height: 250px;
        }
        
        .article-title {
            font-size: 24px;
        }
        
        .article-content {
            font-size: 16px;
        }
        
        .article-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .related-grid {
            grid-template-columns: 1fr;
        }
        
        .share-buttons {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .article-title {
            font-size: 20px;
        }
        
        .article-header-image {
            height: 200px;
        }
        
        .action-btn .btn-text {
            display: none;
        }
        
        .saved-indicator {
            bottom: 16px;
            right: 16px;
            left: 16px;
            text-align: center;
            justify-content: center;
        }
    }

    /* DARK MODE */
    @media (prefers-color-scheme: dark) {
        :root {
            --primary-color: #8ab4f8;
            --primary-dark: #5e97f6;
            --secondary-color: #669df6;
            --accent-color: #81c995;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-tertiary: #5f6368;
            --bg-primary: #202124;
            --bg-secondary: #292a2d;
            --bg-tertiary: #3c4043;
            --border-color: #3c4043;
            --card-shadow: 0 1px 2px 0 rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
            --card-hover-shadow: 0 1px 3px 0 rgba(0,0,0,0.3), 0 4px 8px 3px rgba(0,0,0,0.15);
        }
        
        .article-saved-badge {
            background: #1e3a2a;
            color: #81c995;
        }
        
        .share-modal-content {
            background: var(--bg-primary);
        }
        
        .share-url {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
    }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- HEADER -->
    <header class="article-header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <a href="index.html" class="logo-text">Notícias CLD</a>
            <div class="article-actions">
                <button class="action-btn share-btn" onclick="shareArticle()" title="Compartilhar">
                    <i class="fas fa-share-alt"></i>
                </button>
                <button class="action-btn save-btn" id="save-btn" onclick="toggleSaveArticle()" title="Salvar notícia">
                    <i class="fas fa-save"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ARTICLE CONTENT -->
    <div class="article-container" id="article-container">
        <!-- Conteúdo será carregado aqui -->
    </div>

    <!-- SAVED INDICATOR -->
    <div class="saved-indicator" id="saved-indicator" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span>Notícia salva no sistema!</span>
    </div>

    <!-- SHARE MODAL -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <button class="share-modal-close" onclick="closeShareModal()">×</button>
            <h3 class="share-modal-title">Compartilhar Notícia</h3>
            <div class="share-url-container">
                <input type="text" class="share-url" id="share-url" readonly>
            </div>
            <div class="share-buttons">
                <button class="share-button copy" onclick="copyShareUrl()">
                    <i class="fas fa-copy"></i> Copiar Link
                </button>
                <button class="share-button whatsapp" onclick="shareViaWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-button facebook" onclick="shareViaFacebook()">
                    <i class="fab fa-facebook"></i> Facebook
                </button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div class="notification" id="notification" style="display: none;">
        <i class="fas fa-info-circle" id="notification-icon"></i>
        <span id="notification-text"></span>
        <button class="notification-close" onclick="closeNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
    // CONFIGURAÇÃO
    const SAVED_NEWS_KEY = 'cld_saved_news_shared';
    const SYSTEM_CONFIG = {
        expireMonths: 2
    };

    // VARIÁVEIS
    let currentArticle = null;
    let isSaved = false;
    let articleId = null;

    // INICIALIZAÇÃO
    document.addEventListener('DOMContentLoaded', () => {
        loadArticle();
        setupEventListeners();
    });

    // FUNÇÕES DA PÁGINA
    function goBack() {
        if (document.referrer && document.referrer.includes(window.location.origin)) {
            window.history.back();
        } else {
            window.location.href = 'index.html';
        }
    }

    function loadArticle() {
        // Obtém ID da URL
        const urlParams = new URLSearchParams(window.location.search);
        articleId = urlParams.get('id');
        const source = urlParams.get('source');
        
        if (!articleId) {
            showError('Notícia não encontrada.');
            return;
        }
        
        // Tenta carregar do sistema de notícias salvas primeiro
        if (source === 'saved') {
            loadFromSavedSystem();
        } else {
            // Tenta carregar de várias fontes
            tryLoadFromMultipleSources();
        }
    }

    function tryLoadFromMultipleSources() {
        // 1. Tenta do sistema salvo
        const savedArticle = getArticleFromSavedSystem(articleId);
        if (savedArticle) {
            displayArticle(savedArticle);
            checkIfSaved(articleId);
            return;
        }
        
        // 2. Tenta do cache local
        const cachedArticle = getArticleFromCache(articleId);
        if (cachedArticle) {
            displayArticle(cachedArticle);
            checkIfSaved(articleId);
            return;
        }
        
        // 3. Notícia não encontrada
        showError('Notícia não encontrada. Ela pode ter expirado ou sido removida.');
    }

    function getArticleFromSavedSystem(id) {
        try {
            const savedNews = JSON.parse(localStorage.getItem(SAVED_NEWS_KEY) || '[]');
            return savedNews.find(article => article.id === id);
        } catch (error) {
            console.error('Erro ao ler notícias salvas:', error);
            return null;
        }
    }

    function getArticleFromCache(id) {
        // Procura em todos os caches
        const cacheKeys = Object.keys(localStorage).filter(key => 
            key.startsWith('news_') && key.includes('cache')
        );
        
        for (const key of cacheKeys) {
            try {
                const articles = JSON.parse(localStorage.getItem(key) || '[]');
                const article = articles.find(a => 
                    a.id === id || 
                    `ext_${a.id}_${key.replace('news_', '').replace('_cache', '')}` === id
                );
                
                if (article) {
                    return formatArticleFromCache(article, key);
                }
            } catch (error) {
                continue;
            }
        }
        
        return null;
    }

    function formatArticleFromCache(article, cacheKey) {
        const source = cacheKey.replace('news_', '').replace('_cache', '');
        
        return {
            id: `ext_${article.id}_${source}`,
            title: article.title?.rendered || article.title || 'Sem título',
            content: article.content?.rendered || article.content || '',
            excerpt: article.excerpt?.rendered?.replace(/<[^>]*>/g, '').substring(0, 150) + '...' || '',
            image: article._embedded?.['wp:featuredmedia']?.[0]?.source_url || 
                   article.jetpack_featured_media_url ||
                   article.image ||
                   `https://via.placeholder.com/800x400/1a73e8/ffffff?text=${encodeURIComponent(source.substring(0, 2))}`,
            source: source,
            date: article.date || article.modified || new Date().toISOString(),
            link: article.link || '#',
            category: determineCategory(article),
            categoryName: getCategoryName(determineCategory(article)),
            original: true,
            sourceType: 'external'
        };
    }

    function loadFromSavedSystem() {
        const article = getArticleFromSavedSystem(articleId);
        
        if (article) {
            displayArticle(article);
            checkIfSaved(articleId);
            
            // Verifica se está perto de expirar
            checkExpiry(article);
        } else {
            showError('Notícia salva não encontrada. Ela pode ter expirado.');
        }
    }

    function checkExpiry(article) {
        if (!article.expiresAt) return;
        
        const expireDate = new Date(article.expiresAt);
        const now = new Date();
        const diffDays = (expireDate - now) / (1000 * 60 * 60 * 24);
        
        if (diffDays <= 7) {
            showExpiryWarning(diffDays);
        }
    }

    function showExpiryWarning(days) {
        const container = document.getElementById('article-container');
        const warning = document.createElement('div');
        warning.className = 'expiry-warning';
        warning.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>Atenção:</strong> Esta notícia expira em ${Math.ceil(days)} dias.
                Após esta data, ela será automaticamente removida do sistema.
            </div>
        `;
        container.insertBefore(warning, container.firstChild);
    }

    function determineCategory(article) {
        const text = ((article.title?.rendered || article.title || '') + ' ' + 
                     (article.content?.rendered || article.content || '')).toLowerCase();
        
        const categories = {
            'sociedade': ['sociedade', 'social', 'comunidade', 'educação', 'escola', 'universidade', 'aluno', 'professor'],
            'política': ['política', 'político', 'governo', 'presidente', 'ministro', 'eleições', 'partido', 'parlamento'],
            'economia': ['economia', 'econômico', 'negócio', 'empresa', 'investimento', 'banco', 'finanças', 'mercado'],
            'esportes': ['esporte', 'futebol', 'jogo', 'atleta', 'campeonato', 'liga', 'competição', 'seleção'],
            'cultura': ['cultura', 'cultural', 'arte', 'música', 'teatro', 'cinema', 'literatura', 'poesia'],
            'saúde': ['saúde', 'hospital', 'médico', 'enfermeiro', 'doença', 'vacina', 'tratamento', 'clínica'],
            'tecnologia': ['tecnologia', 'tecnológico', 'internet', 'digital', 'aplicativo', 'software', 'startup']
        };
        
        let maxScore = 0;
        let selectedCategory = 'sociedade';
        
        Object.entries(categories).forEach(([category, keywords]) => {
            let score = 0;
            keywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    score++;
                }
            });
            
            if (score > maxScore) {
                maxScore = score;
                selectedCategory = category;
            }
        });
        
        return selectedCategory;
    }

    function getCategoryName(category) {
        const names = {
            'sociedade': 'Sociedade',
            'política': 'Política',
            'economia': 'Economia',
            'esportes': 'Esportes',
            'cultura': 'Cultura',
            'saúde': 'Saúde',
            'tecnologia': 'Tecnologia'
        };
        
        return names[category] || 'Geral';
    }

    function displayArticle(article) {
        currentArticle = article;
        
        const container = document.getElementById('article-container');
        const date = new Date(article.date);
        const formattedDate = date.toLocaleDateString('pt-PT', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        container.innerHTML = `
            <img src="${article.image}" alt="${article.title}" class="article-header-image"
                 onerror="this.src='https://via.placeholder.com/800x400/1a73e8/ffffff?text=NOTÍCIA'">
            
            <div class="article-header-info">
                <span class="article-category">${article.categoryName || 'Geral'}</span>
                <h1 class="article-title">${article.title}</h1>
                <div class="article-meta">
                    <div class="article-source">
                        <i class="fas fa-newspaper"></i>
                        ${article.source}
                    </div>
                    <div class="article-date">
                        <i class="far fa-clock"></i>
                        ${formattedDate}
                    </div>
                    ${article.saved ? '<span class="article-saved-badge"><i class="fas fa-check"></i> SALVA NO SISTEMA</span>' : ''}
                </div>
            </div>
            
            <div class="article-content" id="article-content">
                ${formatArticleContent(article.content)}
            </div>
        `;
     // Carrega notícias relacionadas
        loadRelatedArticles(article);
    }

    function formatArticleContent(content) {
        if (!content) return '<p>Conteúdo não disponível.</p>';
        
        // Remove scripts e estilos
        let formatted = content
            .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
            .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '');
        
        // Garante que as imagens sejam responsivas
        formatted = formatted.replace(/<img/g, '<img style="max-width: 100%; height: auto;"');
        
        // Adiciona classes para estilização
        formatted = formatted
            .replace(/<p>/g, '<p class="article-paragraph">')
            .replace(/<h2>/g, '<h2 class="article-subtitle">')
            .replace(/<h3>/g, '<h3 class="article-subsubtitle">')
            .replace(/<blockquote>/g, '<blockquote class="article-quote">');
        
        return formatted;
    }

    function loadRelatedArticles(currentArticle) {
        // Esta função carrega artigos relacionados da mesma categoria
        // Implementação básica - pode ser expandida
        const container = document.getElementById('article-container');
        
        const relatedSection = document.createElement('div');
        relatedSection.className = 'related-section';
        relatedSection.innerHTML = `
            <h3 class="related-title">
                <i class="fas fa-newspaper"></i>
                Notícias Relacionadas
            </h3>
            <div class="related-grid" id="related-grid">
                <!-- Notícias relacionadas serão carregadas aqui -->
            </div>
        `;
        
        container.appendChild(relatedSection);
        
        // Carrega notícias da mesma categoria
        loadRelatedFromCache(currentArticle);
    }

    function loadRelatedFromCache(article) {
        try {
            const allNews = [];
            
            // Busca em notícias salvas
            const savedNews = JSON.parse(localStorage.getItem(SAVED_NEWS_KEY) || '[]');
            allNews.push(...savedNews);
            
            // Busca em caches
            const cacheKeys = Object.keys(localStorage).filter(key => 
                key.startsWith('news_') && key.includes('cache')
            );
            
            cacheKeys.forEach(key => {
                try {
                    const articles = JSON.parse(localStorage.getItem(key) || '[]');
                    articles.forEach(cacheArticle => {
                        const formatted = formatArticleFromCache(cacheArticle, key);
                        if (formatted.id !== article.id) {
                            allNews.push(formatted);
                        }
                    });
                } catch (error) {
                    // Ignora erros
                }
            });
            
            // Filtra por categoria e remove duplicatas
            const related = allNews
                .filter(news => 
                    news.id !== article.id && 
                    news.category === article.category
                )
                .filter((news, index, self) =>
                    index === self.findIndex(n => n.id === news.id)
                )
                .slice(0, 4); // Limita a 4 notícias
            
            displayRelatedArticles(related);
            
        } catch (error) {
            console.error('Erro ao carregar relacionadas:', error);
        }
    }

    function displayRelatedArticles(articles) {
        const grid = document.getElementById('related-grid');
        
        if (articles.length === 0) {
            grid.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Nenhuma notícia relacionada encontrada.</p>';
            return;
        }
        
        grid.innerHTML = articles.map(news => `
            <a href="leitura.html?id=${news.id}${news.saved ? '&source=saved' : ''}" class="related-card">
                <img src="${news.image}" alt="${news.title}" class="related-card-image"
                     onerror="this.src='https://via.placeholder.com/400x200/1a73e8/ffffff?text=${encodeURIComponent(news.source.substring(0, 2))}'">
                <div class="related-card-content">
                    <h4 class="related-card-title">${news.title}</h4>
                    <div class="related-card-source">
                        <i class="fas fa-newspaper"></i>
                        ${news.source}
                    </div>
                </div>
            </a>
        `).join('');
    }

    // FUNÇÕES DE SALVAMENTO
    function checkIfSaved(id) {
        const savedNews = getSavedNews();
        isSaved = savedNews.some(article => article.id === id);
        
        updateSaveButton();
    }

    function getSavedNews() {
        try {
            const savedNews = JSON.parse(localStorage.getItem(SAVED_NEWS_KEY) || '[]');
            return Array.isArray(savedNews) ? savedNews : [];
        } catch (error) {
            console.error('Erro ao ler notícias salvas:', error);
            return [];
        }
    }

    function toggleSaveArticle() {
        if (!currentArticle) return;
        
        if (isSaved) {
            removeFromSavedSystem();
        } else {
            saveToSystem();
        }
    }

    function saveToSystem() {
        if (!currentArticle) return;
        
        try {
            const savedNews = getSavedNews();
            
            // Verifica se já existe
            if (savedNews.some(article => article.id === currentArticle.id)) {
                showNotification('Esta notícia já está salva no sistema.', 'info');
                return;
            }
            
            // Prepara artigo para salvar
            const articleToSave = {
                ...currentArticle,
                savedDate: new Date().toISOString(),
                savedBy: 'user',
                expiresAt: getExpirationDate(),
                permalink: generatePermalink(currentArticle.id)
            };
            
            // Remove propriedades temporárias
            delete articleToSave.saved;
            
            savedNews.push(articleToSave);
            localStorage.setItem(SAVED_NEWS_KEY, JSON.stringify(savedNews));
            
            // Atualiza interface
            isSaved = true;
            updateSaveButton();
            showSavedIndicator();
            
            // Atualiza índice no index.html
            updateSavedNewsIndex(currentArticle);
            
            showNotification('Notícia salva no sistema com sucesso!', 'success');
            
        } catch (error) {
            console.error('Erro ao salvar notícia:', error);
            showNotification('Erro ao salvar notícia.', 'error');
        }
    }

    function removeFromSavedSystem() {
        if (!currentArticle) return;
        
        try {
            const savedNews = getSavedNews();
            const filtered = savedNews.filter(article => article.id !== currentArticle.id);
            
            localStorage.setItem(SAVED_NEWS_KEY, JSON.stringify(filtered));
            
            // Atualiza interface
            isSaved = false;
            updateSaveButton();
            
            // Remove do índice
            removeFromSavedNewsIndex(currentArticle.id);
            
            showNotification('Notícia removida do sistema.', 'info');
            
        } catch (error) {
            console.error('Erro ao remover notícia:', error);
            showNotification('Erro ao remover notícia.', 'error');
        }
    }

    function getExpirationDate() {
        const expireMonths = SYSTEM_CONFIG.expireMonths;
        const date = new Date();
        date.setMonth(date.getMonth() + expireMonths);
        return date.toISOString();
    }

    function generatePermalink(id) {
        const baseUrl = window.location.origin + window.location.pathname.replace('leitura.html', '');
        return `${baseUrl}leitura.html?id=${encodeURIComponent(id)}&source=saved`;
    }

    function updateSaveButton() {
        const saveBtn = document.getElementById('save-btn');
        if (isSaved) {
            saveBtn.classList.add('saved');
            saveBtn.title = 'Remover do sistema';
            saveBtn.innerHTML = '<i class="fas fa-trash"></i>';
        } else {
            saveBtn.classList.remove('saved');
            saveBtn.title = 'Salvar no sistema';
            saveBtn.innerHTML = '<i class="fas fa-save"></i>';
        }
    }

    function showSavedIndicator() {
        const indicator = document.getElementById('saved-indicator');
        indicator.style.display = 'flex';
        
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 3000);
    }

    function updateSavedNewsIndex(article) {
        // Esta função atualiza o índice no index.html
        try {
            const indexKey = 'cld_saved_news_index';
            const indexData = localStorage.getItem(indexKey);
            let index = new Map();
            
            if (indexData) {
                index = new Map(JSON.parse(indexData));
            }
            
            index.set(article.id, {
                title: article.title,
                savedDate: new Date().toISOString(),
                category: article.category
            });
            
            localStorage.setItem(indexKey, JSON.stringify([...index]));
            
        } catch (error) {
            console.error('Erro ao atualizar índice:', error);
        }
    }

    function removeFromSavedNewsIndex(id) {
        try {
            const indexKey = 'cld_saved_news_index';
            const indexData = localStorage.getItem(indexKey);
            
            if (indexData) {
                let index = new Map(JSON.parse(indexData));
                index.delete(id);
                localStorage.setItem(indexKey, JSON.stringify([...index]));
            }
            
        } catch (error) {
            console.error('Erro ao remover do índice:', error);
        }
    }
    // FUNÇÕES DE COMPARTILHAMENTO
    function shareArticle() {
        if (!currentArticle) return;
        
        const shareUrl = currentArticle.permalink || generatePermalink(currentArticle.id);
        document.getElementById('share-url').value = shareUrl;
        document.getElementById('share-modal').style.display = 'flex';
    }

    function closeShareModal() {
        document.getElementById('share-modal').style.display = 'none';
    }

    function copyShareUrl() {
        const urlInput = document.getElementById('share-url');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);
        
        navigator.clipboard.writeText(urlInput.value)
            .then(() => {
                showNotification('Link copiado para a área de transferência!', 'success');
                closeShareModal();
            })
            .catch(err => {
                console.error('Erro ao copiar:', err);
                showNotification('Erro ao copiar link.', 'error');
            });
    }

    function shareViaWhatsApp() {
        const url = document.getElementById('share-url').value;
        const text = encodeURIComponent(`Confira esta notícia: ${currentArticle.title}\n\n`);
        window.open(`https://wa.me/?text=${text}${encodeURIComponent(url)}`, '_blank');
    }

    function shareViaFacebook() {
        const url = document.getElementById('share-url').value;
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
    }

    // FUNÇÕES DE NOTIFICAÇÃO
    function showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        const icon = document.getElementById('notification-icon');
        const text = document.getElementById('notification-text');
        
        // Atualiza ícone conforme tipo
        const icons = {
            info: 'fas fa-info-circle',
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            warning: 'fas fa-exclamation-triangle'
        };
        
        icon.className = icons[type] || icons.info;
        text.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'flex';
        
        // Auto-fecha após 5 segundos
        setTimeout(() => {
            if (notification.style.display === 'flex') {
                closeNotification();
            }
        }, 5000);
    }

    function closeNotification() {
        document.getElementById('notification').style.display = 'none';
    }

    function showError(message) {
        const container = document.getElementById('article-container');
        container.innerHTML = `
            <div style="text-align: center; padding: 80px 20px;">
                <i class="fas fa-newspaper" style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px;"></i>
                <h2 style="color: var(--text-primary); margin-bottom: 16px;">Notícia Não Encontrada</h2>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">${message}</p>
                <button onclick="goBack()" style="
                    padding: 12px 24px;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                ">
                    <i class="fas fa-arrow-left"></i>
                    Voltar para Notícias
                </button>
            </div>
        `;
    }

    // EVENT LISTENERS
    function setupEventListeners() {
        // Fecha modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeShareModal();
                closeNotification();
            }
        });
        
        // Fecha modal clicando fora
        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.id === 'share-modal') {
                closeShareModal();
            }
        });
    }
    </script>
</body>
</html>