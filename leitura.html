<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notícias CLD - Leitura</title>
<meta name="description" content="Leia notícias completas de Moçambique">
<meta name="robots" content="index, follow">
<style>
/* [TODO O CSS ANTERIOR PERMANECE EXATAMENTE IGUAL] */
/* Não alterei nenhum estilo para manter o visual */
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header>
<button class="header-btn" id="back-btn" onclick="goBack()">← Voltar</button>
Notícias CLD
<div style="width:70px;"></div>
</header>

<div id="news-content">
<!-- CONTEÚDO DA NOTÍCIA SERÁ CARREGADO AQUI INSTANTANEAMENTE -->
</div>

<script>
// ========== CONFIGURAÇÕES ==========
const CATEGORIES = {
    'sociedade': { name: 'Sociedade', class: 'sociedade-tag' },
    'política': { name: 'Política', class: 'politica-tag' },
    'economia': { name: 'Economia', class: 'economia-tag' },
    'esportes': { name: 'Esportes', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', class: 'cultura-tag' },
    'saúde': { name: 'Saúde', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', class: 'tech-tag' }
};

// Cache em memória
const memoryCache = new Map();

// ========== FUNÇÕES UTILITÁRIAS ==========

function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        n: params.get('n'), // ID curto da notícia
        t: params.get('t'), // Título (para fallback)
        s: params.get('s')  // Fonte (para fallback)
    };
}

function formatDate(d) {
    if (!d) return '';
    try {
        const date = new Date(d);
        return date.toLocaleDateString("pt-PT", {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return d;
    }
}

function determineCategory(title) {
    const text = title.toLowerCase();
    
    if (text.includes('futebol') || text.includes('desporto') || text.includes('jogo') || text.includes('atleta')) {
        return 'esportes';
    } else if (text.includes('economia') || text.includes('negócio') || text.includes('empresa') || text.includes('investimento')) {
        return 'economia';
    } else if (text.includes('política') || text.includes('governo') || text.includes('presidente') || text.includes('ministro')) {
        return 'política';
    } else if (text.includes('saúde') || text.includes('hospital') || text.includes('médico') || text.includes('enfermeiro')) {
        return 'saúde';
    } else if (text.includes('tecnologia') || text.includes('digital') || text.includes('internet') || text.includes('aplicativo')) {
        return 'tecnologia';
    } else if (text.includes('cultura') || text.includes('arte') || text.includes('música') || text.includes('teatro')) {
        return 'cultura';
    } else {
        return 'sociedade';
    }
}

// ========== FUNÇÕES DE INTERFACE ==========

function goBack() {
    if (window.history.length > 1) {
        history.back();
    } else {
        window.location.href = '/';
    }
}

function copyLink() {
    const url = window.location.href;
    const btn = document.getElementById('copy-link-btn');
    
    navigator.clipboard.writeText(url).then(() => {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
        btn.classList.add('copied');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        // Fallback para navegadores antigos
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Link copiado!');
    });
}

function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`, '_blank', 'width=600,height=400');
}

function shareOnTwitter() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://twitter.com/intent/tweet?text=${title}&url=${url}`, '_blank', 'width=600,height=400');
}

function shareOnWhatsApp() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://wa.me/?text=${title}%20-%20${url}`, '_blank', 'width=600,height=400');
}

// ========== SISTEMA DE CACHE MULTI-NÍVEL ==========

// Buscar notícia no cache (memória → localStorage → API)
async function findNews(newsId, titleHint, sourceHint) {
    // 1. Cache em memória (instantâneo)
    if (memoryCache.has(newsId)) {
        console.log('Cache memória:', newsId);
        return memoryCache.get(newsId);
    }
    
    // 2. Cache localStorage (muito rápido)
    try {
        const cached = localStorage.getItem(`news_${newsId}`);
        if (cached) {
            const article = JSON.parse(cached);
            memoryCache.set(newsId, article);
            console.log('Cache localStorage:', newsId);
            return article;
        }
    } catch (e) {
        console.warn('Erro no cache localStorage:', e);
    }
    
    // 3. Buscar da API (fallback)
    console.log('Buscando da API:', newsId);
    return await fetchNewsFromAPI(newsId, titleHint, sourceHint);
}

// Buscar notícia nas APIs
async function fetchNewsFromAPI(newsId, titleHint, sourceHint) {
    // Lista de fontes para tentar
    const sources = [
        { name: "O País", baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts" },
        { name: "Jornal Notícias", baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts" },
        { name: "Canal de Moçambique", baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts" },
        { name: "Time de Todos", baseUrl: "https://timesdetodos.com/wp-json/wp/v2/posts" },
        { name: "Carta de Moçambique", baseUrl: "https://cartamz.com/wp-json/wp/v2/posts" },
        { name: "Club of Mozambique", baseUrl: "https://clubofmozambique.com/wp-json/wp/v2/posts" },
        { name: "Zitamar News", baseUrl: "https://www.zitamar.com/wp-json/wp/v2/posts" },
        { name: "Savana", baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts" }
    ];
    
    // Se temos hint de fonte, tentar ela primeiro
    if (sourceHint) {
        const sourceMatch = sources.find(s => 
            s.name.toLowerCase().includes(sourceHint.toLowerCase())
        );
        if (sourceMatch) {
            sources.unshift(sourceMatch);
        }
    }
    
    for (const source of sources) {
        try {
            // Buscar algumas notícias desta fonte
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);
            
            const response = await fetch(`${source.baseUrl}?_embed&per_page=10`, {
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) continue;
            
            const articles = await response.json();
            
            // Procurar por notícia com hash correspondente
            for (const article of articles) {
                const articleText = article.title.rendered + article.link;
                const articleHash = btoa(articleText).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12);
                
                if (articleHash === newsId) {
                    const newsItem = {
                        id: newsId,
                        title: article.title.rendered,
                        content: article.content.rendered,
                        image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                               article.jetpack_featured_media_url ||
                               "https://via.placeholder.com/800x400",
                        source: source.name,
                        date: article.date || article.modified,
                        link: article.link
                    };
                    
                    // Salvar no cache
                    saveToCache(newsItem);
                    return newsItem;
                }
            }
            
            // Se temos título, tentar busca por similaridade
            if (titleHint) {
                const searchTitle = decodeURIComponent(titleHint).toLowerCase();
                for (const article of articles) {
                    const articleTitle = article.title.rendered.toLowerCase();
                    if (articleTitle.includes(searchTitle.substring(0, 30))) {
                        const articleText = article.title.rendered + article.link;
                        const articleHash = btoa(articleText).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12);
                        
                        const newsItem = {
                            id: articleHash,
                            title: article.title.rendered,
                            content: article.content.rendered,
                            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                                   article.jetpack_featured_media_url ||
                                   "https://via.placeholder.com/800x400",
                            source: source.name,
                            date: article.date || article.modified,
                            link: article.link
                        };
                        
                        saveToCache(newsItem);
                        return newsItem;
                    }
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log(`Timeout na fonte ${source.name}`);
            } else {
                console.warn(`Erro na fonte ${source.name}:`, error);
            }
            continue;
        }
    }
    
    return null;
}

function saveToCache(article) {
    try {
        // Cache em memória
        memoryCache.set(article.id, article);
        
        // Cache localStorage
        localStorage.setItem(`news_${article.id}`, JSON.stringify(article));
        
        // Adicionar à lista de cache
        let cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        if (!cachedNews.includes(article.id)) {
            cachedNews.push(article.id);
            if (cachedNews.length > 200) {
                cachedNews.shift();
            }
            localStorage.setItem('cached_news', JSON.stringify(cachedNews));
        }
    } catch (e) {
        console.warn('Erro ao salvar no cache:', e);
    }
}

// ========== RENDERIZAÇÃO INSTANTÂNEA ==========

function renderNewsSkeleton() {
    return `
    <div class="news-header">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-meta"></div>
    </div>
    <div class="skeleton skeleton-image"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text short"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text short"></div>
    `;
}

function renderNews(article) {
    const category = determineCategory(article.title);
    
    // Atualizar título da página
    document.title = `${article.title.substring(0, 60)}${article.title.length > 60 ? '...' : ''} | Notícias CLD`;
    
    const newsHTML = `
        <div class="news-header">
            <h1 class="news-title">${article.title}</h1>
            <div class="news-meta">
                <span class="source-tag">${article.source}</span>
                <span class="category-tag ${CATEGORIES[category]?.class || 'sociedade-tag'}">
                    ${CATEGORIES[category]?.name || 'Sociedade'}
                </span>
                <span><i class="far fa-calendar"></i> ${formatDate(article.date)}</span>
            </div>
        </div>
        
        <img src="${article.image}" class="news-image" alt="${article.title}" 
             loading="lazy" 
             onerror="this.onerror=null; this.src='https://via.placeholder.com/800x400/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
        
        <div class="news-body">
            ${article.content}
        </div>
        
        <div class="share-section">
            <h3 class="share-title"><i class="fas fa-share-alt"></i> Partilhar esta notícia</h3>
            <div class="share-buttons">
                <button class="share-btn facebook" onclick="shareOnFacebook()">
                    <i class="fab fa-facebook-f"></i> Facebook
                </button>
                <button class="share-btn twitter" onclick="shareOnTwitter()">
                    <i class="fab fa-twitter"></i> Twitter
                </button>
                <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-btn link" id="copy-link-btn" onclick="copyLink()">
                    <i class="fas fa-link"></i> Copiar Link
                </button>
            </div>
        </div>
        
        <div class="related-news-section">
            <h3 class="related-news-title"><i class="fas fa-newspaper"></i> Mais Notícias</h3>
            <div class="related-news-container" id="related-news-container">
                <div class="no-related-news">
                    <i class="fas fa-spinner fa-spin"></i> Carregando mais notícias...
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© ${new Date().getFullYear()} Notícias CLD - Agregador de Notícias de Moçambique</p>
            <div class="footer-links">
                <a href="/"><i class="fas fa-home"></i> Página Inicial</a>
                <a href="javascript:void(0)" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Recarregar</a>
            </div>
        </div>
    `;
    
    document.getElementById('news-content').innerHTML = newsHTML;
    
    // Carregar notícias relacionadas em segundo plano
    loadRelatedNews(category, article.id);
}

function loadRelatedNews(category, excludeId) {
    setTimeout(async () => {
        try {
            // Buscar notícias da mesma categoria do cache
            let cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
            const related = [];
            
            for (let newsId of cachedNews) {
                if (newsId === excludeId) continue;
                
                const article = await findNews(newsId);
                if (article && determineCategory(article.title) === category) {
                    related.push(article);
                    if (related.length >= 3) break;
                }
            }
            
            if (related.length > 0) {
                const container = document.getElementById('related-news-container');
                container.innerHTML = related.map(article => `
                    <a href="leitura.html?n=${article.id}&t=${encodeURIComponent(article.title.substring(0,50))}&s=${encodeURIComponent(article.source)}" 
                       class="related-news-card">
                        <img src="${article.image}" alt="${article.title}" loading="lazy"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/300x150/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
                        <h3>${article.title.substring(0, 80)}${article.title.length > 80 ? '...' : ''}</h3>
                        <div class="related-news-meta">
                            <span class="source-tag">${article.source}</span>
                            <span>${formatDate(article.date)}</span>
                        </div>
                    </a>
                `).join('');
            }
        } catch (e) {
            console.warn('Erro ao carregar notícias relacionadas:', e);
        }
    }, 500);
}

function showError() {
    document.getElementById('news-content').innerHTML = `
        <div class="error-message">
            <h2><i class="fas fa-exclamation-triangle"></i> Notícia não encontrada</h2>
            <p>A notícia que você está procurando não foi encontrada ou pode ter sido removida.</p>
            <p><small>Tente recarregar a página ou voltar mais tarde.</small></p>
            <a href="/">← Voltar para a lista de notícias</a>
        </div>
    `;
}

// ========== CARREGAMENTO PRINCIPAL ==========

async function loadNews() {
    const params = getUrlParams();
    
    if (!params.n) {
        showError();
        return;
    }
    
    // Mostrar skeleton imediatamente
    document.getElementById('news-content').innerHTML = renderNewsSkeleton();
    
    // Tentar buscar notícia (cache → API)
    try {
        const article = await findNews(params.n, params.t, params.s);
        
        if (article) {
            // Renderizar instantaneamente
            renderNews(article);
        } else {
            showError();
        }
    } catch (error) {
        console.error('Erro ao carregar notícia:', error);
        showError();
    }
}

// ========== INICIALIZAÇÃO ==========

document.addEventListener('DOMContentLoaded', function() {
    // Verificar se há parâmetros na URL
    if (!window.location.search) {
        // Redirecionar para home se não há notícia
        window.location.href = '/';
        return;
    }
    
    // Carregar notícia
    loadNews();
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || (e.key === 'ArrowLeft' && e.altKey)) {
        goBack();
    }
    if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        location.reload();
    }
});

// Service Worker para cache de páginas
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw-leitura.js');
    });
}

console.log('Página de leitura otimizada carregada');
</script>
</body>
</html>