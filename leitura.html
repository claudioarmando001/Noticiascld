<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notícias CLD - Leitura</title>
<meta name="description" content="Leia notícias completas de Moçambique">
<meta name="robots" content="index, follow">
<style>
/* [Todo o CSS anterior permanece igual] */
/* Adicionar estilos para cache status */
.cache-status {
    position: fixed;
    bottom: 90px;
    right: 20px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 10px 15px;
    font-size: 12px;
    color: #666;
    z-index: 999;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: none;
}

.cache-status.online {
    border-left: 4px solid #28a745;
}

.cache-status.offline {
    border-left: 4px solid #dc3545;
}

.cache-status i {
    margin-right: 5px;
}

.news-actions {
    margin: 20px 0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 8px 16px;
    background: #e8f0fe;
    border: 1px solid #dce6f5;
    border-radius: 6px;
    color: #1a73e8;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.action-btn:hover {
    background: #1a73e8;
    color: white;
}

.action-btn.save {
    background: #e8f5e8;
    border-color: #d4edda;
    color: #28a745;
}

.action-btn.save:hover {
    background: #28a745;
    color: white;
}

.action-btn.share {
    background: #f0e8fe;
    border-color: #e6dcf5;
    color: #6f42c1;
}

.action-btn.share:hover {
    background: #6f42c1;
    color: white;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header>
<button class="header-btn" id="back-btn" onclick="goBack()">← Voltar</button>
Notícias CLD
<div style="width:70px;"></div>
</header>

<div id="news-content">
<!-- SKELETON LOADER -->
<div id="skeleton-loader">
    <div class="skeleton skeleton-title"></div>
    <div class="skeleton skeleton-meta"></div>
    <div class="skeleton skeleton-image"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text short"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text short"></div>
</div>

<div class="loader" id="loader" style="display:none;">
    <div class="spinner"></div>
    <p>Carregando notícia...</p>
</div>

<div id="error-message" class="error-message" style="display:none;">
    <h2><i class="fas fa-exclamation-triangle"></i> Notícia não encontrada</h2>
    <p>A notícia que você está procurando não foi encontrada.</p>
    <p><small>Possíveis razões:</small></p>
    <ul style="text-align: left; display: inline-block;">
        <li>A notícia pode ter sido removida</li>
        <li>O cache foi limpo</li>
        <li>Problema temporário de conexão</li>
    </ul>
    <div style="margin-top: 20px;">
        <a href="javascript:location.reload()"><i class="fas fa-sync-alt"></i> Tentar novamente</a>
        <a href="/" style="margin-left: 10px; background: #6c757d;"><i class="fas fa-home"></i> Voltar para notícias</a>
    </div>
</div>

<div id="news-container" style="display:none;">
    <!-- Conteúdo da notícia será carregado aqui -->
</div>
</div>

<!-- Cache Status -->
<div id="cache-status" class="cache-status">
    <i class="fas fa-database"></i>
    <span id="cache-status-text">Carregando...</span>
</div>

<script>
// ========== CONFIGURAÇÕES ==========
const CATEGORIES = {
    'sociedade': { name: 'Sociedade', class: 'sociedade-tag' },
    'política': { name: 'Política', class: 'politica-tag' },
    'economia': { name: 'Economia', class: 'economia-tag' },
    'esportes': { name: 'Esportes', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', class: 'cultura-tag' },
    'saúde': { name: 'Saúde', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', class: 'tech-tag' }
};

// Cache local
let newsCache = new Map();

// ========== FUNÇÕES UTILITÁRIAS ==========

function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        n: params.get('n'), // ID da notícia
        t: params.get('t'), // Título (para fallback)
        s: params.get('s')  // Fonte (para fallback)
    };
}

function formatDate(d) {
    if (!d) return '';
    try {
        const date = new Date(d);
        return date.toLocaleDateString("pt-PT", {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return d;
    }
}

function determineCategory(title) {
    const text = title.toLowerCase();
    
    if (text.includes('futebol') || text.includes('desporto') || text.includes('jogo') || text.includes('atleta') || text.includes('esporte')) {
        return 'esportes';
    } else if (text.includes('economia') || text.includes('negócio') || text.includes('empresa') || text.includes('investimento') || text.includes('finança')) {
        return 'economia';
    } else if (text.includes('política') || text.includes('governo') || text.includes('presidente') || text.includes('ministro') || text.includes('parlamento')) {
        return 'política';
    } else if (text.includes('saúde') || text.includes('hospital') || text.includes('médico') || text.includes('enfermeiro') || text.includes('doença')) {
        return 'saúde';
    } else if (text.includes('tecnologia') || text.includes('digital') || text.includes('internet') || text.includes('aplicativo') || text.includes('smartphone')) {
        return 'tecnologia';
    } else if (text.includes('cultura') || text.includes('arte') || text.includes('música') || text.includes('teatro') || text.includes('dança')) {
        return 'cultura';
    } else {
        return 'sociedade';
    }
}

// ========== FUNÇÕES DE CACHE ==========

// Inicializar cache
function initializeCache() {
    try {
        const cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        cachedNews.forEach(hash => {
            try {
                const cachedItem = localStorage.getItem(`news_${hash}`);
                if (cachedItem) {
                    const article = JSON.parse(cachedItem);
                    newsCache.set(hash, article);
                }
            } catch (e) {
                console.warn('Erro ao carregar do cache:', hash, e);
            }
        });
        updateCacheStatus();
        console.log('Cache inicializado:', newsCache.size, 'notícias');
    } catch (e) {
        console.error('Erro ao inicializar cache:', e);
    }
}

// Buscar notícia no cache
function findNewsInCache(newsId) {
    // Buscar no Map primeiro (mais rápido)
    if (newsCache.has(newsId)) {
        console.log('Notícia encontrada no Map cache:', newsId);
        return newsCache.get(newsId);
    }
    
    // Tentar buscar no localStorage
    try {
        const cached = localStorage.getItem(`news_${newsId}`);
        if (cached) {
            const article = JSON.parse(cached);
            newsCache.set(newsId, article); // Adicionar ao Map para próximas buscas
            console.log('Notícia encontrada no localStorage:', newsId);
            return article;
        }
    } catch (e) {
        console.error('Erro ao buscar no localStorage:', e);
    }
    
    return null;
}

// Salvar notícia no cache
function saveToCache(article) {
    try {
        const cacheKey = `news_${article.id}`;
        localStorage.setItem(cacheKey, JSON.stringify(article));
        newsCache.set(article.id, article);
        
        // Adicionar à lista de cache
        let cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
        if (!cachedNews.includes(article.id)) {
            cachedNews.push(article.id);
            if (cachedNews.length > 300) {
                const removed = cachedNews.shift();
                localStorage.removeItem(`news_${removed}`);
                newsCache.delete(removed);
            }
            localStorage.setItem('cached_news', JSON.stringify(cachedNews));
        }
        
        updateCacheStatus();
        console.log('Notícia salva no cache:', article.id);
        return true;
    } catch (e) {
        console.error('Erro ao salvar no cache:', e);
        return false;
    }
}

// Atualizar status do cache
function updateCacheStatus() {
    const statusEl = document.getElementById('cache-status');
    const textEl = document.getElementById('cache-status-text');
    
    if (newsCache.size > 0) {
        statusEl.className = 'cache-status online';
        textEl.textContent = `${newsCache.size} notícias em cache`;
        statusEl.style.display = 'block';
    } else {
        statusEl.style.display = 'none';
    }
}

// ========== FUNÇÕES DE FALLBACK ==========

// Tentar buscar notícia de fontes alternativas
async function tryFallbackSources(newsId, titleHint, sourceHint) {
    console.log('Tentando fontes fallback...');
    
    // Lista de endpoints para tentar
    const fallbackEndpoints = [
        'https://www.opais.co.mz/wp-json/wp/v2/posts?per_page=20&_embed',
        'https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts?per_page=20&_embed',
        'https://cartamz.com/wp-json/wp/v2/posts?per_page=20&_embed',
        'https://savana.co.mz/wp-json/wp/v2/posts?per_page=20&_embed'
    ];
    
    for (const endpoint of fallbackEndpoints) {
        try {
            console.log('Tentando endpoint:', endpoint);
            const response = await fetch(endpoint, { timeout: 5000 });
            
            if (!response.ok) continue;
            
            const articles = await response.json();
            
            // Tentar encontrar por título similar
            if (titleHint) {
                const searchSlug = decodeURIComponent(titleHint).toLowerCase();
                
                for (const article of articles) {
                    const articleTitle = article.title.rendered.toLowerCase();
                    const articleSlug = articleTitle
                        .replace(/[^\w\s]/g, '')
                        .replace(/\s+/g, '-');
                    
                    // Verificar similaridade
                    if (articleSlug.includes(searchSlug) || searchSlug.includes(articleSlug)) {
                        console.log('Encontrada por título similar:', article.title.rendered);
                        return {
                            id: newsId,
                            title: article.title.rendered,
                            content: article.content.rendered,
                            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                                   article.jetpack_featured_media_url ||
                                   "https://via.placeholder.com/800x400",
                            source: sourceHint || 'Fonte Desconhecida',
                            date: article.date || new Date().toISOString(),
                            link: article.link
                        };
                    }
                }
            }
            
            // Tentar encontrar por data mais recente
            if (articles.length > 0) {
                const recentArticle = articles[0];
                console.log('Retornando artigo mais recente como fallback');
                return {
                    id: newsId,
                    title: recentArticle.title.rendered,
                    content: recentArticle.content.rendered,
                    image: recentArticle._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                           recentArticle.jetpack_featured_media_url ||
                           "https://via.placeholder.com/800x400",
                    source: sourceHint || 'Fonte Desconhecida',
                    date: recentArticle.date,
                    link: recentArticle.link
                };
            }
            
        } catch (error) {
            console.warn('Erro no endpoint fallback:', endpoint, error);
            continue;
        }
    }
    
    return null;
}

// ========== FUNÇÕES DE INTERFACE ==========

function goBack() {
    if (window.history.length > 1 && document.referrer && document.referrer.includes(window.location.hostname)) {
        history.back();
    } else {
        window.location.href = '/';
    }
}

function copyLink() {
    const url = window.location.href;
    const btn = document.getElementById('copy-link-btn');
    
    navigator.clipboard.writeText(url).then(() => {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
        btn.classList.add('copied');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('Não foi possível copiar o link');
    });
}

function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`, '_blank');
}

function shareOnTwitter() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://twitter.com/intent/tweet?text=${title}&url=${url}`, '_blank');
}

function shareOnWhatsApp() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://wa.me/?text=${title}%20-%20${url}`, '_blank');
}

function saveForOffline() {
    const article = window.currentArticle;
    if (!article) return;
    
    if (saveToCache(article)) {
        alert('Notícia salva para leitura offline!');
    } else {
        alert('Não foi possível salvar a notícia.');
    }
}

// ========== RENDERIZAÇÃO ==========

function renderNews(article) {
    // Salvar referência global
    window.currentArticle = article;
    
    const category = determineCategory(article.title);
    
    // Atualizar título da página
    document.title = `${article.title.substring(0, 60)}${article.title.length > 60 ? '...' : ''} | Notícias CLD`;
    
    // Atualizar meta description
    const metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc) {
        const cleanContent = article.content.replace(/<[^>]*>/g, '').substring(0, 160);
        metaDesc.content = cleanContent;
    }
    
    const newsHTML = `
        <div class="news-header">
            <h1 class="news-title">${article.title}</h1>
            <div class="news-meta">
                <span class="source-tag">${article.source}</span>
                <span class="category-tag ${CATEGORIES[category]?.class || 'sociedade-tag'}">
                    ${CATEGORIES[category]?.name || 'Sociedade'}
                </span>
                <span><i class="far fa-calendar"></i> ${formatDate(article.date)}</span>
            </div>
        </div>
        
        <div class="news-actions">
            <button class="action-btn save" onclick="saveForOffline()">
                <i class="fas fa-download"></i> Salvar Offline
            </button>
            <button class="action-btn" onclick="window.open('${article.link}', '_blank')">
                <i class="fas fa-external-link-alt"></i> Ver Original
            </button>
        </div>
        
        ${article.image && !article.image.includes('placeholder.com') ? 
            `<img src="${article.image}" class="news-image" alt="${article.title}" 
                 loading="lazy" 
                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x400/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">` : 
            `<img src="https://via.placeholder.com/800x400/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}" 
                 class="news-image" alt="${article.title}">`
        }
        
        <div class="news-body">
            ${article.content || '<p>Conteúdo não disponível.</p>'}
        </div>
        
        <div class="share-section">
            <h3 class="share-title"><i class="fas fa-share-alt"></i> Partilhar esta notícia</h3>
            <div class="share-buttons">
                <button class="share-btn facebook" onclick="shareOnFacebook()">
                    <i class="fab fa-facebook-f"></i> Facebook
                </button>
                <button class="share-btn twitter" onclick="shareOnTwitter()">
                    <i class="fab fa-twitter"></i> Twitter
                </button>
                <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-btn link" id="copy-link-btn" onclick="copyLink()">
                    <i class="fas fa-link"></i> Copiar Link
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>© ${new Date().getFullYear()} Notícias CLD - Agregador de Notícias de Moçambique</p>
            <div class="footer-links">
                <a href="/"><i class="fas fa-home"></i> Página Inicial</a>
                <a href="javascript:void(0)" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Recarregar</a>
                <a href="javascript:void(0)" onclick="goBack()"><i class="fas fa-arrow-left"></i> Voltar</a>
            </div>
        </div>
    `;
    
    // Atualizar a página
    document.getElementById('skeleton-loader').style.display = 'none';
    document.getElementById('news-container').innerHTML = newsHTML;
    document.getElementById('news-container').style.display = 'block';
    
    // Adicionar notícia ao cache
    saveToCache(article);
    
    // Adicionar analytics
    trackNewsView(article.id);
}

// Mostrar erro
function showError() {
    document.getElementById('skeleton-loader').style.display = 'none';
    document.getElementById('loader').style.display = 'none';
    document.getElementById('error-message').style.display = 'block';
}

// Mostrar loader
function showLoader() {
    document.getElementById('skeleton-loader').style.display = 'none';
    document.getElementById('loader').style.display = 'block';
}

// Rastrear visualização
function trackNewsView(newsId) {
    try {
        let viewedNews = JSON.parse(localStorage.getItem('viewed_news') || '[]');
        if (!viewedNews.includes(newsId)) {
            viewedNews.push(newsId);
            if (viewedNews.length > 100) {
                viewedNews.shift();
            }
            localStorage.setItem('viewed_news', JSON.stringify(viewedNews));
        }
    } catch (e) {
        console.warn('Não foi possível rastrear visualização:', e);
    }
}

// ========== CARREGAMENTO PRINCIPAL ==========

async function loadNews() {
    const params = getUrlParams();
    console.log('Parâmetros:', params);
    
    if (!params.n) {
        console.error('ID da notícia não fornecido');
        showError();
        return;
    }
    
    // 1. Tentar encontrar no cache local
    let article = findNewsInCache(params.n);
    
    if (article) {
        console.log('Notícia encontrada no cache');
        renderNews(article);
        return;
    }
    
    // 2. Mostrar loader
    showLoader();
    
    // 3. Tentar fallback
    try {
        console.log('Tentando fallback...');
        article = await tryFallbackSources(params.n, params.t, params.s);
        
        if (article) {
            console.log('Notícia encontrada via fallback');
            renderNews(article);
        } else {
            console.error('Notícia não encontrada em nenhuma fonte');
            showError();
        }
    } catch (error) {
        console.error('Erro no fallback:', error);
        showError();
    }
}

// ========== INICIALIZAÇÃO ==========

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar cache
    initializeCache();
    
    // Verificar se há uma notícia no hash da URL
    const hash = window.location.hash.substring(1);
    if (hash && hash.startsWith('n=')) {
        const newsId = hash.replace('n=', '');
        window.location.search = `?n=${newsId}`;
        return;
    }
    
    // Verificar se estamos offline
    if (!navigator.onLine) {
        document.getElementById('cache-status').className = 'cache-status offline';
        document.getElementById('cache-status-text').textContent = 'Modo offline';
        document.getElementById('cache-status').style.display = 'block';
    }
    
    // Carregar notícia
    setTimeout(() => {
        loadNews();
    }, 100);
});

// Detectar mudanças de conexão
window.addEventListener('online', () => {
    document.getElementById('cache-status').className = 'cache-status online';
    document.getElementById('cache-status-text').textContent = `${newsCache.size} notícias em cache`;
});

window.addEventListener('offline', () => {
    document.getElementById('cache-status').className = 'cache-status offline';
    document.getElementById('cache-status-text').textContent = 'Modo offline';
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || (e.key === 'ArrowLeft' && e.altKey)) {
        goBack();
    }
    if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        location.reload();
    }
    if (e.key === 's' && e.ctrlKey) {
        e.preventDefault();
        saveForOffline();
    }
});

// Prevenir erros de imagens
window.addEventListener('error', function(e) {
    if (e.target.tagName === 'IMG') {
        e.target.src = 'https://via.placeholder.com/300x150/1a73e8/ffffff?text=IMG';
    }
}, true);

console.log('Página de leitura carregada');
</script>
</body>
</html>