<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notícias CLD - Leitura</title>
<meta name="description" content="Leia notícias completas de Moçambique">
<meta name="robots" content="index, follow">
<style>
/* [CSS anterior permanece igual] */
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header>
<button class="header-btn" id="back-btn" onclick="goBack()">← Voltar</button>
Notícias CLD
<div style="width:70px;"></div>
</header>

<div id="news-content">
<!-- SKELETON LOADER -->
<div id="skeleton-loader">
    <div class="skeleton skeleton-title"></div>
    <div class="skeleton skeleton-meta"></div>
    <div class="skeleton skeleton-image"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text short"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text short"></div>
</div>

<div class="loader" id="loader" style="display:none;">
    <div class="spinner"></div>
    <p>Carregando notícia...</p>
</div>

<div id="error-message" class="error-message" style="display:none;">
    <h2><i class="fas fa-exclamation-triangle"></i> Notícia não encontrada</h2>
    <p>A notícia que você está procurando não foi encontrada ou pode ter sido removida.</p>
    <div id="fallback-options" style="margin-top:20px;display:none;">
        <p><strong>Tentativas de recuperação:</strong></p>
        <button id="try-cache-btn" class="share-btn" style="background:#1a73e8;margin:5px;">
            <i class="fas fa-database"></i> Tentar cache local
        </button>
        <button id="try-search-btn" class="share-btn" style="background:#28a745;margin:5px;">
            <i class="fas fa-search"></i> Buscar por título
        </button>
    </div>
    <a href="/" style="display:inline-block;margin-top:20px;padding:10px 20px;background:#1a73e8;color:white;text-decoration:none;border-radius:8px;font-weight:bold;">
        ← Voltar para a lista de notícias
    </a>
</div>

<div id="news-container" style="display:none;">
    <!-- Conteúdo da notícia será carregado aqui -->
</div>
</div>

<script>
// ========== CONFIGURAÇÕES ==========
const CATEGORIES = {
    'sociedade': { name: 'Sociedade', class: 'sociedade-tag' },
    'política': { name: 'Política', class: 'politica-tag' },
    'economia': { name: 'Economia', class: 'economia-tag' },
    'esportes': { name: 'Esportes', class: 'esportes-tag' },
    'cultura': { name: 'Cultura', class: 'cultura-tag' },
    'saúde': { name: 'Saúde', class: 'saude-tag' },
    'tecnologia': { name: 'Tecnologia', class: 'tech-tag' }
};

// Fontes de API para fallback
const NEWS_SOURCES = [
    { name: "O País", baseUrl: "https://www.opais.co.mz/wp-json/wp/v2/posts" },
    { name: "Jornal Notícias", baseUrl: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts" },
    { name: "Canal de Moçambique", baseUrl: "https://canal.co.mz/wp-json/wp/v2/posts" },
    { name: "Time de Todos", baseUrl: "https://timesdetodos.com/wp-json/wp/v2/posts" },
    { name: "Carta de Moçambique", baseUrl: "https://cartamz.com/wp-json/wp/v2/posts" },
    { name: "Savana", baseUrl: "https://savana.co.mz/wp-json/wp/v2/posts" },
    { name: "Integrity", baseUrl: "https://integritymagazine.co.mz/wp-json/wp/v2/posts" }
];

// ========== FUNÇÕES UTILITÁRIAS ==========

function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        n: params.get('n'), // ID curto da notícia
        t: params.get('t'), // Título (para fallback)
        s: params.get('s'), // Fonte (para fallback)
        original: params.get('original') // Link original direto
    };
}

// Função de hash consistente com o primeiro arquivo
function generateConsistentHash(link, title) {
    if (!link) return null;
    const hashString = (link || '') + (title || '');
    let hash = 0;
    for (let i = 0; i < hashString.length; i++) {
        const char = hashString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return Math.abs(hash).toString(36).substring(0, 12);
}

function formatDate(d) {
    if (!d) return '';
    try {
        const date = new Date(d);
        return date.toLocaleDateString("pt-PT", {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return d;
    }
}

function determineCategory(title, content) {
    const text = ((title || '') + ' ' + (content || '')).toLowerCase();
    
    if (text.includes('futebol') || text.includes('desporto') || text.includes('jogo') || text.includes('atleta')) {
        return 'esportes';
    } else if (text.includes('economia') || text.includes('negócio') || text.includes('empresa') || text.includes('investimento')) {
        return 'economia';
    } else if (text.includes('política') || text.includes('governo') || text.includes('presidente') || text.includes('ministro')) {
        return 'política';
    } else if (text.includes('saúde') || text.includes('hospital') || text.includes('médico') || text.includes('enfermeiro')) {
        return 'saúde';
    } else if (text.includes('tecnologia') || text.includes('digital') || text.includes('internet') || text.includes('aplicativo')) {
        return 'tecnologia';
    } else if (text.includes('cultura') || text.includes('arte') || text.includes('música') || text.includes('teatro')) {
        return 'cultura';
    } else {
        return 'sociedade';
    }
}

// ========== FUNÇÕES DE INTERFACE ==========

function goBack() {
    if (window.history.length > 1 && document.referrer && document.referrer.includes(window.location.hostname)) {
        history.back();
    } else {
        window.location.href = '/';
    }
}

// [Funções de compartilhamento permanecem iguais]

// ========== BUSCA DE NOTÍCIAS - MELHORADA ==========

// Buscar notícia no cache local - MELHORADO
function findNewsInCache(newsId) {
    try {
        // 1. Buscar diretamente pelo hash
        const cached = localStorage.getItem(`news_${newsId}`);
        if (cached) {
            return JSON.parse(cached);
        }
        
        // 2. Buscar em todas as notícias do cache
        const allCached = JSON.parse(localStorage.getItem('cached_news') || '[]');
        
        // Tentar encontrar por similaridade de hash (caso o hash tenha sido truncado)
        for (const hash of allCached) {
            if (hash.includes(newsId) || newsId.includes(hash)) {
                const item = localStorage.getItem(`news_${hash}`);
                if (item) {
                    return JSON.parse(item);
                }
            }
        }
        
        // 3. Buscar por título se fornecido na URL
        const params = getUrlParams();
        if (params.t) {
            const searchTitle = decodeURIComponent(params.t).toLowerCase();
            for (const hash of allCached) {
                const item = localStorage.getItem(`news_${hash}`);
                if (item) {
                    const newsItem = JSON.parse(item);
                    if (newsItem.title && newsItem.title.toLowerCase().includes(searchTitle)) {
                        return newsItem;
                    }
                }
            }
        }
    } catch (e) {
        console.error('Erro ao buscar no cache:', e);
    }
    
    return null;
}

// Buscar notícia nas APIs (fallback) - MELHORADO
async function fetchNewsFromAPI(newsId, titleHint, sourceHint) {
    console.log(`Buscando notícia: ID=${newsId}, Título=${titleHint}, Fonte=${sourceHint}`);
    
    // Se temos o título, tentar buscar diretamente por similaridade
    let sourcesToTry = NEWS_SOURCES;
    
    if (sourceHint) {
        // Tentar encontrar fonte correspondente
        const sourceMatch = NEWS_SOURCES.find(s => 
            s.name.toLowerCase().includes(sourceHint.toLowerCase()) ||
            sourceHint.toLowerCase().includes(s.name.toLowerCase())
        );
        if (sourceMatch) {
            sourcesToTry = [sourceMatch, ...NEWS_SOURCES.filter(s => s !== sourceMatch)];
        }
    }
    
    for (const source of sourcesToTry) {
        try {
            console.log(`Tentando fonte: ${source.name}`);
            
            // Tentar buscar algumas notícias desta fonte
            const response = await fetchWithTimeout(
                `${source.baseUrl}?_embed&per_page=20&page=1&t=${Date.now()}`, 
                5000
            );
            
            if (!response.ok) {
                console.warn(`Fonte ${source.name} não respondeu:`, response.status);
                continue;
            }
            
            const articles = await response.json();
            
            // Procurar por notícia com hash correspondente
            for (const article of articles) {
                if (!article || !article.link) continue;
                
                // Gerar hash da mesma forma que no primeiro arquivo
                const articleHash = generateConsistentHash(article.link, article.title?.rendered);
                
                if (articleHash === newsId) {
                    console.log(`Notícia encontrada por hash em ${source.name}`);
                    return {
                        id: newsId,
                        title: article.title?.rendered || article.title || '',
                        content: article.content?.rendered || article.content || '',
                        image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                               article.jetpack_featured_media_url ||
                               article.featured_media_url ||
                               "https://via.placeholder.com/300x200",
                        source: source.name,
                        date: article.date || article.modified || new Date().toISOString(),
                        link: article.link || article.guid?.rendered || ''
                    };
                }
            }
            
            // Se temos título, tentar buscar por título similar
            if (titleHint) {
                const searchTitle = decodeURIComponent(titleHint).toLowerCase().replace(/-/g, ' ');
                console.log(`Buscando por título: "${searchTitle}"`);
                
                for (const article of articles) {
                    if (!article || !article.title) continue;
                    
                    const articleTitle = article.title.rendered || article.title || '';
                    
                    if (articleTitle.toLowerCase().includes(searchTitle) || 
                        searchTitle.includes(articleTitle.toLowerCase().substring(0, 30))) {
                        
                        const articleHash = generateConsistentHash(article.link, articleTitle);
                        console.log(`Notícia encontrada por título em ${source.name}`);
                        
                        return {
                            id: articleHash,
                            title: articleTitle,
                            content: article.content?.rendered || article.content || '',
                            image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                                   article.jetpack_featured_media_url ||
                                   article.featured_media_url ||
                                   "https://via.placeholder.com/300x200",
                            source: source.name,
                            date: article.date || article.modified || new Date().toISOString(),
                            link: article.link || article.guid?.rendered || ''
                        };
                    }
                }
            }
        } catch (error) {
            console.warn(`Erro ao buscar de ${source.name}:`, error);
            continue;
        }
    }
    
    return null;
}

// Buscar notícia em múltiplas páginas da API
async function searchNewsInAllPages(source, searchTitle) {
    if (!searchTitle) return null;
    
    try {
        // Buscar nas primeiras 3 páginas
        for (let page = 1; page <= 3; page++) {
            const response = await fetchWithTimeout(
                `${source.baseUrl}?_embed&per_page=20&page=${page}`, 
                4000
            );
            
            if (!response.ok) break;
            
            const articles = await response.json();
            if (articles.length === 0) break;
            
            for (const article of articles) {
                const articleTitle = article.title?.rendered || article.title || '';
                if (articleTitle.toLowerCase().includes(searchTitle)) {
                    const articleHash = generateConsistentHash(article.link, articleTitle);
                    return {
                        id: articleHash,
                        title: articleTitle,
                        content: article.content?.rendered || article.content || '',
                        image: article._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                               article.jetpack_featured_media_url ||
                               article.featured_media_url ||
                               "https://via.placeholder.com/300x200",
                        source: source.name,
                        date: article.date || article.modified || new Date().toISOString(),
                        link: article.link || article.guid?.rendered || ''
                    };
                }
            }
        }
    } catch (error) {
        console.warn(`Erro na busca profunda em ${source.name}:`, error);
    }
    
    return null;
}

function fetchWithTimeout(url, timeout = 5000) {
    return Promise.race([
        fetch(url),
        new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Timeout')), timeout)
        )
    ]);
}

// ========== RENDERIZAÇÃO - MELHORADA ==========

function renderNews(article) {
    if (!article) {
        showError();
        return;
    }
    
    const category = determineCategory(article.title, article.content);
    
    // Atualizar título da página
    document.title = `${article.title.substring(0, 60)}${article.title.length > 60 ? '...' : ''} | Notícias CLD`;
    
    // Atualizar meta description
    const metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc && article.content) {
        const cleanContent = article.content.replace(/<[^>]*>/g, '').substring(0, 160);
        metaDesc.content = cleanContent;
    }
    
    // Limpar e preparar conteúdo HTML
    let cleanContent = article.content || '';
    // Remover elementos problemáticos mas manter formatação básica
    cleanContent = cleanContent
        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
        .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
        .replace(/onclick="[^"]*"/gi, '')
        .replace(/onload="[^"]*"/gi, '')
        .replace(/onerror="[^"]*"/gi, '');
    
    const newsHTML = `
        <div class="news-header">
            <h1 class="news-title">${article.title}</h1>
            <div class="news-meta">
                <span class="source-tag">${article.source}</span>
                <span class="category-tag ${CATEGORIES[category]?.class || 'sociedade-tag'}">
                    ${CATEGORIES[category]?.name || 'Sociedade'}
                </span>
                <span><i class="far fa-calendar"></i> ${formatDate(article.date)}</span>
            </div>
        </div>
        
        ${article.image && !article.image.includes('placeholder.com') ? 
            `<img src="${article.image}" class="news-image" alt="${article.title}" 
                 loading="lazy" 
                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x400/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">` : 
            `<img src="https://via.placeholder.com/800x400/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}" 
                 class="news-image" alt="${article.title}">`
        }
        
        <div class="news-body">
            ${cleanContent || '<p style="text-align:center;color:#666;font-style:italic;">Conteúdo não disponível.</p>'}
        </div>
        
        <div class="share-section">
            <h3 class="share-title"><i class="fas fa-share-alt"></i> Partilhar esta notícia</h3>
            <div class="share-buttons">
                <button class="share-btn facebook" onclick="shareOnFacebook()">
                    <i class="fab fa-facebook-f"></i> Facebook
                </button>
                <button class="share-btn twitter" onclick="shareOnTwitter()">
                    <i class="fab fa-twitter"></i> Twitter
                </button>
                <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-btn link" id="copy-link-btn" onclick="copyLink()">
                    <i class="fas fa-link"></i> Copiar Link
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>© ${new Date().getFullYear()} Notícias CLD - Agregador de Notícias de Moçambique</p>
            <div class="footer-links">
                <a href="/"><i class="fas fa-home"></i> Página Inicial</a>
                <a href="javascript:void(0)" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Recarregar</a>
            </div>
        </div>
    `;
    
    // Atualizar a página
    document.getElementById('skeleton-loader').style.display = 'none';
    document.getElementById('news-container').innerHTML = newsHTML;
    document.getElementById('news-container').style.display = 'block';
    
    // Salvar no cache para acesso futuro
    saveToCache(article);
}

function saveToCache(article) {
    try {
        if (!article.id) {
            article.id = generateConsistentHash(article.link, article.title);
        }
        
        if (article.id) {
            localStorage.setItem(`news_${article.id}`, JSON.stringify(article));
            
            // Adicionar à lista de cache
            let cachedNews = JSON.parse(localStorage.getItem('cached_news') || '[]');
            if (!cachedNews.includes(article.id)) {
                cachedNews.push(article.id);
                if (cachedNews.length > 200) {
                    cachedNews.shift();
                }
                localStorage.setItem('cached_news', JSON.stringify(cachedNews));
            }
        }
    } catch (e) {
        console.warn('Não foi possível salvar no cache:', e);
    }
}

// Mostrar erro com opções de fallback
function showError() {
    document.getElementById('skeleton-loader').style.display = 'none';
    document.getElementById('loader').style.display = 'none';
    document.getElementById('error-message').style.display = 'block';
    
    const params = getUrlParams();
    if (params.t || params.s) {
        document.getElementById('fallback-options').style.display = 'block';
        
        document.getElementById('try-cache-btn').onclick = async () => {
            await tryCacheFallback();
        };
        
        document.getElementById('try-search-btn').onclick = async () => {
            await trySearchFallback();
        };
    }
}

// Mostrar loader
function showLoader() {
    document.getElementById('skeleton-loader').style.display = 'none';
    document.getElementById('loader').style.display = 'block';
}

// ========== FALLBACKS MELHORADOS ==========

async function tryCacheFallback() {
    const params = getUrlParams();
    showLoader();
    
    // Buscar em todo o cache por similaridade
    try {
        const allCached = JSON.parse(localStorage.getItem('cached_news') || '[]');
        let foundArticle = null;
        
        if (params.t) {
            const searchTitle = decodeURIComponent(params.t).toLowerCase();
            for (const hash of allCached) {
                const item = localStorage.getItem(`news_${hash}`);
                if (item) {
                    const newsItem = JSON.parse(item);
                    if (newsItem.title && newsItem.title.toLowerCase().includes(searchTitle)) {
                        foundArticle = newsItem;
                        break;
                    }
                }
            }
        }
        
        if (foundArticle) {
            renderNews(foundArticle);
        } else {
            document.getElementById('loader').style.display = 'none';
            alert('Não foi encontrada no cache local.');
        }
    } catch (e) {
        console.error('Erro no fallback do cache:', e);
        document.getElementById('loader').style.display = 'none';
    }
}

async function trySearchFallback() {
    const params = getUrlParams();
    showLoader();
    
    try {
        const title = decodeURIComponent(params.t || '');
        const source = decodeURIComponent(params.s || '');
        
        let foundArticle = null;
        
        // Tentar buscar em todas as fontes
        for (const newsSource of NEWS_SOURCES) {
            foundArticle = await searchNewsInAllPages(newsSource, title.toLowerCase());
            if (foundArticle) break;
        }
        
        if (foundArticle) {
            renderNews(foundArticle);
        } else {
            document.getElementById('loader').style.display = 'none';
            alert('Não foi possível encontrar a notícia nas fontes disponíveis.');
        }
    } catch (e) {
        console.error('Erro no fallback de busca:', e);
        document.getElementById('loader').style.display = 'none';
    }
}

// ========== CARREGAMENTO PRINCIPAL ==========

async function loadNews() {
    const params = getUrlParams();
    console.log('Parâmetros da URL:', params);
    
    if (!params.n && !params.t && !params.original) {
        console.error('Nenhum identificador de notícia fornecido');
        showError();
        return;
    }
    
    // 1. Se tiver link original direto, tentar carregar diretamente
    if (params.original) {
        try {
            const response = await fetchWithTimeout(decodeURIComponent(params.original), 5000);
            if (response.ok) {
                // Implementar parsing específico se necessário
                console.log('Carregamento direto do link original');
            }
        } catch (e) {
            console.warn('Erro ao carregar link original:', e);
        }
    }
    
    // 2. Tentar encontrar no cache local
    if (params.n) {
        let article = findNewsInCache(params.n);
        
        if (article) {
            console.log('Notícia encontrada no cache:', article.title);
            renderNews(article);
            return;
        }
    }
    
    // 3. Mostrar loader enquanto busca na API
    showLoader();
    
    // 4. Buscar na API
    try {
        console.log('Buscando notícia na API...');
        const article = await fetchNewsFromAPI(params.n, params.t, params.s);
        
        if (article) {
            console.log('Notícia encontrada na API:', article.title);
            renderNews(article);
        } else {
            console.error('Notícia não encontrada na API');
            showError();
        }
    } catch (error) {
        console.error('Erro ao buscar notícia:', error);
        showError();
    }
}

// ========== INICIALIZAÇÃO ==========

document.addEventListener('DOMContentLoaded', function() {
    // Verificar se há uma notícia no hash da URL
    const hash = window.location.hash.substring(1);
    if (hash && hash.startsWith('n=')) {
        const newsId = hash.replace('n=', '');
        window.location.search = `?n=${newsId}`;
        return;
    }
    
    // Carregar normalmente
    loadNews();
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        goBack();
    }
    if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        location.reload();
    }
    if (e.key === 'ArrowLeft' && e.altKey) {
        goBack();
    }
});

// Prevenir erros de imagens
window.addEventListener('error', function(e) {
    if (e.target.tagName === 'IMG') {
        e.target.src = 'https://via.placeholder.com/300x150/1a73e8/ffffff?text=IMG';
    }
}, true);

console.log('Página de leitura carregada');
</script>
</body>
</html>