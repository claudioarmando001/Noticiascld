<!doctype html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Notícias CLD - Leitura</title>
    <meta name="description" content="Leia notícias completas de Moçambique">
    <meta name="robots" content="index, follow">
    
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #0d62d9;
            --text-color: #111;
            --text-secondary: #666;
            --bg-color: #f2f3f5;
            --card-bg: #ffffff;
            --border-color: #e8e8e8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* HEADER FIXO */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .back-btn {
            background: white;
            color: var(--primary-color);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .back-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .home-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .home-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* CONTEÚDO PRINCIPAL */
        .main-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 80px 20px 40px;
        }

        /* ARTIGO */
        .article-card {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .article-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: linear-gradient(45deg, #f2f3f5, #e8e8e8);
        }

        .article-header {
            padding: 30px;
        }

        .article-title {
            font-size: 28px;
            font-weight: 800;
            line-height: 1.3;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .article-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .source-badge {
            background: #e8f0fe;
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .category-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .sociedade { background: rgba(76, 175, 80, 0.1); color: #2e7d32; }
        .política { background: rgba(244, 67, 54, 0.1); color: #c62828; }
        .economia { background: rgba(255, 152, 0, 0.1); color: #ef6c00; }
        .esportes { background: rgba(33, 150, 243, 0.1); color: #1565c0; }
        .cultura { background: rgba(156, 39, 176, 0.1); color: #7b1fa2; }
        .saúde { background: rgba(0, 150, 136, 0.1); color: #00796b; }
        .tecnologia { background: rgba(96, 125, 139, 0.1); color: #37474f; }

        .article-date {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .article-body {
            padding: 0 30px 30px;
        }

        .article-content {
            font-size: 17px;
            line-height: 1.8;
            color: #333;
        }

        .article-content p {
            margin-bottom: 20px;
        }

        .article-content img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 20px 0;
        }

        .article-content iframe {
            max-width: 100%;
            border-radius: 12px;
            margin: 20px 0;
        }

        /* COMPARTILHAMENTO */
        .share-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
        }

        .share-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .share-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .share-btn {
            padding: 12px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .share-btn.facebook { background: #1877f2; color: white; }
        .share-btn.twitter { background: #1da1f2; color: white; }
        .share-btn.whatsapp { background: #25d366; color: white; }
        .share-btn.link { background: #6c757d; color: white; }
        .share-btn.copied { background: #28a745; }

        /* LINK PERMANENTE */
        .permalink-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border-color);
            margin: 20px 0;
        }

        .permalink-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .permalink-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: #f8f9fa;
            margin-bottom: 10px;
        }

        /* NOTÍCIAS RELACIONADAS */
        .related-section {
            margin-top: 40px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .related-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-decoration: none;
            color: inherit;
            display: block;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
        }

        .related-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .related-title {
            font-size: 16px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .related-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* LOADING STATE */
        .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .loading-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            max-width: 500px;
            width: 100%;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e8e8e8;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* ERROR STATE */
        .error-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .error-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            max-width: 500px;
            width: 100%;
        }

        .error-icon {
            font-size: 50px;
            color: #ff4444;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .error-message {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* BOTÃO VOLTAR AO TOPO */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
            transition: all 0.3s;
            z-index: 999;
        }

        .back-to-top:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .main-content {
                padding: 70px 15px 30px;
            }

            .article-header {
                padding: 20px;
            }

            .article-title {
                font-size: 24px;
            }

            .article-body {
                padding: 0 20px 20px;
            }

            .article-image {
                height: 200px;
            }

            .article-meta {
                gap: 8px;
            }

            .share-buttons {
                grid-template-columns: 1fr;
            }

            .related-grid {
                grid-template-columns: 1fr;
            }

            .header-title {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .article-title {
                font-size: 22px;
            }

            .article-content {
                font-size: 16px;
            }

            .main-header {
                padding: 12px;
            }

            .back-btn,
            .home-btn {
                width: 36px;
                height: 36px;
            }
        }

        /* ANIMAÇÕES */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* PROGRESS BAR */
        .reading-progress {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(26, 115, 232, 0.1);
            z-index: 999;
        }

        .reading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PRELOAD CRITICAL RESOURCES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- PROGRESS BAR -->
    <div class="reading-progress" id="readingProgress">
        <div class="reading-progress-bar" id="progressBar"></div>
    </div>

    <!-- HEADER -->
    <header class="main-header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()" aria-label="Voltar">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-title" id="headerTitle">Notícias CLD</div>
            <button class="home-btn" onclick="goHome()" aria-label="Página inicial">
                <i class="fas fa-home"></i>
            </button>
        </div>
    </header>

    <!-- LOADING STATE -->
    <div class="loading-container" id="loadingContainer">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <p class="loading-text">Carregando notícia...</p>
        </div>
    </div>

    <!-- ERROR STATE -->
    <div class="error-container" id="errorContainer" style="display: none;">
        <div class="error-card">
            <div class="error-icon">⚠️</div>
            <h2 class="error-title" id="errorTitle">Erro ao carregar</h2>
            <p class="error-message" id="errorMessage">Não foi possível carregar a notícia solicitada.</p>
            <button onclick="goHome()" style="background: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-home"></i> Voltar para o início
            </button>
        </div>
    </div>

    <!-- ARTICLE CONTENT -->
    <main class="main-content" id="mainContent" style="display: none;">
        <article class="article-card fade-in" id="articleCard">
            <!-- Conteúdo será carregado aqui -->
        </article>

        <!-- RELATED NEWS -->
        <section class="related-section" id="relatedSection" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-newspaper"></i> Notícias Relacionadas
            </h2>
            <div class="related-grid" id="relatedGrid">
                <!-- Notícias relacionadas serão carregadas aqui -->
            </div>
        </section>
    </main>

    <!-- BACK TO TOP -->
    <button class="back-to-top" onclick="scrollToTop()" aria-label="Voltar ao topo">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
        // SISTEMA DE CACHE ULTRA-RÁPIDO
        class UltraFastCache {
            constructor() {
                this.NEWS_CACHE = 'ultra_news_cache';
                this.ARTICLE_CACHE = 'ultra_article_cache';
                this.CACHE_DURATION = 60 * 60 * 1000; // 1 hora
            }

            // Cache de artigos individuais
            cacheArticle(articleId, data) {
                const cache = this.getArticleCache();
                cache[articleId] = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(this.ARTICLE_CACHE, JSON.stringify(cache));
            }

            getArticle(articleId) {
                const cache = this.getArticleCache();
                const cached = cache[articleId];
                
                if (cached && Date.now() - cached.timestamp < this.CACHE_DURATION) {
                    return cached.data;
                }
                
                // Remove do cache se expirado
                delete cache[articleId];
                localStorage.setItem(this.ARTICLE_CACHE, JSON.stringify(cache));
                return null;
            }

            getArticleCache() {
                try {
                    return JSON.parse(localStorage.getItem(this.ARTICLE_CACHE)) || {};
                } catch {
                    return {};
                }
            }

            // Cache de notícias
            cacheNews(data) {
                localStorage.setItem(this.NEWS_CACHE, JSON.stringify({
                    data: data,
                    timestamp: Date.now()
                }));
            }

            getNews() {
                try {
                    const cached = JSON.parse(localStorage.getItem(this.NEWS_CACHE));
                    if (cached && Date.now() - cached.timestamp < this.CACHE_DURATION) {
                        return cached.data;
                    }
                } catch {}
                return null;
            }
        }

        // VARIÁVEIS GLOBAIS
        const fastCache = new UltraFastCache();
        let currentArticle = null;
        let allNews = [];

        // ELEMENTOS DOM
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const mainContent = document.getElementById('mainContent');
        const articleCard = document.getElementById('articleCard');
        const relatedSection = document.getElementById('relatedSection');
        const relatedGrid = document.getElementById('relatedGrid');
        const headerTitle = document.getElementById('headerTitle');
        const progressBar = document.getElementById('progressBar');

        // FUNÇÕES DE NAVEGAÇÃO
        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // DETECTAR SCROLL PARA PROGRESS BAR
        window.addEventListener('scroll', () => {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            progressBar.style.width = scrolled + '%';
            
            // Mostrar/ocultar botão voltar ao topo
            const backToTopBtn = document.querySelector('.back-to-top');
            backToTopBtn.style.display = winScroll > 300 ? 'flex' : 'none';
        });

        // OBTER ID DA NOTÍCIA DA URL
        function getArticleId() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            
            // Também tenta da hash se não encontrar nos parâmetros
            if (!id && window.location.hash) {
                return window.location.hash.substring(1);
            }
            
            return id;
        }

        // GERAR ID DE NOTÍCIA (COMPATÍVEL COM INDEX.HTML)
        function generateArticleId(title, source, date) {
            const shortTitle = title.substring(0, 30);
            const sourceAbbr = source.substring(0, 3).toLowerCase().replace(/\s/g, '');
            const dateStr = new Date(date).getTime().toString(36);
            const slug = generateSlug(shortTitle);
            return `${sourceAbbr}-${slug}-${dateStr}`;
        }

        function generateSlug(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 40);
        }

        // CARREGAMENTO ULTRA-RÁPIDO
        async function loadArticle() {
            const articleId = getArticleId();
            
            if (!articleId) {
                showError('Notícia não especificada', 'A URL não contém um ID de notícia válido.');
                return;
            }
            
            try {
                // 1. Tenta carregar do cache local primeiro (mais rápido)
                const cachedArticle = fastCache.getArticle(articleId);
                if (cachedArticle) {
                    renderArticle(cachedArticle);
                    loadRelatedNews(cachedArticle);
                    updateURLWithSlug(cachedArticle);
                    return;
                }
                
                // 2. Tenta carregar do cache de notícias
                allNews = fastCache.getNews() || [];
                let article = allNews.find(n => n.id === articleId);
                
                if (article) {
                    fastCache.cacheArticle(articleId, article);
                    renderArticle(article);
                    loadRelatedNews(article);
                    updateURLWithSlug(article);
                    return;
                }
                
                // 3. Busca em fontes específicas (prioridade: fontes mais rápidas)
                article = await searchInPrioritySources(articleId);
                
                if (article) {
                    fastCache.cacheArticle(articleId, article);
                    renderArticle(article);
                    loadRelatedNews(article);
                    updateURLWithSlug(article);
                    
                    // Atualiza cache de notícias
                    if (allNews.length < 50) { // Limita cache para não ficar muito grande
                        allNews.unshift(article);
                        fastCache.cacheNews(allNews);
                    }
                    
                    return;
                }
                
                // 4. Busca completa em todas as fontes (último recurso)
                article = await searchInAllSources(articleId);
                
                if (article) {
                    fastCache.cacheArticle(articleId, article);
                    renderArticle(article);
                    loadRelatedNews(article);
                    updateURLWithSlug(article);
                    return;
                }
                
                // Se não encontrou em nenhum lugar
                showError('Notícia não encontrada', 'A notícia solicitada não está mais disponível.');
                
            } catch (error) {
                console.error('Erro ao carregar artigo:', error);
                showError('Erro de conexão', 'Não foi possível carregar a notícia. Verifique sua conexão.');
            }
        }

        // BUSCA EM FONTES PRIORITÁRIAS (MAIS RÁPIDAS)
        async function searchInPrioritySources(articleId) {
            const prioritySources = [
                {
                    name: "O País",
                    url: "https://www.opais.co.mz/wp-json/wp/v2/posts",
                    idPrefix: "opa"
                },
                {
                    name: "Jornal Notícias",
                    url: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts",
                    idPrefix: "jor"
                },
                {
                    name: "Canal de Moçambique",
                    url: "https://canal.co.mz/wp-json/wp/v2/posts",
                    idPrefix: "can"
                }
            ];
            
            // Tenta cada fonte prioritária
            for (const source of prioritySources) {
                if (articleId.startsWith(source.idPrefix)) {
                    try {
                        const article = await fetchFromSource(source.url, articleId, source.name);
                        if (article) return article;
                    } catch {
                        continue;
                    }
                }
            }
            
            return null;
        }

        // BUSCA EM TODAS AS FONTES
        async function searchInAllSources(articleId) {
            const allSources = [
                { name: "O País", url: "https://www.opais.co.mz/wp-json/wp/v2/posts" },
                { name: "Jornal Notícias", url: "https://www.jornalnoticias.co.mz/wp-json/wp/v2/posts" },
                { name: "Canal de Moçambique", url: "https://canal.co.mz/wp-json/wp/v2/posts" },
                { name: "Carta de Moçambique", url: "https://cartamz.com/wp-json/wp/v2/posts" },
                { name: "Time de Todos", url: "https://timesdetodos.com/wp-json/wp/v2/posts" },
                { name: "Integrity", url: "https://integritymagazine.co.mz/wp-json/wp/v2/posts" },
                { name: "Savana", url: "https://savana.co.mz/wp-json/wp/v2/posts" },
                { name: "JornalMZ", url: "https://jornalmz.com/wp-json/wp/v2/posts" },
                { name: "Checka", url: "https://checka.co.mz/wp-json/wp/v2/posts" },
                { name: "Stop", url: "https://www.stop.co.mz/wp-json/wp/v2/posts" },
                { name: "Club of Mozambique", url: "https://clubofmozambique.com/wp-json/wp/v2/posts" },
                { name: "Zitamar News", url: "https://www.zitamar.com/wp-json/wp/v2/posts" }
            ];
            
            // Tenta buscar em paralelo com limite de concorrência
            const concurrencyLimit = 3;
            const batches = [];
            
            for (let i = 0; i < allSources.length; i += concurrencyLimit) {
                const batch = allSources.slice(i, i + concurrencyLimit);
                const promises = batch.map(source => 
                    fetchFromSource(source.url, articleId, source.name).catch(() => null)
                );
                
                const results = await Promise.all(promises);
                const foundArticle = results.find(article => article !== null);
                
                if (foundArticle) {
                    return foundArticle;
                }
            }
            
            return null;
        }

        // FETCH DE UMA FONTE ESPECÍFICA
        async function fetchFromSource(sourceUrl, articleId, sourceName) {
            try {
                // Primeiro tenta buscar post específico (se tivermos mais informações)
                if (articleId.includes('-')) {
                    const parts = articleId.split('-');
                    const slug = parts[1];
                    
                    // Tenta buscar por slug
                    const slugResponse = await fetch(`${sourceUrl}?slug=${slug}&_embed`, {
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    if (slugResponse.ok) {
                        const data = await slugResponse.json();
                        if (data.length > 0) {
                            return formatArticle(data[0], sourceName);
                        }
                    }
                }
                
                // Se não encontrou por slug, busca os posts recentes
                const response = await fetch(`${sourceUrl}?per_page=20&_embed`, {
                    signal: AbortSignal.timeout(8000)
                });
                
                if (!response.ok) return null;
                
                const data = await response.json();
                
                // Procura o artigo pelo ID
                for (const post of data) {
                    const postId = generateArticleId(
                        post.title.rendered,
                        sourceName,
                        post.date || post.modified
                    );
                    
                    if (postId === articleId) {
                        return formatArticle(post, sourceName);
                    }
                }
                
                return null;
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.warn(`Erro na fonte ${sourceName}:`, error);
                }
                return null;
            }
        }

        // FORMATAR ARTIGO
        function formatArticle(post, sourceName) {
            const content = post.content.rendered || '';
            const excerpt = post.excerpt?.rendered || '';
            
            return {
                id: generateArticleId(post.title.rendered, sourceName, post.date || post.modified),
                title: post.title.rendered,
                content: content,
                excerpt: stripHTML(excerpt).substring(0, 200),
                image: post._embedded?.["wp:featuredmedia"]?.[0]?.source_url || 
                       post.jetpack_featured_media_url ||
                       "https://via.placeholder.com/800x400/1a73e8/ffffff?text=" + encodeURIComponent(sourceName.substring(0, 2)),
                source: sourceName,
                date: post.date || post.modified,
                link: post.link || '',
                category: determineCategory(post.title.rendered, content)
            };
        }

        function stripHTML(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        // DETERMINAR CATEGORIA RÁPIDA
        function determineCategory(title, content) {
            const text = (title + ' ' + (content || '')).toLowerCase();
            
            if (text.includes('política') || text.includes('governo') || text.includes('eleição')) return 'política';
            if (text.includes('economia') || text.includes('negócio') || text.includes('empresa')) return 'economia';
            if (text.includes('esporte') || text.includes('futebol') || text.includes('jogo')) return 'esportes';
            if (text.includes('saúde') || text.includes('hospital') || text.includes('médico')) return 'saúde';
            if (text.includes('tecnologia') || text.includes('digital') || text.includes('internet')) return 'tecnologia';
            if (text.includes('cultura') || text.includes('arte') || text.includes('música')) return 'cultura';
            return 'sociedade';
        }

        // RENDERIZAR ARTIGO
        function renderArticle(article) {
            currentArticle = article;
            
            // Esconde loading, mostra conteúdo
            loadingContainer.style.display = 'none';
            mainContent.style.display = 'block';
            
            // Atualiza título da página
            document.title = `${article.title.substring(0, 60)}${article.title.length > 60 ? '...' : ''} - Notícias CLD`;
            headerTitle.textContent = article.source;
            
            // Formata data
            const articleDate = new Date(article.date);
            const formattedDate = formatDate(articleDate);
            
            // Cria conteúdo do artigo
            articleCard.innerHTML = `
                ${article.image ? `
                    <img src="${article.image}" 
                         class="article-image" 
                         alt="${article.title}"
                         loading="eager"
                         onerror="this.src='https://via.placeholder.com/800x400/1a73e8/ffffff?text=${encodeURIComponent(article.source.substring(0,2))}'">
                ` : ''}
                
                <div class="article-header">
                    <h1 class="article-title">${article.title}</h1>
                    
                    <div class="article-meta">
                        <span class="source-badge">${article.source}</span>
                        <span class="category-badge ${article.category}">${article.category}</span>
                        <span class="article-date">${formattedDate}</span>
                    </div>
                </div>
                
                <div class="article-body">
                    <div class="article-content">
                        ${article.content}
                    </div>
                    
                    ${article.link ? `
                        <div style="margin-top: 30px;">
                            <a href="${article.link}" 
                               target="_blank" 
                               rel="noopener"
                               style="display: inline-flex; align-items: center; gap: 8px; background: #e8f0fe; color: #1a73e8; padding: 12px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                                <i class="fas fa-external-link-alt"></i>
                                Ver notícia original
                            </a>
                        </div>
                    ` : ''}
                    
                    <div class="share-section">
                        <div class="share-title">Partilhar esta notícia</div>
                        <div class="share-buttons">
                            <button class="share-btn facebook" onclick="shareOnFacebook()">
                                <i class="fab fa-facebook-f"></i> Facebook
                            </button>
                            <button class="share-btn twitter" onclick="shareOnTwitter()">
                                <i class="fab fa-twitter"></i> Twitter
                            </button>
                            <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="share-btn link" onclick="copyArticleLink()">
                                <i class="fas fa-link"></i> Copiar Link
                            </button>
                        </div>
                    </div>
                    
                    <div class="permalink-section">
                        <span class="permalink-label">Link permanente desta notícia:</span>
                        <input type="text" 
                               class="permalink-input" 
                               value="${window.location.href}" 
                               readonly
                               id="articlePermalink">
                        <button class="share-btn link" onclick="copyArticleLink()" style="width: 100%;">
                            <i class="fas fa-copy"></i> Copiar Link para Partilhar
                        </button>
                    </div>
                </div>
            `;
            
            // Atualiza meta tags para SEO
            updateMetaTags(article);
            
            // Carrega notícias relacionadas (em background)
            setTimeout(() => {
                loadRelatedNews(article);
            }, 500);
        }

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 3600000) { // Menos de 1 hora
                const minutes = Math.floor(diff / 60000);
                return `há ${minutes} ${minutes === 1 ? 'minuto' : 'minutos'}`;
            }
            
            if (diff < 86400000) { // Menos de 24 horas
                const hours = Math.floor(diff / 3600000);
                return `há ${hours} ${hours === 1 ? 'hora' : 'horas'}`;
            }
            
            return date.toLocaleDateString('pt-PT', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        // ATUALIZAR URL COM SLUG AMIGÁVEL
        function updateURLWithSlug(article) {
            const slug = generateSlug(article.title.substring(0, 40));
            const newURL = `${window.location.origin}${window.location.pathname}?id=${article.id}&${slug}`;
            
            try {
                window.history.replaceState({}, '', newURL);
            } catch (e) {
                // Ignora erros de história do navegador
            }
        }

        // ATUALIZAR META TAGS
        function updateMetaTags(article) {
            // Meta description
            let metaDesc = document.querySelector('meta[name="description"]');
            const description = article.excerpt || stripHTML(article.content).substring(0, 160);
            
            if (!metaDesc) {
                metaDesc = document.createElement('meta');
                metaDesc.name = 'description';
                document.head.appendChild(metaDesc);
            }
            metaDesc.content = description;
            
            // Open Graph tags
            const ogTags = [
                { property: 'og:title', content: article.title },
                { property: 'og:description', content: description },
                { property: 'og:image', content: article.image },
                { property: 'og:url', content: window.location.href },
                { property: 'og:type', content: 'article' },
                { property: 'og:site_name', content: 'Notícias CLD' }
            ];
            
            ogTags.forEach(tag => {
                let meta = document.querySelector(`meta[property="${tag.property}"]`);
                if (!meta) {
                    meta = document.createElement('meta');
                    meta.setAttribute('property', tag.property);
                    document.head.appendChild(meta);
                }
                meta.content = tag.content;
            });
            
            // Twitter Card
            let twitterCard = document.querySelector('meta[name="twitter:card"]');
            if (!twitterCard) {
                twitterCard = document.createElement('meta');
                twitterCard.name = 'twitter:card';
                twitterCard.content = 'summary_large_image';
                document.head.appendChild(twitterCard);
            }
        }

        // COMPARTILHAMENTO
        function shareOnFacebook() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(currentArticle.title);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
        }

        function shareOnTwitter() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`${currentArticle.title} - Notícias CLD`);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }

        function shareOnWhatsApp() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`${currentArticle.title} - ${url}`);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function copyArticleLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.querySelector('.share-btn.link');
                if (btn) {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Link Copiado!';
                    btn.classList.add('copied');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('copied');
                    }, 2000);
                }
            });
        }

        // CARREGAR NOTÍCIAS RELACIONADAS
        async function loadRelatedNews(article) {
            if (!allNews || allNews.length === 0) {
                allNews = fastCache.getNews() || [];
            }
            
            if (allNews.length === 0) return;
            
            // Encontra notícias relacionadas
            const related = findRelatedArticles(article, allNews);
            
            if (related.length > 0) {
                relatedSection.style.display = 'block';
                renderRelatedNews(related);
            }
        }

        function findRelatedArticles(article, allNews) {
            return allNews
                .filter(n => n.id !== article.id)
                .map(n => {
                    let score = 0;
                    
                    // Pontua por categoria
                    if (n.category === article.category) score += 3;
                    
                    // Pontua por palavras em comum no título
                    const articleWords = article.title.toLowerCase().split(' ');
                    const newsWords = n.title.toLowerCase().split(' ');
                    
                    articleWords.forEach(word => {
                        if (word.length > 3 && newsWords.includes(word)) score += 2;
                    });
                    
                    // Pontua por mesma fonte
                    if (n.source === article.source) score += 1;
                    
                    return { ...n, score };
                })
                .filter(n => n.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
        }

        function renderRelatedNews(articles) {
            let html = '';
            
            articles.forEach(article => {
                const truncatedTitle = article.title.length > 70 
                    ? article.title.substring(0, 70) + '...' 
                    : article.title;
                
                html += `
                    <a href="leitura.html?id=${article.id}" class="related-card">
                        <h3 class="related-title">${truncatedTitle}</h3>
                        <div class="related-meta">
                            <span class="source-badge" style="font-size: 11px;">${article.source}</span>
                            <span class="category-badge ${article.category}" style="font-size: 11px;">
                                ${article.category}
                            </span>
                        </div>
                    </a>
                `;
            });
            
            relatedGrid.innerHTML = html;
        }

        // MOSTRAR ERRO
        function showError(title, message) {
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'flex';
            
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
        }

        // INICIALIZAÇÃO RÁPIDA
        document.addEventListener('DOMContentLoaded', () => {
            // Carrega imediatamente
            loadArticle();
            
            // Configura service worker para cache
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw-news.js').catch(console.warn);
            }
            
            // Previne comportamento padrão de formulários
            document.addEventListener('submit', e => e.preventDefault());
        });

        // OFFLINE SUPPORT
        window.addEventListener('online', () => {
            // Recarrega se estava offline
            if (currentArticle && navigator.onLine) {
                loadArticle();
            }
        });

        // COMPATIBILIDADE COM LINKS ANTIGOS
        const hash = window.location.hash.substring(1);
        if (hash && !getArticleId()) {
            // Tenta extrair ID da hash
            const match = hash.match(/([a-z]{3}-[a-z0-9-]+-[a-z0-9]+)/i);
            if (match) {
                window.location.href = `leitura.html?id=${match[1]}`;
            }
        }

        // EXPORT FUNCTIONS FOR GLOBAL USE
        window.openArticle = function(articleId) {
            window.location.href = `leitura.html?id=${articleId}`;
        };
    </script>
</body>
</html>